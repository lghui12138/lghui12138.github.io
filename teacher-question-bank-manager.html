<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>题库管理系统 - 教师端</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            min-height: 800px;
        }

        .sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 2px solid #e9ecef;
            padding: 30px;
        }

        .sidebar h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .bank-list {
            list-style: none;
        }

        .bank-item {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            margin-bottom: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .bank-item:hover {
            border-color: #4facfe;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.2);
        }

        .bank-item.active {
            border-color: #4facfe;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        }

        .bank-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .bank-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
            display: flex;
            align-items: center;
        }

        .priority-badge {
            color: #ff9800;
            margin-right: 5px;
            font-size: 1.2em;
        }

        .recommended-badge {
            color: #f44336;
            margin-right: 5px;
            font-size: 1.2em;
        }

        .difficulty-badge {
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .bank-info {
            color: #666;
            font-size: 0.85em;
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .bank-info span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .bank-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .bank-item:hover .bank-actions {
            opacity: 1;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 6px;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }

        .content-area {
            flex: 1;
            padding: 30px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .toolbar h2 {
            color: white;
            font-size: 1.8em;
            margin: 0;
        }

        .toolbar-left .subtitle {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 5px;
            display: block;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .sort-controls, .filter-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .sort-controls label, .filter-controls label {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }

        .sort-controls select, .filter-controls select {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            background: white;
            color: #333;
            font-size: 14px;
            cursor: pointer;
        }

        .sort-controls select:focus, .filter-controls select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn-large {
            padding: 12px 25px;
            font-size: 1em;
            border-radius: 25px;
        }

        .question-list {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .question-item {
            border-bottom: 1px solid #e9ecef;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .question-item:hover {
            background: #f8f9fa;
        }

        .question-item:last-child {
            border-bottom: none;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .question-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            flex: 1;
            margin-right: 20px;
            line-height: 1.5;
        }

        .question-meta {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .meta-tag {
            background: #e9ecef;
            color: #495057;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
        }

        .question-actions {
            display: flex;
            gap: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h3 {
            color: #333;
            font-size: 1.8em;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2em;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #f8f9fa;
            color: #666;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 15px rgba(79, 172, 254, 0.2);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }

        .options-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }

        .option-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .option-label {
            width: 30px;
            height: 30px;
            background: #4facfe;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .option-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stats-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stats-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 1.2em;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 4em;
            margin-bottom: 20px;
            color: #dee2e6;
        }

        .search-bar {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 1em;
        }

        .search-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            font-size: 1.2em;
            cursor: pointer;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            transform: translateX(400px);
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .notification.warning {
            background: linear-gradient(135deg, #ffd93d 0%, #ff9f43 100%);
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .btn-group {
                flex-wrap: wrap;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📚 题库管理系统</h1>
            <p>流体力学学习平台 - 教师管理端</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="search-bar">
                    <input type="text" id="bankSearch" class="search-input" placeholder="搜索题库...">
                    <button class="search-btn" onclick="searchBanks()">🔍</button>
                </div>
                
                <h3>📋 题库列表</h3>
                <ul class="bank-list" id="bankList">
                    <li class="loading">加载中...</li>
                </ul>
                
                <button class="btn btn-success btn-large" style="width: 100%; margin-top: 20px;" onclick="createNewBank()">
                    ➕ 创建新题库
                </button>
            </div>

            <div class="content-area">
                <!-- 工具栏 -->
                <div class="toolbar">
                    <div class="toolbar-left">
                        <h2>📚 题库管理系统</h2>
                        <span class="subtitle">管理所有题库和题目</span>
                    </div>
                    <div class="toolbar-right">
                        <!-- 排序控制 -->
                        <div class="sort-controls">
                            <label for="sortBy">排序方式：</label>
                            <select id="sortBy" onchange="sortQuestionBanks()">
                                <option value="priority">优先级</option>
                                <option value="questionCount">题目数量</option>
                                <option value="lastUpdated">更新时间</option>
                                <option value="difficulty">难度</option>
                                <option value="name">名称</option>
                                <option value="category">分类</option>
                            </select>
                            <select id="sortOrder" onchange="sortQuestionBanks()">
                                <option value="asc">升序</option>
                                <option value="desc">降序</option>
                            </select>
                        </div>
                        
                        <!-- 筛选控制 -->
                        <div class="filter-controls">
                            <label for="filterCategory">分类筛选：</label>
                            <select id="filterCategory" onchange="filterQuestionBanks()">
                                <option value="">全部分类</option>
                                <option value="易错题">易错题</option>
                                <option value="真题">真题</option>
                                <option value="基础理论">基础理论</option>
                                <option value="基础概念">基础概念</option>
                                <option value="高级理论">高级理论</option>
                                <option value="专题应用">专题应用</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-primary" onclick="createNewBank()">
                            <i class="fas fa-plus"></i> 新建题库
                        </button>
                        <button class="btn btn-success" onclick="refreshData()">
                            <i class="fas fa-sync"></i> 刷新数据
                        </button>
                    </div>
                </div>

                <!-- 总体统计 -->
                <div class="stats-cards" id="overallStats" style="display: grid;">
                    <div class="stats-card">
                        <div class="stats-number" id="totalBanks">0</div>
                        <div class="stats-label">题库总数</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number" id="totalQuestionsAll">0</div>
                        <div class="stats-label">题目总数</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number" id="easyBanks">0</div>
                        <div class="stats-label">简单题库</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number" id="hardBanks">0</div>
                        <div class="stats-label">困难题库</div>
                    </div>
                </div>
                
                <!-- 单个题库统计 -->
                <div class="stats-cards" id="bankStats" style="display: none;">
                    <div class="stats-card">
                        <div class="stats-number" id="totalQuestions">0</div>
                        <div class="stats-label">总题目数</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number" id="easyQuestions">0</div>
                        <div class="stats-label">简单题目</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number" id="mediumQuestions">0</div>
                        <div class="stats-label">中等题目</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number" id="hardQuestions">0</div>
                        <div class="stats-label">困难题目</div>
                    </div>
                </div>

                <!-- 题库操作工具栏 -->
                <div id="bankToolbar" class="bank-toolbar" style="display: none; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 1px solid #e3e6ea;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="toolbar-left">
                            <h3 id="currentBankName" style="margin: 0; color: #333;">请选择题库</h3>
                            <span id="currentBankDesc" class="subtitle" style="color: #666; font-size: 14px;"></span>
                        </div>
                        <div class="toolbar-right" style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="addQuestion()" id="addQuestionBtn">
                                ➕ 添加题目
                            </button>
                            <button class="btn btn-info" onclick="importQuestions()" id="importBtn">
                                📤 导入题目
                            </button>
                            <button class="btn btn-warning" onclick="exportBank()" id="exportBtn">
                                📥 导出题库
                            </button>
                            <button class="btn btn-danger" onclick="deleteBank()" id="deleteBankBtn">
                                🗑️ 删除题库
                            </button>
                        </div>
                    </div>
                </div>

                <div class="question-list" id="questionList">
                    <div class="empty-state">
                        <i>📝</i>
                        <h3>选择题库开始管理</h3>
                        <p>从左侧选择一个题库，或创建新的题库来开始管理题目</p>
                        <div style="background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 8px; padding: 15px; margin-top: 20px; font-size: 0.9em;">
                            <strong>💡 使用说明：</strong><br>
                            • 选择左侧题库可查看和编辑题目<br>
                            • 支持创建、编辑、删除题库和题目<br>
                            • 修改后请下载生成的文件并替换到服务器<br>
                            • 支持JSON格式的批量导入导出
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 题库编辑模态框 -->
    <div class="modal" id="bankModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="bankModalTitle">创建题库</h3>
                <button class="close-btn" onclick="closeBankModal()">&times;</button>
            </div>
            <form onsubmit="saveBankInfo(event)">
                <div class="form-group">
                    <label class="form-label">题库名称</label>
                    <input type="text" id="bankName" class="form-input" required placeholder="输入题库名称...">
                </div>
                <div class="form-group">
                    <label class="form-label">题库描述</label>
                    <textarea id="bankDescription" class="form-input form-textarea" placeholder="输入题库描述..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">题库分类</label>
                    <select id="bankCategory" class="form-input form-select">
                        <option value="流体力学基础">流体力学基础</option>
                        <option value="流体性质">流体性质</option>
                        <option value="动量方程">动量方程</option>
                        <option value="能量方程">能量方程</option>
                        <option value="压力">压力</option>
                        <option value="势流">势流</option>
                        <option value="粘性">粘性</option>
                        <option value="边界层">边界层</option>
                        <option value="湍流">湍流</option>
                        <option value="管道流动">管道流动</option>
                        <option value="自由面">自由面</option>
                        <option value="涡度">涡度</option>
                        <option value="雷诺数">雷诺数</option>
                        <option value="实验与量纲">实验与量纲</option>
                        <option value="流线轨迹">流线轨迹</option>
                        <option value="易错题">易错题</option>
                        <option value="真题">真题</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn" style="background: #6c757d; margin-right: 10px;" onclick="closeBankModal()">取消</button>
                    <button type="submit" class="btn btn-success">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 题目编辑模态框 -->
    <div class="modal" id="questionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="questionModalTitle">添加题目</h3>
                <button class="close-btn" onclick="closeQuestionModal()">&times;</button>
            </div>
            <form onsubmit="saveQuestion(event)">
                <div class="form-group">
                    <label class="form-label">题目内容</label>
                    <textarea id="questionTitle" class="form-input form-textarea" required placeholder="输入题目内容..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">题目类型</label>
                    <select id="questionType" class="form-input form-select" onchange="updateQuestionForm()">
                        <option value="选择题">选择题</option>
                        <option value="判断题">判断题</option>
                        <option value="填空题">填空题</option>
                        <option value="解答题">解答题</option>
                        <option value="计算题">计算题</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">难度等级</label>
                    <select id="questionDifficulty" class="form-input form-select">
                        <option value="easy">简单</option>
                        <option value="medium">中等</option>
                        <option value="hard">困难</option>
                    </select>
                </div>
                
                <!-- 选择题选项 -->
                <div id="optionsSection" class="form-group">
                    <label class="form-label">选项设置</label>
                    <div class="options-container">
                        <div class="option-group">
                            <div class="option-label">A</div>
                            <input type="text" class="option-input" id="optionA" placeholder="选项A内容">
                        </div>
                        <div class="option-group">
                            <div class="option-label">B</div>
                            <input type="text" class="option-input" id="optionB" placeholder="选项B内容">
                        </div>
                        <div class="option-group">
                            <div class="option-label">C</div>
                            <input type="text" class="option-input" id="optionC" placeholder="选项C内容">
                        </div>
                        <div class="option-group">
                            <div class="option-label">D</div>
                            <input type="text" class="option-input" id="optionD" placeholder="选项D内容">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">正确答案</label>
                    <input type="text" id="questionAnswer" class="form-input" required placeholder="输入正确答案...">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        选择题填写选项字母(A/B/C/D)，判断题填写(正确/错误)，填空题和其他题型填写具体答案
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">题目解释</label>
                    <textarea id="questionExplanation" class="form-input form-textarea" placeholder="输入题目解释和解题思路..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">知识点标签</label>
                    <input type="text" id="questionTags" class="form-input" placeholder="用逗号分隔多个标签，如：流体静力学,压力,帕斯卡定律">
                </div>

                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn" style="background: #6c757d; margin-right: 10px;" onclick="closeQuestionModal()">取消</button>
                    <button type="submit" class="btn btn-success">保存题目</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../js/core/utils.js"></script>
    <script src="../modules/teacher-management.js"></script>
    <script>
        let currentBank = null;
        let currentQuestionId = null;
        let questionBanks = [];

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadQuestionBanks();
        });

        // 加载题库列表
        async function loadQuestionBanks() {
            try {
                const response = await fetch('../question-banks/index.json');
                const data = await response.json();
                questionBanks = data.questionBanks || data.banks || [];
                
                // 转换数据格式以兼容管理系统
                questionBanks = questionBanks.map(bank => ({
                    id: bank.id,
                    name: bank.name,
                    description: bank.description || '无描述',
                    category: bank.category || '未分类',
                    filename: bank.filename,
                    questionCount: bank.questionCount || 0,
                    difficulty: bank.difficulty || 'medium',
                    tags: bank.tags || [],
                    color: bank.color || '#4facfe',
                    createTime: bank.lastUpdated || new Date().toISOString(),
                    updateTime: bank.lastUpdated || new Date().toISOString(),
                    priority: bank.priority || 999,
                    recommended: bank.recommended || false
                }));
                
                // 初始排序（按优先级）
                sortQuestionBanks('priority', 'asc');
                updateOverallStats();
            } catch (error) {
                console.error('加载题库列表失败:', error);
                showNotification('加载题库列表失败', 'error');
            }
        }

        // 排序题库
        function sortQuestionBanks(sortBy = null, order = null) {
            const sortField = sortBy || document.getElementById('sortBy').value;
            const sortOrder = order || document.getElementById('sortOrder').value;
            
            questionBanks.sort((a, b) => {
                let valueA = a[sortField];
                let valueB = b[sortField];
                
                // 特殊处理不同类型的排序
                if (sortField === 'difficulty') {
                    const difficultyOrder = { 'easy': 1, 'medium': 2, 'hard': 3 };
                    valueA = difficultyOrder[valueA] || 2;
                    valueB = difficultyOrder[valueB] || 2;
                } else if (sortField === 'questionCount' || sortField === 'priority') {
                    valueA = parseInt(valueA) || 0;
                    valueB = parseInt(valueB) || 0;
                } else if (sortField === 'lastUpdated') {
                    valueA = new Date(valueA);
                    valueB = new Date(valueB);
                } else {
                    valueA = valueA.toString().toLowerCase();
                    valueB = valueB.toString().toLowerCase();
                }
                
                if (sortOrder === 'desc') {
                    return valueA > valueB ? -1 : valueA < valueB ? 1 : 0;
                } else {
                    return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
                }
            });
            
            displayBankList();
        }

        // 筛选题库
        function filterQuestionBanks() {
            const filterCategory = document.getElementById('filterCategory').value;
            displayBankList(filterCategory);
        }

        // 刷新数据
        function refreshData() {
            showNotification('正在刷新数据...', 'info');
            loadQuestionBanks();
            setTimeout(() => {
                showNotification('数据刷新完成', 'success');
            }, 1000);
        }

        // 显示题库列表
        function displayBankList(filterCategory = '') {
            const bankList = document.getElementById('bankList');
            
            // 筛选题库
            let filteredBanks = questionBanks;
            if (filterCategory) {
                filteredBanks = questionBanks.filter(bank => bank.category === filterCategory);
            }
            
            if (filteredBanks.length === 0) {
                bankList.innerHTML = '<li style="text-align: center; color: #666; padding: 20px;">暂无题库</li>';
                return;
            }

            bankList.innerHTML = filteredBanks.map(bank => {
                const priorityBadge = bank.priority <= 3 ? '<span class="priority-badge">⭐</span>' : '';
                const recommendedBadge = bank.recommended ? '<span class="recommended-badge">🔥</span>' : '';
                const difficultyColor = {
                    'easy': '#28a745',
                    'medium': '#ffc107', 
                    'hard': '#dc3545'
                }[bank.difficulty] || '#6c757d';
                
                return `
                    <li class="bank-item" onclick="selectBank('${bank.id}')">
                        <div class="bank-header">
                            <div class="bank-name">
                                ${priorityBadge}${recommendedBadge}${bank.name}
                            </div>
                            <div class="bank-meta">
                                <span class="difficulty-badge" style="background: ${difficultyColor}">
                                    ${bank.difficulty === 'easy' ? '简单' : bank.difficulty === 'medium' ? '中等' : '困难'}
                                </span>
                            </div>
                        </div>
                        <div class="bank-info">
                            <span class="question-count">📊 ${bank.questionCount || 0} 题</span>
                            <span class="category">📂 ${bank.category || '未分类'}</span>
                            <span class="update-time">🕒 ${new Date(bank.updateTime).toLocaleDateString()}</span>
                        </div>
                        <div class="bank-actions">
                            <button class="btn btn-sm" onclick="event.stopPropagation(); editBank('${bank.id}')" title="编辑题库">
                                ✏️
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteBank('${bank.id}')" title="删除题库">
                                🗑️
                            </button>
                        </div>
                    </li>
                `;
            }).join('');
        }

        // 选择题库
        async function selectBank(bankId) {
            try {
                // 移除之前的active状态
                document.querySelectorAll('.bank-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // 添加active状态到当前选中的题库
                event.target.closest('.bank-item').classList.add('active');
                
                const bank = questionBanks.find(b => b.id === bankId);
                if (!bank) {
                    showNotification('题库不存在', 'error');
                    return;
                }

                currentBank = bank;
                
                // 显示加载状态
                document.getElementById('questionList').innerHTML = '<div class="loading">正在加载题目...</div>';
                
                let questions = [];
                
                // 优先从GitHub存储加载
                if (window.GitHubStorage && window.GitHubStorage.isConnected) {
                    try {
                        console.log(`🌐 尝试从GitHub加载题库: ${bank.filename}`);
                        const githubData = await window.GitHubStorage.loadData(`question-banks/${bank.filename}`);
                        
                        if (githubData && Array.isArray(githubData)) {
                            questions = githubData;
                            console.log(`✅ 从GitHub成功加载题库: ${bank.filename}, 题目数量: ${questions.length}`);
                        } else if (githubData && githubData.questions && Array.isArray(githubData.questions)) {
                            questions = githubData.questions;
                            console.log(`✅ 从GitHub成功加载题库: ${bank.filename}, 题目数量: ${questions.length}`);
                        }
                    } catch (githubError) {
                        console.warn(`⚠️ 从GitHub加载题库失败: ${bank.filename}`, githubError.message);
                    }
                }
                
                // 如果GitHub加载失败，从本地存储加载
                if (!questions || questions.length === 0) {
                    const storageKey = `bank_${bank.filename}`;
                    const storedData = localStorage.getItem(storageKey);
                    
                    if (storedData) {
                        // 如果有本地存储的数据，使用本地数据
                        try {
                            questions = JSON.parse(storedData);
                            console.log(`📦 从本地存储加载题库: ${bank.filename}, 题目数量: ${questions.length}`);
                        } catch (error) {
                            console.error('解析本地存储数据失败:', error);
                        }
                    }
                }
                
                // 如果本地存储也没有数据，从服务器加载
                if (!questions || questions.length === 0) {
                    console.log(`🌐 从服务器加载题库: ${bank.filename}`);
                    const response = await fetch(`../question-banks/${bank.filename}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const serverData = await response.json();
                    questions = Array.isArray(serverData) ? serverData : [];
                    
                    // 保存到本地存储
                    const storageKey = `bank_${bank.filename}`;
                    localStorage.setItem(storageKey, JSON.stringify(questions));
                    console.log(`💾 题库数据已保存到本地存储: ${bank.filename}`);
                }
                
                // 确保questions是数组
                currentBank.questions = questions;
                
                // 更新界面
                document.getElementById('currentBankName').textContent = bank.name;
                document.getElementById('currentBankDesc').textContent = bank.description;
                
                // 显示题库工具栏
                document.getElementById('bankToolbar').style.display = 'block';
                
                // 隐藏总体统计，显示单个题库统计
                document.getElementById('overallStats').style.display = 'none';
                document.getElementById('bankStats').style.display = 'grid';
                
                displayQuestions(currentBank.questions);
                updateStats(currentBank.questions);
                
            } catch (error) {
                console.error('加载题库失败:', error);
                showNotification(`加载题库失败: ${error.message}`, 'error');
                
                // 恢复到初始状态
                document.getElementById('questionList').innerHTML = `
                    <div class="empty-state">
                        <i>❌</i>
                        <h3>加载失败</h3>
                        <p>无法加载题库内容，请检查文件是否存在</p>
                    </div>
                `;
            }
        }

        // 显示题目列表
        function displayQuestions(questions) {
            const questionList = document.getElementById('questionList');
            
            if (!questions || questions.length === 0) {
                questionList.innerHTML = `
                    <div class="empty-state">
                        <i>📝</i>
                        <h3>暂无题目</h3>
                        <p>点击"添加题目"开始创建第一道题目</p>
                    </div>
                `;
                return;
            }
            
            questionList.innerHTML = questions.map((question, index) => {
                const questionTitle = question.title || question.question || '未命名题目';
                const questionType = question.type || '选择题';
                const difficulty = getDifficultyText(question.difficulty);
                const category = question.category || currentBank?.category || '未分类';
                
                // 处理标签
                let tagsHtml = '';
                if (question.tags && Array.isArray(question.tags)) {
                    tagsHtml = question.tags.map(tag => `<span class="meta-tag">${tag}</span>`).join('');
                }
                
                // 显示题目预览（前100个字符）
                const preview = questionTitle.length > 100 ? questionTitle.substring(0, 100) + '...' : questionTitle;
                
                return `
                    <div class="question-item">
                        <div class="question-header">
                            <div class="question-title">${preview}</div>
                            <div class="question-actions">
                                <button class="btn" onclick="viewQuestion(${index})" title="查看完整题目">查看</button>
                                <button class="btn" onclick="editQuestion(${index})" title="编辑题目">编辑</button>
                                <button class="btn btn-danger" onclick="deleteQuestion(${index})" title="删除题目">删除</button>
                            </div>
                        </div>
                        <div class="question-meta">
                            <span class="meta-tag">${questionType}</span>
                            <span class="meta-tag">${difficulty}</span>
                            <span class="meta-tag">${category}</span>
                            ${tagsHtml}
                        </div>
                        ${question.options && question.options.length > 0 ? `
                            <div class="question-preview" style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                选项: ${question.options.slice(0, 2).join(' | ')}${question.options.length > 2 ? ' ...' : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // 获取难度文本
        function getDifficultyText(difficulty) {
            switch(difficulty) {
                case 'easy': return '简单';
                case 'medium': return '中等';
                case 'hard': return '困难';
                default: return '中等';
            }
        }

        // 更新总体统计信息
        function updateOverallStats() {
            const totalBanks = questionBanks.length;
            const totalQuestions = questionBanks.reduce((sum, bank) => sum + (bank.questionCount || 0), 0);
            const easyBanks = questionBanks.filter(bank => bank.difficulty === 'easy').length;
            const hardBanks = questionBanks.filter(bank => bank.difficulty === 'hard').length;
            
            document.getElementById('totalBanks').textContent = totalBanks;
            document.getElementById('totalQuestionsAll').textContent = totalQuestions;
            document.getElementById('easyBanks').textContent = easyBanks;
            document.getElementById('hardBanks').textContent = hardBanks;
        }
        
        // 更新单个题库统计信息
        function updateStats(questions) {
            const total = questions.length;
            const easy = questions.filter(q => q.difficulty === 'easy').length;
            const medium = questions.filter(q => q.difficulty === 'medium').length;
            const hard = questions.filter(q => q.difficulty === 'hard').length;
            
            document.getElementById('totalQuestions').textContent = total;
            document.getElementById('easyQuestions').textContent = easy;
            document.getElementById('mediumQuestions').textContent = medium;
            document.getElementById('hardQuestions').textContent = hard;
        }

        // 创建新题库
        function createNewBank() {
            currentBank = null;
            document.getElementById('bankModalTitle').textContent = '创建新题库';
            document.getElementById('bankName').value = '';
            document.getElementById('bankDescription').value = '';
            document.getElementById('bankCategory').value = '流体力学基础';
            document.getElementById('bankModal').style.display = 'block';
        }

        // 编辑题库
        function editBank(bankId) {
            const bank = questionBanks.find(b => b.id === bankId);
            if (!bank) return;
            
            currentBank = bank;
            document.getElementById('bankModalTitle').textContent = '编辑题库';
            document.getElementById('bankName').value = bank.name;
            document.getElementById('bankDescription').value = bank.description || '';
            document.getElementById('bankCategory').value = bank.category || '流体力学基础';
            document.getElementById('bankModal').style.display = 'block';
        }

        // 保存题库信息
        function saveBankInfo(event) {
            event.preventDefault();
            
            const name = document.getElementById('bankName').value.trim();
            const description = document.getElementById('bankDescription').value.trim();
            const category = document.getElementById('bankCategory').value;
            
            if (!name) {
                showNotification('请输入题库名称', 'warning');
                return;
            }

            const bankData = {
                id: currentBank ? currentBank.id : 'bank_' + Date.now(),
                name: name,
                description: description,
                category: category,
                filename: currentBank ? currentBank.filename : `${name}.json`,
                questionCount: currentBank ? currentBank.questionCount : 0,
                createTime: currentBank ? currentBank.createTime : new Date().toISOString(),
                updateTime: new Date().toISOString()
            };

            if (currentBank) {
                // 更新现有题库
                const index = questionBanks.findIndex(b => b.id === currentBank.id);
                if (index !== -1) {
                    questionBanks[index] = bankData;
                }
            } else {
                // 创建新题库
                questionBanks.push(bankData);
                // 创建空的题目文件
                saveBankQuestions(bankData, []);
            }

            // 更新index.json
            updateBankIndex();
            displayBankList();
            closeBankModal();
            
            showNotification(currentBank ? '题库更新成功' : '题库创建成功', 'success');
        }

        // 关闭题库模态框
        function closeBankModal() {
            document.getElementById('bankModal').style.display = 'none';
        }

        // 删除题库
        function deleteBank(bankId) {
            if (!confirm('确定要删除这个题库吗？此操作不可恢复！')) {
                return;
            }

            const index = questionBanks.findIndex(b => b.id === bankId);
            if (index !== -1) {
                questionBanks.splice(index, 1);
                updateBankIndex();
                displayBankList();
                
                                    // 如果删除的是当前选中的题库，清空显示
                    if (currentBank && currentBank.id === bankId) {
                        currentBank = null;
                        document.getElementById('currentBankName').textContent = '请选择题库';
                        document.getElementById('questionList').innerHTML = `
                            <div class="empty-state">
                                <i>📝</i>
                                <h3>选择题库开始管理</h3>
                                <p>从左侧选择一个题库，或创建新的题库来开始管理题目</p>
                            </div>
                        `;
                        // 显示总体统计，隐藏单个题库统计
                        document.getElementById('overallStats').style.display = 'grid';
                        document.getElementById('bankStats').style.display = 'none';
                        document.getElementById('addQuestionBtn').disabled = true;
                        document.getElementById('importBtn').disabled = true;
                        document.getElementById('exportBtn').disabled = true;
                    }
                
                showNotification('题库删除成功', 'success');
            }
        }

        // 添加题目
        function addQuestion() {
            if (!currentBank) {
                showNotification('请先选择题库', 'warning');
                return;
            }
            
            currentQuestionId = null;
            document.getElementById('questionModalTitle').textContent = '添加题目';
            clearQuestionForm();
            updateQuestionForm();
            document.getElementById('questionModal').style.display = 'block';
        }

        // 查看题目详情
        function viewQuestion(index) {
            if (!currentBank || !currentBank.questions) return;
            
            const question = currentBank.questions[index];
            
            let optionsHtml = '';
            if (question.options && question.options.length > 0) {
                optionsHtml = question.options.map((option, i) => 
                    `<div style="margin-bottom: 8px;"><strong>${String.fromCharCode(65 + i)}.</strong> ${option}</div>`
                ).join('');
            }
            
            const content = `
                <div style="max-height: 400px; overflow-y: auto;">
                    <h4 style="color: #333; margin-bottom: 15px;">题目内容</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; line-height: 1.6;">
                        ${question.title || question.question || '无题目内容'}
                    </div>
                    
                    ${optionsHtml ? `
                        <h4 style="color: #333; margin-bottom: 10px;">选项</h4>
                        <div style="background: #fff; border: 1px solid #dee2e6; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            ${optionsHtml}
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                        <div><strong>类型:</strong> ${question.type || '选择题'}</div>
                        <div><strong>难度:</strong> ${getDifficultyText(question.difficulty)}</div>
                        <div><strong>答案:</strong> ${question.answer || question.correct || '无'}</div>
                    </div>
                    
                    ${question.explanation ? `
                        <h4 style="color: #333; margin-bottom: 10px;">解释</h4>
                        <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; line-height: 1.6;">
                            ${question.explanation}
                        </div>
                    ` : ''}
                </div>
            `;
            
            showModal('题目详情', content);
        }
        
        // 编辑题目
        function editQuestion(index) {
            if (!currentBank || !currentBank.questions) {
                showNotification('请先选择题库', 'warning');
                return;
            }
            
            const question = currentBank.questions[index];
            if (!question) {
                showNotification('题目数据不存在', 'error');
                return;
            }
            
            currentQuestionId = index;
            
            try {
                document.getElementById('questionModalTitle').textContent = '编辑题目';
                document.getElementById('questionTitle').value = question.title || question.question || '';
                document.getElementById('questionType').value = question.type || '选择题';
                document.getElementById('questionDifficulty').value = question.difficulty || 'medium';
                document.getElementById('questionAnswer').value = question.answer || question.correct || '';
                document.getElementById('questionExplanation').value = question.explanation || '';
                document.getElementById('questionTags').value = question.tags ? question.tags.join(',') : '';
                
                // 填充选项
                if (question.options && Array.isArray(question.options)) {
                    document.getElementById('optionA').value = question.options[0] || '';
                    document.getElementById('optionB').value = question.options[1] || '';
                    document.getElementById('optionC').value = question.options[2] || '';
                    document.getElementById('optionD').value = question.options[3] || '';
                } else {
                    // 清空选项
                    document.getElementById('optionA').value = '';
                    document.getElementById('optionB').value = '';
                    document.getElementById('optionC').value = '';
                    document.getElementById('optionD').value = '';
                }
                
                updateQuestionForm();
                document.getElementById('questionModal').style.display = 'block';
                
                // 显示编辑成功提示
                showNotification(`正在编辑题目: ${question.title || question.question || '无标题'}`, 'info');
                
            } catch (error) {
                console.error('编辑题目时出错:', error);
                showNotification('编辑题目时出错: ' + error.message, 'error');
            }
        }

        // 更新题目表单
        function updateQuestionForm() {
            const type = document.getElementById('questionType').value;
            const optionsSection = document.getElementById('optionsSection');
            
            if (type === '选择题') {
                optionsSection.style.display = 'block';
            } else {
                optionsSection.style.display = 'none';
            }
        }

        // 清空题目表单
        function clearQuestionForm() {
            document.getElementById('questionTitle').value = '';
            document.getElementById('questionType').value = '选择题';
            document.getElementById('questionDifficulty').value = 'medium';
            document.getElementById('questionAnswer').value = '';
            document.getElementById('questionExplanation').value = '';
            document.getElementById('questionTags').value = '';
            document.getElementById('optionA').value = '';
            document.getElementById('optionB').value = '';
            document.getElementById('optionC').value = '';
            document.getElementById('optionD').value = '';
        }

        // 保存题目
        async function saveQuestion(event) {
            event.preventDefault();
            
            try {
                if (!currentBank) {
                    showNotification('请先选择题库', 'warning');
                    return;
                }

                const title = document.getElementById('questionTitle').value.trim();
                const type = document.getElementById('questionType').value;
                const difficulty = document.getElementById('questionDifficulty').value;
                const answer = document.getElementById('questionAnswer').value.trim();
                const explanation = document.getElementById('questionExplanation').value.trim();
                const tags = document.getElementById('questionTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);

                if (!title) {
                    showNotification('请填写题目内容', 'warning');
                    return;
                }

                if (!answer) {
                    showNotification('请填写正确答案', 'warning');
                    return;
                }

            const questionData = {
                id: currentQuestionId !== null ? currentBank.questions[currentQuestionId].id : 'q_' + Date.now(),
                title: title,
                question: title, // 兼容性
                type: type,
                difficulty: difficulty,
                category: currentBank.category,
                answer: answer,
                correct: answer, // 兼容性
                explanation: explanation,
                tags: tags,
                createTime: currentQuestionId !== null ? currentBank.questions[currentQuestionId].createTime : new Date().toISOString(),
                updateTime: new Date().toISOString()
            };

            // 如果是选择题，添加选项
            if (type === '选择题') {
                const options = [
                    document.getElementById('optionA').value.trim(),
                    document.getElementById('optionB').value.trim(),
                    document.getElementById('optionC').value.trim(),
                    document.getElementById('optionD').value.trim()
                ].filter(option => option);
                
                if (options.length < 2) {
                    showNotification('选择题至少需要2个选项', 'warning');
                    return;
                }
                
                questionData.options = options;
            }

            if (!currentBank.questions) {
                currentBank.questions = [];
            }

            if (currentQuestionId !== null) {
                // 更新现有题目
                currentBank.questions[currentQuestionId] = questionData;
            } else {
                // 添加新题目
                currentBank.questions.push(questionData);
            }

                // 更新题库文件
                await saveBankQuestions(currentBank, currentBank.questions);
                
                // 更新题库的题目数量
                const bankIndex = questionBanks.findIndex(b => b.id === currentBank.id);
                if (bankIndex !== -1) {
                    questionBanks[bankIndex].questionCount = currentBank.questions.length;
                    questionBanks[bankIndex].updateTime = new Date().toISOString();
                }
                
                updateBankIndex();
                displayQuestions(currentBank.questions);
                updateStats(currentBank.questions);
                displayBankList();
                closeQuestionModal();
                
                showNotification(currentQuestionId !== null ? '题目更新成功' : '题目添加成功', 'success');
                
            } catch (error) {
                console.error('保存题目时出错:', error);
                showNotification('保存题目时出错: ' + error.message, 'error');
            }
        }

        // 关闭题目模态框
        function closeQuestionModal() {
            document.getElementById('questionModal').style.display = 'none';
        }

        // 删除题目
        function deleteQuestion(index) {
            if (!currentBank || !currentBank.questions) return;
            
            if (!confirm('确定要删除这道题目吗？')) {
                return;
            }

            currentBank.questions.splice(index, 1);
            
            // 更新题库文件
            saveBankQuestions(currentBank, currentBank.questions);
            
            // 更新题库的题目数量
            const bankIndex = questionBanks.findIndex(b => b.id === currentBank.id);
            if (bankIndex !== -1) {
                questionBanks[bankIndex].questionCount = currentBank.questions.length;
                questionBanks[bankIndex].updateTime = new Date().toISOString();
            }
            
            updateBankIndex();
            displayQuestions(currentBank.questions);
            updateStats(currentBank.questions);
            displayBankList();
            
            showNotification('题目删除成功', 'success');
        }

        // 搜索题库
        function searchBanks() {
            const searchTerm = document.getElementById('bankSearch').value.toLowerCase().trim();
            const bankItems = document.querySelectorAll('.bank-item');
            
            bankItems.forEach(item => {
                const bankName = item.querySelector('.bank-name').textContent.toLowerCase();
                if (bankName.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // 导出题库
        function exportBank() {
            if (!currentBank || !currentBank.questions) {
                showNotification('没有可导出的题库', 'warning');
                return;
            }

            const data = {
                bank: currentBank,
                questions: currentBank.questions,
                exportTime: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentBank.name}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('题库导出成功', 'success');
        }

        // 导入题目
        function importQuestions() {
            if (!currentBank) {
                showNotification('请先选择题库', 'warning');
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        let questions = [];

                        if (data.questions) {
                            questions = data.questions;
                        } else if (Array.isArray(data)) {
                            questions = data;
                        } else {
                            throw new Error('无效的文件格式');
                        }

                        if (!Array.isArray(questions) || questions.length === 0) {
                            showNotification('没有找到有效的题目数据', 'warning');
                            return;
                        }

                        // 添加到当前题库
                        if (!currentBank.questions) {
                            currentBank.questions = [];
                        }

                        const importedCount = questions.length;
                        currentBank.questions.push(...questions);

                        // 更新题库文件
                        saveBankQuestions(currentBank, currentBank.questions);
                        
                        // 更新题库信息
                        const bankIndex = questionBanks.findIndex(b => b.id === currentBank.id);
                        if (bankIndex !== -1) {
                            questionBanks[bankIndex].questionCount = currentBank.questions.length;
                            questionBanks[bankIndex].updateTime = new Date().toISOString();
                        }
                        
                        updateBankIndex();
                        displayQuestions(currentBank.questions);
                        updateStats(currentBank.questions);
                        displayBankList();
                        
                        showNotification(`成功导入 ${importedCount} 道题目`, 'success');

                    } catch (error) {
                        console.error('导入失败:', error);
                        showNotification('文件格式错误，导入失败', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // 更新题库索引
        function updateBankIndex() {
            const indexData = {
                version: "1.0",
                lastUpdated: new Date().toISOString().split('T')[0],
                questionBanks: questionBanks,
                categories: [
                    { id: "basics", name: "基础概念", description: "流体力学基础概念和原理" },
                    { id: "theory", name: "基础理论", description: "流体力学基本理论和方程" },
                    { id: "advanced", name: "高级理论", description: "复杂流动和高级理论" },
                    { id: "application", name: "专题应用", description: "特定领域的应用题目" },
                    { id: "exam", name: "真题", description: "历年考试真题" }
                ],
                statistics: {
                    totalBanks: questionBanks.length,
                    totalQuestions: questionBanks.reduce((sum, bank) => sum + (bank.questionCount || 0), 0),
                    lastUpdated: new Date().toISOString().split('T')[0]
                }
            };
            
            // 由于是静态网站，提供下载更新后的索引文件
            downloadFile(JSON.stringify(indexData, null, 2), 'index.json', 'application/json');
            showNotification('题库索引已生成，请替换question-banks/index.json文件', 'info');
        }

        // 保存题库题目
        async function saveBankQuestions(bank, questions) {
            try {
                // 更新本地存储
                const storageKey = `bank_${bank.filename}`;
                localStorage.setItem(storageKey, JSON.stringify(questions));
                
                // 更新内存中的数据
                const bankIndex = questionBanks.findIndex(b => b.filename === bank.filename);
                if (bankIndex !== -1) {
                    questionBanks[bankIndex].questions = questions;
                    questionBanks[bankIndex].questionCount = questions.length;
                    questionBanks[bankIndex].updateTime = new Date().toISOString();
                }
                
                // 由于是静态网站，提供下载题库文件
                downloadFile(JSON.stringify(questions, null, 2), bank.filename, 'application/json');
                showNotification(`题库已保存到本地存储，文件已下载：${bank.filename}`, 'success');
                
                console.log(`✅ 题库保存成功: ${bank.filename}, 题目数量: ${questions.length}`);
                
            } catch (error) {
                console.error('保存题库时出错:', error);
                showNotification('保存题库时出错: ' + error.message, 'error');
            }
        }

        // 下载文件工具函数
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 显示通用模态框
        function showModal(title, content, actions = null) {
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="close-btn" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                        ${content}
                    </div>
                    ${actions ? `<div class="modal-footer" style="text-align: right; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef;">${actions}</div>` : ''}
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 点击外部关闭
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closeModal(modal.querySelector('.close-btn'));
                }
            };
        }
        
        // 关闭通用模态框
        function closeModal(button) {
            const modal = button.closest('.modal');
            if (modal && modal.parentNode) {
                modal.parentNode.removeChild(modal);
            }
        }
        
        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            // 显示动画
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // 自动隐藏
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const bankModal = document.getElementById('bankModal');
            const questionModal = document.getElementById('questionModal');
            
            if (event.target === bankModal) {
                closeBankModal();
            } else if (event.target === questionModal) {
                closeQuestionModal();
            }
        }

        // 键盘快捷键
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey || event.metaKey) {
                switch(event.key) {
                    case 'n':
                        event.preventDefault();
                        if (currentBank) {
                            addQuestion();
                        } else {
                            createNewBank();
                        }
                        break;
                    case 's':
                        event.preventDefault();
                        if (currentBank) {
                            exportBank();
                        }
                        break;
                }
            }
            
            if (event.key === 'Escape') {
                closeBankModal();
                closeQuestionModal();
            }
        });
    </script>
</body>
</html> 