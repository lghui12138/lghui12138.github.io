<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI助手 - 最小化版本</title>
    <style>
        .vector-perfect {
            position: relative;
            font-weight: bold;
            display: inline-block;
            margin: 0 2px;
        }
        .vector-perfect::after {
            content: '→';
            position: absolute;
            top: -0.4em;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7em;
            font-weight: normal;
            line-height: 1;
            color: currentColor;
            z-index: 1;
        }
        .math-display {
            text-align: center;
            margin: 15px 0;
            font-size: 1.2em;
            font-family: 'Times New Roman', serif;
        }
        .math-inline {
            font-family: 'Times New Roman', serif;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>AI助手 - deepseek-r1测试</h1>
        <div>
            <input v-model="question" placeholder="输入问题..." style="width: 300px; padding: 10px;">
            <button @click="askQuestion" style="padding: 10px 20px;">提问</button>
        </div>
        <div v-if="response" style="margin-top: 20px; padding: 20px; border: 1px solid #ccc;">
            <h3>AI回复：</h3>
            <div v-html="response"></div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    question: '',
                    response: ''
                }
            },
            methods: {
                // 智能模型选择器
                selectOptimalModel(question) {
                    const lowerQuestion = question.toLowerCase();
                    console.log('🧠 智能模型选择 - 分析问题:', question);

                    const derivationKeywords = [
                        '推导', '证明', '求解', '计算', '解析', '分析',
                        '如何得到', '怎么推出', '为什么等于', '步骤',
                        '公式推导', '数学推导', '理论推导'
                    ];

                    const hasDerivation = derivationKeywords.some(keyword =>
                        lowerQuestion.includes(keyword)
                    );

                    if (hasDerivation) {
                        console.log('🎯 选择deepseek-r1模型进行数学推导');
                        return {
                            preferredModel: 'deepseek-r1',
                            systemPrompt: `你是一位资深的流体力学教授，请详细回答学生的问题。
使用LaTeX语法表示数学公式，用$$包围显示公式，用$包围内联公式。
向量使用\\vec{v}格式，会自动渲染为v→`
                        };
                    } else {
                        console.log('🎯 选择通用模型进行概念解释');
                        return {
                            preferredModel: 'auto'
                        };
                    }
                },

                // LaTeX符号处理
                processLatexSymbols(formula) {
                    return formula
                        .replace(/\\rho/g, 'ρ')
                        .replace(/\\mu/g, 'μ')
                        .replace(/\\nabla/g, '∇')
                        .replace(/\\partial/g, '∂')
                        .replace(/\\vec\{([^}]+)\}/g, '<span class="vector-perfect">$1</span>');
                },

                // 处理公式
                processFormulas(content) {
                    // 处理$$包围的显示公式
                    content = content.replace(/\$\$([\s\S]*?)\$\$/g, (match, formula) => {
                        const processedFormula = this.processLatexSymbols(formula);
                        return `<div class="math-display">${processedFormula}</div>`;
                    });

                    // 处理$包围的内联公式
                    content = content.replace(/\$([^$\n]+)\$/g, (match, formula) => {
                        const processedFormula = this.processLatexSymbols(formula);
                        return `<span class="math-inline">${processedFormula}</span>`;
                    });

                    return content;
                },

                async askQuestion() {
                    if (!this.question.trim()) return;

                    console.log('🤖 开始处理问题:', this.question);
                    this.response = '正在思考中...';

                    // 智能模型选择
                    const modelConfig = this.selectOptimalModel(this.question);
                    console.log('📋 模型配置:', modelConfig);

                    try {
                        // 真正调用AI API
                        if (modelConfig.preferredModel === 'deepseek-r1') {
                            console.log('🚀 调用deepseek-r1模型');

                            const response = await fetch('https://api.siliconflow.cn/v1/chat/completions', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Bearer sk-dhseqxecuwwotodiskfdgwdjahnbexcgdotkfsovbgajxnis'
                                },
                                body: JSON.stringify({
                                    model: 'deepseek-ai/DeepSeek-R1',
                                    messages: [
                                        {
                                            role: 'system',
                                            content: modelConfig.systemPrompt
                                        },
                                        {
                                            role: 'user',
                                            content: this.question
                                        }
                                    ],
                                    max_tokens: 2000,
                                    temperature: 0.3
                                })
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }

                            const result = await response.json();
                            console.log('✅ deepseek-r1回复成功');

                            let aiResponse = result.choices[0].message.content;
                            aiResponse += '<br><br><small style="color: #888;">🤖 由deepseek-r1模型提供</small>';

                            // 处理LaTeX公式
                            this.response = this.processFormulas(aiResponse);
                        } else {
                            // 使用模拟回复作为备用
                            let aiResponse = `
                            <strong>概念解释回复（通用模型）：</strong><br><br>
                            这是一个很好的流体力学问题！让我为您详细解答...<br>
                            流体力学是研究流体运动规律的科学。
                            `;
                            this.response = this.processFormulas(aiResponse);
                        }
                    } catch (error) {
                        console.error('❌ AI调用失败:', error);
                        this.response = `调用AI失败: ${error.message}<br><br>请检查网络连接或API配置。`;
                    }

                    console.log('✅ 问题处理完成');
                }
            },
            mounted() {
                console.log('🚀 AI助手最小化版本已启动');
            }
        }).mount('#app');
    </script>
</body>
</html>
