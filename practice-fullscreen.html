<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>全屏做题 - 流体力学学习平台</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script>
    <style>
:root {
  --main-radius: 14px;
  --main-shadow: 0 4px 24px rgba(0,0,0,0.10);
  --main-bg: #f8fafd;
  --main-border: #e0e6ef;
  --main-font: 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Arial', sans-serif;
  --primary-color: #4facfe;
  --success-color: #27ae60;
  --warning-color: #f39c12;
  --danger-color: #e74c3c;
  --purple-color: #9b59b6;
  --info-color: #3498db;
  --light-gray: #ecf0f1;
  --dark-gray: #2c3e50;
  --gradient-primary: linear-gradient(135deg, #667eea, #764ba2);
  --gradient-success: linear-gradient(135deg, #27ae60, #2ecc71);
  --gradient-warning: linear-gradient(135deg, #f39c12, #e67e22);
  --gradient-danger: linear-gradient(135deg, #e74c3c, #c0392b);
  --gradient-purple: linear-gradient(135deg, #9b59b6, #8e44ad);
}

/* 全屏模式样式 */
.fullscreen-mode {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  z-index: 9999 !important;
  background: #fff !important;
  overflow: hidden !important;
}

.fullscreen-mode .fullscreen-header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: linear-gradient(135deg, var(--primary-color), #27ae60);
  color: white;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  z-index: 10000;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.fullscreen-mode .header-left {
  display: flex;
  align-items: center;
  gap: 15px;
}

.fullscreen-mode .header-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.fullscreen-mode .night-btn,
.fullscreen-mode .settings-btn,
.fullscreen-mode .close-btn {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 1em;
}

.fullscreen-mode .night-btn:hover,
.fullscreen-mode .settings-btn:hover,
.fullscreen-mode .close-btn:hover {
  background: rgba(255,255,255,0.3);
  transform: scale(1.05);
}

.fullscreen-mode .header-title {
  font-size: 1.2em;
  font-weight: 600;
  margin-left: 10px;
}

.fullscreen-mode .fullscreen-content {
  position: fixed;
  top: 60px;
  left: 0;
  right: 0;
  bottom: 0;
  overflow-y: auto;
  padding: 20px;
  background: var(--main-bg);
}

.fullscreen-mode .question-container {
  max-width: 900px;
  margin: 0 auto;
  background: white;
  border-radius: var(--main-radius);
  box-shadow: var(--main-shadow);
  padding: 30px;
  margin-bottom: 20px;
}

.fullscreen-mode .question-title {
  font-size: 1.3em;
  font-weight: 600;
  color: #2b3a55;
  line-height: 1.6;
  margin-bottom: 25px;
  padding: 20px;
  background: #f8fafd;
  border-radius: 12px;
  border-left: 4px solid var(--primary-color);
}

.fullscreen-mode .question-options {
  display: grid;
  gap: 12px;
  margin-bottom: 30px;
}

.fullscreen-mode .option-btn {
  padding: 15px 20px;
  border: 2px solid #e0e6ef;
  border-radius: 12px;
  background: white;
  font-size: 1.1em;
  text-align: left;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.fullscreen-mode .option-btn:hover {
  border-color: var(--primary-color);
  background: #f0f8ff;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(79, 172, 254, 0.15);
}

.fullscreen-mode .option-btn.selected {
  border-color: var(--primary-color);
  background: #e3f2fd;
  color: var(--primary-color);
}

.fullscreen-mode .option-btn.correct {
  border-color: var(--success-color);
  background: #e8f5e8;
  color: var(--success-color);
}

.fullscreen-mode .option-btn.incorrect {
  border-color: var(--danger-color);
  background: #ffebee;
  color: var(--danger-color);
}

.fullscreen-mode .controls-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: #f8fafd;
  border-radius: 12px;
  margin-bottom: 20px;
}

.fullscreen-mode .control-btn {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-size: 1em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.fullscreen-mode .control-btn:not(:disabled):hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.fullscreen-mode .control-btn.prev {
  background: #6c757d;
  color: white;
}

.fullscreen-mode .control-btn.next {
  background: var(--primary-color);
  color: white;
}

.fullscreen-mode .control-btn.explain {
  background: var(--warning-color);
  color: white;
}

.fullscreen-mode .control-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.fullscreen-mode .explanation-section {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 20px;
  margin-top: 20px;
  border-left: 4px solid var(--warning-color);
  display: none;
}

.fullscreen-mode .explanation-section.active {
  display: block;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.fullscreen-mode .progress-bar {
  position: fixed;
  top: 60px;
  left: 0;
  right: 0;
  height: 4px;
  background: #e0e6ef;
  z-index: 10001;
}

.fullscreen-mode .progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary-color), var(--success-color));
  transition: width 0.3s ease;
}

.fullscreen-mode .progress-text {
  position: fixed;
  top: 70px;
  right: 20px;
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.9em;
  z-index: 10002;
}

/* 移动端优化 */
@media (max-width: 768px) {
  .fullscreen-mode .fullscreen-header {
    height: 50px;
    padding: 0 15px;
  }
  
  .fullscreen-mode .fullscreen-content {
    top: 50px;
    padding: 15px;
  }
  
  .fullscreen-mode .question-container {
    padding: 20px;
    margin-bottom: 15px;
  }
  
  .fullscreen-mode .question-title {
    font-size: 1.1em;
    padding: 15px;
    margin-bottom: 20px;
  }
  
  .fullscreen-mode .question-options {
    gap: 8px;
  }
  
  .fullscreen-mode .option-btn {
    padding: 12px 15px;
    font-size: 1em;
  }
  
  .fullscreen-mode .controls-bar {
    flex-direction: column;
    gap: 10px;
    padding: 15px;
  }
  
  .fullscreen-mode .control-btn {
    width: 100%;
    justify-content: center;
    padding: 10px 20px;
  }
  
  .fullscreen-mode .progress-text {
    top: 60px;
    right: 15px;
    font-size: 0.8em;
  }
}

/* 夜间模式 */
.fullscreen-mode.night {
  background: #1a1a1a !important;
  color: #e0e0e0;
}

.fullscreen-mode.night .fullscreen-content {
  background: #1a1a1a;
}

.fullscreen-mode.night .question-container {
  background: #2d2d2d;
  color: #e0e0e0;
}

.fullscreen-mode.night .question-title {
  background: #3a3a3a;
  color: #e0e0e0;
}

.fullscreen-mode.night .option-btn {
  background: #2d2d2d;
  border-color: #4a4a4a;
  color: #e0e0e0;
}

.fullscreen-mode.night .option-btn:hover {
  background: #3a3a3a;
  border-color: var(--primary-color);
}

.fullscreen-mode.night .controls-bar {
  background: #3a3a3a;
}

.fullscreen-mode.night .explanation-section {
  background: #3a3a3a;
  color: #e0e0e0;
}

/* 全屏切换按钮 */
.fullscreen-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--primary-color);
  color: white;
  border: none;
  cursor: pointer;
  z-index: 10003;
  box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
  transition: all 0.2s;
}

.fullscreen-toggle:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 16px rgba(79, 172, 254, 0.4);
}

.fullscreen-toggle.exit {
  background: var(--danger-color);
}

/* 移动端全屏按钮优化 */
@media (max-width: 768px) {
  .fullscreen-toggle {
    bottom: 15px;
    right: 15px;
    width: 45px;
    height: 45px;
    font-size: 0.9em;
  }
}

/* 改善选项按钮在移动端的体验 */
@media (max-width: 768px) {
  .fullscreen-mode .option-btn {
    padding: 15px 12px;
    font-size: 1em;
    line-height: 1.4;
  }
  
  .fullscreen-mode .question-title {
    font-size: 1.1em;
    line-height: 1.5;
  }
  
  .fullscreen-mode .controls-bar {
    padding: 12px;
  }
  
  .fullscreen-mode .control-btn {
    padding: 10px 16px;
    font-size: 0.95em;
  }
}

/* 高亮搜索关键词 */
.highlight {
  background: #fff3cd;
  padding: 2px 4px;
  border-radius: 4px;
  font-weight: 600;
}

/* 加载动画 */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid var(--primary-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* 新增：做题统计面板 */
.stats-panel {
  position: fixed;
  top: 80px;
  right: 20px;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 10004;
  min-width: 200px;
  border: 1px solid rgba(255,255,255,0.2);
}

.stats-panel .stats-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-size: 0.9em;
}

.stats-panel .stats-item:last-child {
  margin-bottom: 0;
}

.stats-panel .stats-label {
  color: #666;
  font-weight: 500;
}

.stats-panel .stats-value {
  font-weight: 600;
  color: var(--primary-color);
}

/* 新增：做题时间计时器 */
.timer-display {
  position: fixed;
  top: 80px;
  left: 20px;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 12px 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 10004;
  border: 1px solid rgba(255,255,255,0.2);
  font-weight: 600;
  color: var(--primary-color);
}

/* 新增：题目导航缩略图 */
.question-nav {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 10004;
  display: flex;
  gap: 5px;
  max-width: 90vw;
  overflow-x: auto;
}

.question-nav .nav-item {
  width: 30px;
  height: 30px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-size: 0.8em;
  font-weight: 600;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.question-nav .nav-item.current {
  background: var(--primary-color);
  color: white;
}

.question-nav .nav-item.answered {
  background: var(--success-color);
  color: white;
}

.question-nav .nav-item.wrong {
  background: var(--danger-color);
  color: white;
}

.question-nav .nav-item.unanswered {
  background: #e0e6ef;
  color: #666;
}

/* 新增：语音朗读功能 */
.voice-controls {
  position: fixed;
  bottom: 80px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 10004;
}

.voice-btn {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  font-size: 1.2em;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.voice-btn.play {
  background: var(--success-color);
  color: white;
}

.voice-btn.stop {
  background: var(--danger-color);
  color: white;
}

.voice-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 16px rgba(0,0,0,0.2);
}

/* 新增：手势操作提示 */
.gesture-hint {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 20px;
  border-radius: 12px;
  z-index: 10005;
  text-align: center;
  font-size: 1.1em;
  display: none;
}

/* 新增：做题模式切换 */
.mode-switch {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 10004;
  display: flex;
  gap: 5px;
}

.mode-switch .mode-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9em;
  font-weight: 500;
  transition: all 0.2s;
}

.mode-switch .mode-btn.active {
  background: var(--primary-color);
  color: white;
}

.mode-switch .mode-btn:not(.active) {
  background: #e0e6ef;
  color: #666;
}

/* 新增：智能提示系统 */
.smart-hint {
  position: fixed;
  bottom: 120px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 15px 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 10004;
  max-width: 300px;
  text-align: center;
  font-size: 0.9em;
  color: #666;
  display: none;
}

/* 新增：夜间模式优化 */
.fullscreen-mode.night .stats-panel,
.fullscreen-mode.night .timer-display,
.fullscreen-mode.night .question-nav,
.fullscreen-mode.night .voice-controls,
.fullscreen-mode.night .mode-switch,
.fullscreen-mode.night .smart-hint {
  background: rgba(45,45,45,0.95);
  color: #e0e0e0;
  border-color: rgba(255,255,255,0.1);
}

.fullscreen-mode.night .stats-label {
  color: #aaa;
}

.fullscreen-mode.night .nav-item.unanswered {
  background: #4a4a4a;
  color: #ccc;
}

/* 新增：AI智能推荐面板 */
.ai-recommendation {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(255,255,255,0.98);
  backdrop-filter: blur(20px);
  border-radius: 16px;
  padding: 25px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  z-index: 10006;
  max-width: 400px;
  width: 90vw;
  display: none;
  border: 1px solid rgba(255,255,255,0.3);
}

.ai-recommendation.show {
  display: block;
  animation: slideInUp 0.3s ease-out;
}

@keyframes slideInUp {
  from { opacity: 0; transform: translate(-50%, -30%); }
  to { opacity: 1; transform: translate(-50%, -50%); }
}

.ai-recommendation .ai-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 15px;
  color: var(--purple-color);
  font-weight: 600;
}

.ai-recommendation .ai-content {
  color: #333;
  line-height: 1.6;
  margin-bottom: 20px;
}

.ai-recommendation .ai-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

/* 新增：学习数据分析面板 */
.analytics-panel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(255,255,255,0.98);
  backdrop-filter: blur(20px);
  border-radius: 16px;
  padding: 25px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  z-index: 10006;
  max-width: 600px;
  width: 90vw;
  max-height: 80vh;
  overflow-y: auto;
  display: none;
  border: 1px solid rgba(255,255,255,0.3);
}

.analytics-panel.show {
  display: block;
  animation: slideInUp 0.3s ease-out;
}

.analytics-chart {
  width: 100%;
  height: 200px;
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  border-radius: 12px;
  margin: 15px 0;
  display: flex;
  align-items: end;
  justify-content: space-around;
  padding: 20px;
  gap: 5px;
}

.analytics-bar {
  background: linear-gradient(to top, var(--primary-color), var(--info-color));
  border-radius: 4px 4px 0 0;
  min-width: 20px;
  transition: all 0.3s;
}

.analytics-bar:hover {
  transform: scaleY(1.1);
}

/* 新增：社交分享功能 */
.share-panel {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 10004;
  display: none;
  border: 1px solid rgba(255,255,255,0.2);
}

.share-panel.show {
  display: block;
  animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateX(-50%) translateY(20px); }
  to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

.share-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: center;
}

.share-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9em;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 5px;
}

.share-btn.wechat {
  background: #07c160;
  color: white;
}

.share-btn.qq {
  background: #12b7f5;
  color: white;
}

.share-btn.weibo {
  background: #e6162d;
  color: white;
}

.share-btn.copy {
  background: var(--primary-color);
  color: white;
}

.share-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* 新增：离线模式指示器 */
.offline-indicator {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  border-radius: 8px;
  padding: 8px 16px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.15);
  z-index: 10004;
  display: none;
  border: 1px solid rgba(255,255,255,0.2);
  font-size: 0.9em;
  color: var(--warning-color);
}

.offline-indicator.show {
  display: block;
}

/* 新增：学习进度追踪 */
.progress-tracker {
  position: fixed;
  top: 80px;
  right: 20px;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 10004;
  min-width: 180px;
  border: 1px solid rgba(255,255,255,0.2);
  display: none;
}

.progress-tracker.show {
  display: block;
}

.progress-tracker .tracker-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-size: 0.9em;
}

.progress-tracker .tracker-item:last-child {
  margin-bottom: 0;
}

.progress-tracker .tracker-label {
  color: #666;
  font-weight: 500;
}

.progress-tracker .tracker-value {
  font-weight: 600;
  color: var(--primary-color);
}

/* 新增：智能提示增强 */
.smart-tips {
  position: fixed;
  bottom: 120px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 15px 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 10004;
  max-width: 350px;
  text-align: center;
  font-size: 0.9em;
  color: #666;
  display: none;
  border: 1px solid rgba(255,255,255,0.2);
}

.smart-tips.show {
  display: block;
  animation: slideUp 0.3s ease-out;
}

.smart-tips .tip-icon {
  font-size: 1.2em;
  margin-bottom: 8px;
  color: var(--info-color);
}

/* 新增：主题切换功能 */
.theme-switcher {
  position: fixed;
  top: 80px;
  left: 20px;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 10004;
  display: flex;
  gap: 5px;
  border: 1px solid rgba(255,255,255,0.2);
}

.theme-btn {
  width: 30px;
  height: 30px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

.theme-btn:hover {
  transform: scale(1.1);
}

.theme-btn.active::after {
  content: "✓";
  position: absolute;
  top: -2px;
  right: -2px;
  background: var(--success-color);
  color: white;
  border-radius: 50%;
  width: 16px;
  height: 16px;
  font-size: 0.7em;
  display: flex;
  align-items: center;
  justify-content: center;
}

.theme-default { background: linear-gradient(135deg, #4facfe, #00f2fe); }
.theme-ocean { background: linear-gradient(135deg, #667eea, #764ba2); }
.theme-sunset { background: linear-gradient(135deg, #f093fb, #f5576c); }
.theme-forest { background: linear-gradient(135deg, #4facfe, #00f2fe); }

/* 新增：移动端优化 */
@media (max-width: 768px) {
  .stats-panel,
  .timer-display,
  .question-nav,
  .voice-controls,
  .mode-switch,
  .ai-recommendation,
  .analytics-panel,
  .share-panel,
  .progress-tracker,
  .smart-tips,
  .theme-switcher {
    transform: scale(0.9);
  }
  
  .question-nav {
    bottom: 10px;
    max-width: 95vw;
  }
  
  .voice-controls {
    bottom: 70px;
    right: 15px;
  }
  
  .smart-hint {
    bottom: 100px;
    max-width: 280px;
  }
  
  .ai-recommendation,
  .analytics-panel,
  .ml-prediction,
  .learning-path,
  .smart-error-analysis,
  .achievement-system {
    max-width: 95vw;
    width: 95vw;
  }
  
  .share-panel {
    bottom: 10px;
    max-width: 90vw;
  }
  
  .adaptive-difficulty {
    max-width: 90vw;
  }
  
  .smart-reminder {
    bottom: 10px;
    right: 10px;
    max-width: 280px;
  }
}

/* 新增：机器学习预测面板 */
.ml-prediction {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(255,255,255,0.98);
  backdrop-filter: blur(20px);
  border-radius: 16px;
  padding: 25px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  z-index: 10006;
  max-width: 500px;
  width: 90vw;
  display: none;
  border: 1px solid rgba(255,255,255,0.3);
}

.ml-prediction.show {
  display: block;
  animation: slideInUp 0.3s ease-out;
}

.ml-prediction .prediction-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 15px;
  color: var(--purple-color);
  font-weight: 600;
}

.ml-prediction .prediction-content {
  color: #333;
  line-height: 1.6;
  margin-bottom: 20px;
}

.ml-prediction .prediction-chart {
  width: 100%;
  height: 150px;
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  border-radius: 12px;
  margin: 15px 0;
  position: relative;
  overflow: hidden;
}

.ml-prediction .prediction-line {
  position: absolute;
  bottom: 20px;
  left: 20px;
  right: 20px;
  height: 2px;
  background: var(--gradient-primary);
  border-radius: 1px;
}

.ml-prediction .prediction-point {
  position: absolute;
  width: 12px;
  height: 12px;
  background: var(--primary-color);
  border-radius: 50%;
  border: 2px solid white;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  transform: translate(-50%, -50%);
}

/* 新增：自适应难度系统 */
.adaptive-difficulty {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 10004;
  display: none;
  border: 1px solid rgba(255,255,255,0.2);
  min-width: 250px;
}

.adaptive-difficulty.show {
  display: block;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
  to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

.difficulty-indicator {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.difficulty-bar {
  flex: 1;
  height: 8px;
  background: #e9ecef;
  border-radius: 4px;
  overflow: hidden;
}

.difficulty-fill {
  height: 100%;
  background: var(--gradient-primary);
  border-radius: 4px;
  transition: width 0.3s ease;
}

.difficulty-label {
  font-size: 0.9em;
  font-weight: 600;
  color: var(--primary-color);
  min-width: 60px;
  text-align: center;
}

/* 新增：学习路径规划 */
.learning-path {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(255,255,255,0.98);
  backdrop-filter: blur(20px);
  border-radius: 16px;
  padding: 25px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  z-index: 10006;
  max-width: 600px;
  width: 90vw;
  max-height: 80vh;
  overflow-y: auto;
  display: none;
  border: 1px solid rgba(255,255,255,0.3);
}

.learning-path.show {
  display: block;
  animation: slideInUp 0.3s ease-out;
}

.path-node {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px;
  margin: 10px 0;
  background: #f8f9fa;
  border-radius: 12px;
  border-left: 4px solid var(--primary-color);
  transition: all 0.3s;
}

.path-node:hover {
  background: #e9ecef;
  transform: translateX(5px);
}

.path-node.completed {
  border-left-color: var(--success-color);
  background: #d4edda;
}

.path-node.current {
  border-left-color: var(--warning-color);
  background: #fff3cd;
}

.path-node.locked {
  border-left-color: #ccc;
  background: #f8f9fa;
  opacity: 0.6;
}

.path-node-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2em;
  color: white;
}

.path-node.completed .path-node-icon {
  background: var(--gradient-success);
}

.path-node.current .path-node-icon {
  background: var(--gradient-warning);
}

.path-node.locked .path-node-icon {
  background: #ccc;
}

/* 新增：智能错题分析 */
.smart-error-analysis {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(255,255,255,0.98);
  backdrop-filter: blur(20px);
  border-radius: 16px;
  padding: 25px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  z-index: 10006;
  max-width: 500px;
  width: 90vw;
  display: none;
  border: 1px solid rgba(255,255,255,0.3);
}

.smart-error-analysis.show {
  display: block;
  animation: slideInUp 0.3s ease-out;
}

.error-pattern {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 15px;
  margin: 10px 0;
  border-left: 4px solid var(--danger-color);
}

.error-pattern .pattern-title {
  font-weight: 600;
  color: var(--danger-color);
  margin-bottom: 8px;
}

.error-pattern .pattern-desc {
  color: #666;
  font-size: 0.9em;
  line-height: 1.5;
}

.error-pattern .pattern-suggestion {
  margin-top: 10px;
  padding: 10px;
  background: #d4edda;
  border-radius: 8px;
  color: #155724;
  font-size: 0.9em;
}

/* 新增：学习效率监控 */
.efficiency-monitor {
  position: fixed;
  top: 80px;
  right: 20px;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 10004;
  min-width: 200px;
  border: 1px solid rgba(255,255,255,0.2);
  display: none;
}

.efficiency-monitor.show {
  display: block;
}

.efficiency-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-size: 0.9em;
}

.efficiency-item:last-child {
  margin-bottom: 0;
}

.efficiency-label {
  color: #666;
  font-weight: 500;
}

.efficiency-value {
  font-weight: 600;
  color: var(--primary-color);
}

.efficiency-trend {
  font-size: 0.8em;
  margin-left: 5px;
}

.efficiency-trend.up {
  color: var(--success-color);
}

.efficiency-trend.down {
  color: var(--danger-color);
}

/* 新增：智能提醒系统 */
.smart-reminder {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 10004;
  max-width: 300px;
  border: 1px solid rgba(255,255,255,0.2);
  display: none;
}

.smart-reminder.show {
  display: block;
  animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
  from { opacity: 0; transform: translateX(100%); }
  to { opacity: 1; transform: translateX(0); }
}

.reminder-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
  color: var(--warning-color);
  font-weight: 600;
}

.reminder-content {
  color: #333;
  line-height: 1.5;
  font-size: 0.9em;
}

.reminder-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.reminder-btn {
  padding: 5px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.8em;
  transition: all 0.2s;
}

.reminder-btn.primary {
  background: var(--primary-color);
  color: white;
}

.reminder-btn.secondary {
  background: #e9ecef;
  color: #666;
}

.reminder-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

/* 新增：AI分析加载动画 */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* 新增：题目内集成操作按钮样式 */
.question-actions-integrated {
  margin-top: 20px !important;
  animation: slideInFromBottom 0.4s ease-out;
  position: relative;
}

@keyframes slideInFromBottom {
  from { 
    opacity: 0; 
    transform: translateY(30px) scale(0.95); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0) scale(1); 
  }
}

.question-actions-integrated::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(40, 167, 69, 0.02), rgba(0, 123, 255, 0.02));
  border-radius: 12px;
  z-index: 1;
}

.question-actions-integrated button {
  font-family: inherit !important;
  letter-spacing: 0.3px !important;
  position: relative;
  z-index: 2;
  transform-origin: center center;
}

.question-actions-integrated button:not(:disabled):active {
  transform: scale(0.98) !important;
}

.question-actions-integrated button:disabled {
  pointer-events: none !important;
  filter: grayscale(50%) !important;
}

.question-actions-integrated #submitAnswerBtn:not(:disabled) {
  box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3), inset 0 1px 0 rgba(255,255,255,0.2) !important;
}

.question-actions-integrated #submitAnswerBtn:not(:disabled):hover {
  box-shadow: 0 6px 25px rgba(40, 167, 69, 0.4), inset 0 1px 0 rgba(255,255,255,0.3) !important;
}

/* 移动端适配 */
@media (max-width: 768px) {
  .question-actions-integrated {
    padding: 15px !important;
  }
  
  .question-actions-integrated > div:first-child {
    flex-direction: column !important;
    gap: 15px !important;
  }
  
  .question-actions-integrated > div:first-child > div {
    width: 100% !important;
    justify-content: center !important;
  }
  
  .question-actions-integrated button {
    width: 100% !important;
    padding: 18px 28px !important;
    font-size: 16px !important;
    min-width: auto !important;
  }
}

/* 新增：学习成就系统 */
.achievement-system {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(255,255,255,0.98);
  backdrop-filter: blur(20px);
  border-radius: 16px;
  padding: 25px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  z-index: 10006;
  max-width: 500px;
  width: 90vw;
  max-height: 80vh;
  overflow-y: auto;
  display: none;
  border: 1px solid rgba(255,255,255,0.3);
}

.achievement-system.show {
  display: block;
  animation: slideInUp 0.3s ease-out;
}

.achievement-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px;
  margin: 10px 0;
  background: #f8f9fa;
  border-radius: 12px;
  transition: all 0.3s;
}

.achievement-item.unlocked {
  background: linear-gradient(135deg, #d4edda, #c3e6cb);
  border-left: 4px solid var(--success-color);
}

.achievement-item.locked {
  background: #f8f9fa;
  opacity: 0.6;
  border-left: 4px solid #ccc;
}

.achievement-icon {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5em;
  color: white;
}

.achievement-item.unlocked .achievement-icon {
  background: var(--gradient-success);
}

.achievement-item.locked .achievement-icon {
  background: #ccc;
}

.achievement-info {
  flex: 1;
}

.achievement-title {
  font-weight: 600;
  color: #333;
  margin-bottom: 5px;
}

.achievement-desc {
  font-size: 0.9em;
  color: #666;
  line-height: 1.4;
}

.achievement-progress {
  font-size: 0.8em;
  color: var(--primary-color);
  font-weight: 500;
}

/* 新增：移动端优化 */
@media (max-width: 768px) {
  .stats-panel,
  .timer-display,
  .question-nav,
  .voice-controls,
  .mode-switch,
  .ai-recommendation,
  .analytics-panel,
  .share-panel,
  .progress-tracker,
  .smart-tips,
  .theme-switcher,
  .ml-prediction,
  .adaptive-difficulty,
  .learning-path,
  .smart-error-analysis,
  .efficiency-monitor,
  .smart-reminder,
  .achievement-system {
    transform: scale(0.9);
  }
  
  .question-nav {
    bottom: 10px;
    max-width: 95vw;
  }
  
  .voice-controls {
    bottom: 70px;
    right: 15px;
  }
  
  .smart-hint {
    bottom: 100px;
    max-width: 280px;
  }
  
  .ai-recommendation,
  .analytics-panel,
  .ml-prediction,
  .learning-path,
  .smart-error-analysis,
  .achievement-system {
    max-width: 95vw;
    width: 95vw;
  }
  
  .share-panel {
    bottom: 10px;
    max-width: 90vw;
  }
  
  .adaptive-difficulty {
    max-width: 90vw;
  }
  
  .smart-reminder {
    bottom: 10px;
    right: 10px;
    max-width: 280px;
  }
}
body {
  background: var(--main-bg);
  font-family: var(--main-font);
  color: #23273a;
}
button, .btn, .wrongbook-btn, .modal-btn {
  border-radius: var(--main-radius) !important;
  box-shadow: var(--main-shadow);
  border: none;
  font-family: var(--main-font);
  font-size: 1.08em;
  padding: 10px 22px;
  margin: 4px 0;
  transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
}
button:active, .btn:active, .wrongbook-btn:active, .modal-btn:active {
  transform: scale(0.97);
}
input, select, textarea {
  border-radius: var(--main-radius);
  border: 1.5px solid var(--main-border);
  padding: 8px 12px;
  font-size: 1em;
  font-family: var(--main-font);
  margin: 2px 0;
  background: #fff;
  box-shadow: 0 1px 4px rgba(0,0,0,0.03);
  outline: none;
  transition: border 0.2s;
}
input:focus, select:focus, textarea:focus {
  border-color: #4facfe;
}
#searchBar, #importBar, #syncBar, #qbFilterBar {
  background: #fff;
  border-radius: var(--main-radius);
  box-shadow: var(--main-shadow);
  padding: 12px 18px;
  margin-bottom: 16px;
  align-items: center;
}
#searchResult, #previewBox, #metaEditBox, #modalBox, #qbManagePanel {
  background: #fff;
  border-radius: var(--main-radius);
  box-shadow: var(--main-shadow);
  padding: 24px 20px;
}
.fullscreen-container {
  background: #fff;
  border-radius: var(--main-radius);
  box-shadow: var(--main-shadow);
  padding: 24px 18px 18px 18px;
  margin-bottom: 18px;
}
.fullscreen-progress {
  font-size: 1.08em;
  color: #4facfe;
  margin-bottom: 12px;
}
.question-title, .fullscreen-question-card {
  font-size: 1.18em;
  font-weight: 500;
  margin-bottom: 12px;
  color: #23273a;
  line-height: 1.7;
}
.question-title img, .fullscreen-question-card img, .question-options img, .explanation-section img {
  max-width: 98%;
  height: auto;
  display: block;
  margin: 8px auto;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.question-title table, .fullscreen-question-card table, .explanation-section table {
  border-collapse: collapse;
  margin: 10px 0;
  width: 100%;
}
.question-title th, .question-title td, .fullscreen-question-card th, .fullscreen-question-card td, .explanation-section th, .explanation-section td {
  border: 1px solid #e0e6ef;
  padding: 6px 10px;
  text-align: center;
}
.question-title ul, .fullscreen-question-card ul, .explanation-section ul {
  margin: 8px 0 8px 24px;
  padding-left: 18px;
}
.question-title code, .fullscreen-question-card code, .explanation-section code {
  background: #f4f4f4;
  color: #c7254e;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.98em;
}
#questionOptions, .fullscreen-options {
  margin-bottom: 16px;
}
@media (max-width: 700px) {
  #searchBar, #importBar, #syncBar, #qbFilterBar, #searchResult, #previewBox, #metaEditBox, #modalBox, #qbManagePanel, .fullscreen-container {
    padding: 10px 4vw !important;
    margin-bottom: 12px;
  }
  button, .btn, .wrongbook-btn, .modal-btn {
    font-size: 1em;
    padding: 10px 10vw;
  }
  input, select, textarea {
    font-size: 1em;
    padding: 8px 4vw;
  }
  .fullscreen-container {
    padding: 12px 2vw 10px 2vw !important;
  }
  .question-title, .fullscreen-question-card, .explanation-section {
    font-size: 1.05em;
    line-height: 1.5;
  }
}
    </style>
</head>
<body>
    <!-- 全屏切换按钮 -->
    <button class="fullscreen-toggle" id="fullscreenToggle" title="切换全屏模式">
        <i class="fas fa-expand"></i>
    </button>

    <div class="fullscreen-header">
        <div class="header-left">
            <button class="night-btn" onclick="toggleNightMode()" title="夜间模式"><i class="fas fa-moon"></i></button>
            <button class="settings-btn" onclick="toggleAutoFullscreen()" title="自动全屏设置"><i class="fas fa-cog"></i></button>
            <button class="ai-btn" onclick="showAiRecommendation()" title="AI智能推荐"><i class="fas fa-robot"></i></button>
            <button class="analytics-btn" onclick="showAnalytics()" title="学习数据分析"><i class="fas fa-chart-line"></i></button>
            <button class="ml-btn" onclick="showMlPrediction()" title="AI学习预测"><i class="fas fa-brain"></i></button>
            <button class="path-btn" onclick="showLearningPath()" title="学习路径"><i class="fas fa-route"></i></button>
            <button class="error-btn" onclick="showSmartErrorAnalysis()" title="错题分析"><i class="fas fa-search"></i></button>
            <button class="achievement-btn" onclick="showAchievementSystem()" title="学习成就"><i class="fas fa-trophy"></i></button>
            <button class="share-btn" onclick="showSharePanel()" title="分享结果"><i class="fas fa-share-alt"></i></button>
            <span class="header-title">流体力学题库</span>
        </div>
        <div class="header-right">
            <button class="close-btn" onclick="exitFullscreen()" title="退出全屏"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <!-- 进度条 -->
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>
    <div class="progress-text" id="progressText">0%</div>

    <div class="fullscreen-content">
        <!-- 做题时间计时器 -->
        <div class="timer-display" id="timerDisplay">
            <i class="fas fa-clock"></i> <span id="timerText">00:00</span>
        </div>
        
        <!-- 做题统计面板 -->
        <div class="stats-panel" id="statsPanel">
            <div class="stats-item">
                <span class="stats-label">总题数</span>
                <span class="stats-value" id="totalQuestions">0</span>
            </div>
            <div class="stats-item">
                <span class="stats-label">已答题</span>
                <span class="stats-value" id="answeredQuestions">0</span>
            </div>
            <div class="stats-item">
                <span class="stats-label">正确率</span>
                <span class="stats-value" id="accuracyRate">0%</span>
            </div>
            <div class="stats-item">
                <span class="stats-label">平均用时</span>
                <span class="stats-value" id="avgTime">0s</span>
            </div>
        </div>
        
        <!-- 做题模式切换 -->
        <div class="mode-switch" id="modeSwitch">
            <button class="mode-btn active" data-mode="practice">练习模式</button>
            <button class="mode-btn" data-mode="exam">考试模式</button>
            <button class="mode-btn" data-mode="review">复习模式</button>
        </div>
        
        <!-- 题目导航缩略图 -->
        <div class="question-nav" id="questionNav"></div>
        
        <!-- 语音朗读控制 -->
        <div class="voice-controls" id="voiceControls">
            <button class="voice-btn play" id="voicePlayBtn" title="朗读题目">
                <i class="fas fa-volume-up"></i>
            </button>
            <button class="voice-btn stop" id="voiceStopBtn" title="停止朗读" style="display:none;">
                <i class="fas fa-stop"></i>
            </button>
        </div>
        
        <!-- 智能提示系统 -->
        <div class="smart-hint" id="smartHint"></div>
        
        <!-- 手势操作提示 -->
        <div class="gesture-hint" id="gestureHint">
            <i class="fas fa-hand-pointer"></i><br>
            向左滑动：上一题<br>
            向右滑动：下一题<br>
            双击：显示解析
        </div>
        
        <!-- AI智能推荐面板 -->
        <div class="ai-recommendation" id="aiRecommendation">
            <div class="ai-header">
                <i class="fas fa-robot"></i>
                <span>AI智能推荐</span>
            </div>
            <div class="ai-content" id="aiContent">
                正在分析您的做题情况...
            </div>
            <div class="ai-actions">
                <button class="control-btn" onclick="hideAiRecommendation()">关闭</button>
                <button class="control-btn" onclick="applyAiRecommendation()">应用建议</button>
            </div>
        </div>
        
        <!-- 学习数据分析面板 -->
        <div class="analytics-panel" id="analyticsPanel">
            <h3 style="margin-bottom: 20px; color: var(--primary-color);">
                <i class="fas fa-chart-line"></i> 学习数据分析
            </h3>
            <div class="analytics-chart" id="analyticsChart">
                <!-- 图表将通过JavaScript动态生成 -->
            </div>
            <div id="analyticsDetails">
                <!-- 详细分析内容 -->
            </div>
            <button class="control-btn" onclick="hideAnalytics()" style="margin-top: 15px;">关闭</button>
        </div>
        
        <!-- 社交分享面板 -->
        <div class="share-panel" id="sharePanel">
            <div style="margin-bottom: 10px; text-align: center; font-weight: 600; color: var(--primary-color);">
                分享做题结果
            </div>
            <div class="share-buttons">
                <button class="share-btn wechat" onclick="shareToWechat()">
                    <i class="fab fa-weixin"></i> 微信
                </button>
                <button class="share-btn qq" onclick="shareToQQ()">
                    <i class="fab fa-qq"></i> QQ
                </button>
                <button class="share-btn weibo" onclick="shareToWeibo()">
                    <i class="fab fa-weibo"></i> 微博
                </button>
                <button class="share-btn copy" onclick="copyShareLink()">
                    <i class="fas fa-copy"></i> 复制链接
                </button>
            </div>
        </div>
        
        <!-- 离线模式指示器 -->
        <div class="offline-indicator" id="offlineIndicator">
            <i class="fas fa-wifi-slash"></i> 离线模式
        </div>
        
        <!-- 学习进度追踪 -->
        <div class="progress-tracker" id="progressTracker">
            <div class="tracker-item">
                <span class="tracker-label">今日做题</span>
                <span class="tracker-value" id="todayQuestions">0</span>
            </div>
            <div class="tracker-item">
                <span class="tracker-label">连续天数</span>
                <span class="tracker-value" id="streakDays">0</span>
            </div>
            <div class="tracker-item">
                <span class="tracker-label">总做题数</span>
                <span class="tracker-value" id="totalQuestionsDone">0</span>
            </div>
        </div>
        
        <!-- 主题切换器 -->
        <div class="theme-switcher" id="themeSwitcher">
            <button class="theme-btn theme-default active" data-theme="default" title="默认主题"></button>
            <button class="theme-btn theme-ocean" data-theme="ocean" title="海洋主题"></button>
            <button class="theme-btn theme-sunset" data-theme="sunset" title="日落主题"></button>
            <button class="theme-btn theme-forest" data-theme="forest" title="森林主题"></button>
        </div>
        
        <!-- 机器学习预测面板 -->
        <div class="ml-prediction" id="mlPrediction">
            <div class="prediction-header">
                <i class="fas fa-brain"></i>
                <span>AI学习预测</span>
            </div>
            <div class="prediction-content" id="predictionContent">
                正在分析您的学习模式...
            </div>
            <div class="prediction-chart" id="predictionChart">
                <div class="prediction-line"></div>
                <!-- 预测点将通过JavaScript动态生成 -->
            </div>
            <button class="control-btn" onclick="hideMlPrediction()">关闭</button>
        </div>
        
        <!-- 自适应难度系统 -->
        <div class="adaptive-difficulty" id="adaptiveDifficulty">
            <div class="difficulty-indicator">
                <span>当前难度</span>
                <div class="difficulty-bar">
                    <div class="difficulty-fill" id="difficultyFill" style="width: 50%;"></div>
                </div>
                <span class="difficulty-label" id="difficultyLabel">中等</span>
            </div>
            <div style="font-size: 0.9em; color: #666; text-align: center;">
                系统将根据您的表现自动调整题目难度
            </div>
        </div>
        
        <!-- 学习路径规划 -->
        <div class="learning-path" id="learningPath">
            <h3 style="margin-bottom: 20px; color: var(--primary-color);">
                <i class="fas fa-route"></i> 个性化学习路径
            </h3>
            <div id="pathNodes">
                <!-- 学习节点将通过JavaScript动态生成 -->
            </div>
            <button class="control-btn" onclick="hideLearningPath()" style="margin-top: 15px;">关闭</button>
        </div>
        
        <!-- 智能错题分析 -->
        <div class="smart-error-analysis" id="smartErrorAnalysis">
            <h3 style="margin-bottom: 20px; color: var(--danger-color);">
                <i class="fas fa-search"></i> 智能错题分析
            </h3>
            <div id="errorPatterns">
                <!-- 错误模式将通过JavaScript动态生成 -->
            </div>
            <button class="control-btn" onclick="hideSmartErrorAnalysis()" style="margin-top: 15px;">关闭</button>
        </div>
        
        <!-- 学习效率监控 -->
        <div class="efficiency-monitor" id="efficiencyMonitor">
            <div class="efficiency-item">
                <span class="efficiency-label">学习效率</span>
                <span class="efficiency-value" id="efficiencyValue">85%</span>
                <span class="efficiency-trend up" id="efficiencyTrend">↗</span>
            </div>
            <div class="efficiency-item">
                <span class="efficiency-label">专注度</span>
                <span class="efficiency-value" id="focusValue">92%</span>
                <span class="efficiency-trend up" id="focusTrend">↗</span>
            </div>
            <div class="efficiency-item">
                <span class="efficiency-label">理解度</span>
                <span class="efficiency-value" id="comprehensionValue">78%</span>
                <span class="efficiency-trend down" id="comprehensionTrend">↘</span>
            </div>
        </div>
        
        <!-- 智能提醒系统 -->
        <div class="smart-reminder" id="smartReminder">
            <div class="reminder-header">
                <i class="fas fa-bell"></i>
                <span>智能提醒</span>
            </div>
            <div class="reminder-content" id="reminderContent">
                您已经连续学习30分钟，建议休息一下眼睛。
            </div>
            <div class="reminder-actions">
                <button class="reminder-btn primary" onclick="dismissReminder()">知道了</button>
                <button class="reminder-btn secondary" onclick="snoozeReminder()">稍后提醒</button>
            </div>
        </div>
        
        <!-- 学习成就系统 -->
        <div class="achievement-system" id="achievementSystem">
            <h3 style="margin-bottom: 20px; color: var(--primary-color);">
                <i class="fas fa-trophy"></i> 学习成就
            </h3>
            <div id="achievementItems">
                <!-- 成就项目将通过JavaScript动态生成 -->
            </div>
            <button class="control-btn" onclick="hideAchievementSystem()" style="margin-top: 15px;">关闭</button>
        </div>
        
        <div class="stat-bar" id="statBar"></div>
    <!-- 题库筛选区 -->
    <div id="qbFilterBar" style="margin: 10px 0 18px 0; display: flex; flex-wrap: wrap; align-items: center; gap: 12px;">
      <select id="qbTagFilter" class="qb-select" style="min-width:90px;"><option value="">全部标签</option></select>
      <select id="qbLevelFilter" class="qb-select" style="min-width:90px;"><option value="">全部难度</option><option value="easy">简单</option><option value="medium">中等</option><option value="hard">困难</option></select>
      <select id="qbUploaderFilter" class="qb-select" style="min-width:90px;"><option value="">全部上传者</option></select>
      <span style="font-size:13px;color:#888;">（可多条件组合筛选）</span>
    </div>
    <div class="questionbank-bar">
        <select id="qbSelect" class="qb-select"></select>
        <select id="yearSelect" class="qb-select" style="min-width:90px;"><option value="">全部年份</option></select>
        <button class="wrongbook-btn" id="randomBtn" style="background:#27ae60;" onclick="randomPractice()"><i class="fas fa-random"></i> 随机做题</button>
        <label class="qb-upload">
            <i class="fas fa-upload"></i> 本地题库
            <input type="file" id="qbUploadInput" accept=".json,.csv" style="display:none;">
        </label>
        <button class="wrongbook-btn" onclick="loadWrongBook()"><i class="fas fa-book"></i> 错题本</button>
        <button class="wrongbook-btn" onclick="exportWrongBook()" title="导出错题本"><i class="fas fa-download"></i> 导出错题</button>
        <button class="wrongbook-btn" onclick="exportFavBook()" title="导出收藏本"><i class="fas fa-star"></i> 导出收藏</button>
        <button class="wrongbook-btn" id="qbManageBtn" style="display:none; background:#006994;" onclick="showQbManagePanel()"><i class="fas fa-cog"></i> 题库管理</button>
        <button class="wrongbook-btn" id="showAllQbBtn" style="display:none; background:#888;" onclick="toggleShowAllQb()"><i class="fas fa-eye"></i> 显示全部</button>
    </div>
    <div id="qbManagePanel" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); background:#fff; color:#222; border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,0.18); padding:32px 24px; z-index:9999; max-width:96vw; min-width:320px;">
        <h3 style="margin-bottom:18px;">题库管理</h3>
        <div id="qbManageList" style="max-height:40vh; overflow:auto; margin-bottom:18px; border-bottom:1px solid #eee; padding-bottom:10px;"></div>
        <div style="margin-bottom:18px;">
            <button class="wrongbook-btn" style="background:#f39c12;" onclick="batchQbHidden()"><i class="fas fa-eye-slash"></i> 批量下架/上架</button>
            <button class="wrongbook-btn" style="background:#e74c3c; margin-left:8px;" onclick="batchQbDelete()"><i class="fas fa-trash"></i> 批量删除</button>
        </div>
        <button class="wrongbook-btn" style="background:#888;" onclick="closeQbManagePanel()">关闭</button>
        <div id="qbManageStatus" style="margin-top:16px; color:#006994;"></div>
    </div>
    <!-- 导入区 -->
    <div id="importBar" style="margin: 10px 0 18px 0; display: flex; flex-wrap: wrap; align-items: center; gap: 12px;">
      <label class="wrongbook-btn" style="background:#4facfe;cursor:pointer;">
        <i class="fas fa-file-import"></i> 导入题库
        <input type="file" id="importQbInput" accept=".json" style="display:none;">
      </label>
      <label class="wrongbook-btn" style="background:#e67e22;cursor:pointer;">
        <i class="fas fa-file-import"></i> 导入错题本
        <input type="file" id="importWrongInput" accept=".json" style="display:none;">
      </label>
      <label class="wrongbook-btn" style="background:#f39c12;cursor:pointer;">
        <i class="fas fa-file-import"></i> 导入收藏本
        <input type="file" id="importFavInput" accept=".json" style="display:none;">
      </label>
      <span id="importStatus" style="font-size:13px;color:#888;"></span>
    </div>
    <div id="modalOverlay"><div id="modalBox"></div></div>
    <!-- 题库元信息编辑弹窗 -->
    <div id="metaEditOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); z-index:99999; align-items:center; justify-content:center;">
      <div id="metaEditBox" style="background:#fff; color:#222; border-radius:12px; box-shadow:0 4px 24px rgba(0,0,0,0.18); padding:32px 28px; min-width:260px; max-width:90vw;">
        <h3 style="margin-bottom:18px;">编辑题库元信息</h3>
        <div style="margin-bottom:12px;">题库名：<span id="metaEditName"></span></div>
        <div style="margin-bottom:12px;">难度：<select id="metaEditLevel"><option value="">未知</option><option value="easy">简单</option><option value="medium">中等</option><option value="hard">困难</option></select></div>
        <div style="margin-bottom:12px;">标签：<input id="metaEditTags" style="width:70%;" placeholder="逗号分隔"></div>
        <div style="margin-bottom:12px;">上传者：<input id="metaEditUploader" style="width:70%;" placeholder="如张老师"></div>
        <button class="modal-btn" style="background:#27ae60;" onclick="saveMetaEdit()"><i class="fas fa-save"></i> 保存</button>
        <button class="modal-btn" style="background:#888; margin-left:12px;" onclick="closeMetaEdit()">取消</button>
        <div id="metaEditStatus" style="margin-top:16px; color:#006994;"></div>
      </div>
    </div>
    <!-- 题库内容预览弹窗 -->
    <div id="previewOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); z-index:99999; align-items:center; justify-content:center;">
      <div id="previewBox" style="background:#fff; color:#222; border-radius:12px; box-shadow:0 4px 24px rgba(0,0,0,0.18); padding:32px 28px; min-width:320px; max-width:96vw; max-height:90vh; overflow:auto;">
        <h3 style="margin-bottom:18px;">题库预览</h3>
        <div id="previewMeta" style="margin-bottom:12px;"></div>
        <div id="previewStats" style="margin-bottom:12px; color:#888;"></div>
        <div id="previewQuestions"></div>
        <button class="modal-btn" style="background:#888; margin-top:18px;" onclick="closePreview()">关闭</button>
      </div>
    </div>
    <!-- 多端同步设置区 -->
    <div id="syncBar" style="margin: 10px 0 18px 0; display: flex; flex-wrap: wrap; align-items: center; gap: 12px;">
      <label class="wrongbook-btn" style="background:#27ae60;cursor:pointer;">
        <i class="fas fa-sync"></i> 同步进度
        <input type="checkbox" id="syncEnable" style="margin-left:8px;vertical-align:middle;">
      </label>
      <span id="syncStatus" style="font-size:13px;color:#888;"></span>
    </div>
    <!-- 题库全文搜索区 -->
<div id="searchBar" style="margin: 10px 0 18px 0; display: flex; flex-wrap: wrap; align-items: center; gap: 12px;">
  <input id="searchInput" class="qb-select" style="min-width:180px;" placeholder="输入关键词搜索题目/解析...">
  <select id="searchCat" class="qb-select" style="min-width:90px;"><option value="">全部分类</option></select>
  <select id="searchLevel" class="qb-select" style="min-width:90px;"><option value="">全部难度</option><option value="easy">简单</option><option value="medium">中等</option><option value="hard">困难</option></select>
  <button class="wrongbook-btn" style="background:#4facfe;" onclick="searchQuestions()"><i class="fas fa-search"></i> 搜索</button>
  <span id="searchStatus" style="font-size:13px;color:#888;"></span>
</div>
<div id="searchResult" style="display:none; background:#f8f8fa; border-radius:10px; padding:18px 12px; margin-bottom:18px; max-height:60vh; overflow:auto;"></div>
        <!-- 题目容器 -->
        <div class="question-container">
            <div class="question-title" id="questionTitle">题目加载中...</div>
            <div class="question-options" id="questionOptions"></div>
            <div class="controls-bar">
                <button class="control-btn prev" id="prevBtn" onclick="prevQuestion()"><i class="fas fa-chevron-left"></i> 上一题</button>
                <button class="control-btn explain" id="explainBtn" onclick="toggleExplanation()"><i class="fas fa-lightbulb"></i> 查看解析</button>
                <button class="control-btn next" id="nextBtn" onclick="nextQuestion()">下一题 <i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="explanation-section" id="explanationSection"></div>
        </div>
    </div>
    <script>
        // 全屏模式管理
        let isFullscreen = false;

        function toggleFullscreen() {
            if (isFullscreen) {
                exitFullscreen();
            } else {
                enterFullscreen();
            }
        }

        function enterFullscreen() {
            document.body.classList.add('fullscreen-mode');
            document.getElementById('fullscreenToggle').innerHTML = '<i class="fas fa-compress"></i>';
            document.getElementById('fullscreenToggle').classList.add('exit');
            isFullscreen = true;
            
            // 尝试进入浏览器全屏
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(() => {});
            }
        }

        function exitFullscreen() {
            document.body.classList.remove('fullscreen-mode');
            document.getElementById('fullscreenToggle').innerHTML = '<i class="fas fa-expand"></i>';
            document.getElementById('fullscreenToggle').classList.remove('exit');
            isFullscreen = false;
            
            // 退出浏览器全屏
            if (document.exitFullscreen) {
                document.exitFullscreen().catch(() => {});
            }
        }

        // 更新进度条
        function updateProgress(current, total) {
            const percent = total ? Math.round((current + 1) / total * 100) : 0;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = `${current + 1} / ${total} (${percent}%)`;
        }

        // 全屏切换按钮事件
        document.getElementById('fullscreenToggle').addEventListener('click', toggleFullscreen);

        // 自动全屏设置
        function toggleAutoFullscreen() {
            const current = localStorage.getItem('auto_fullscreen') === 'true';
            const newValue = !current;
            localStorage.setItem('auto_fullscreen', newValue.toString());
            
            const btn = document.querySelector('.settings-btn');
            if (newValue) {
                btn.innerHTML = '<i class="fas fa-cog" style="color: #27ae60;"></i>';
                btn.title = '自动全屏已开启';
                showSuccess('自动全屏已开启');
            } else {
                btn.innerHTML = '<i class="fas fa-cog"></i>';
                btn.title = '自动全屏已关闭';
                showSuccess('自动全屏已关闭');
            }
        }

        // 初始化设置按钮状态
        function initSettingsButton() {
            const autoFullscreen = localStorage.getItem('auto_fullscreen') === 'true';
            const btn = document.querySelector('.settings-btn');
            if (autoFullscreen) {
                btn.innerHTML = '<i class="fas fa-cog" style="color: #27ae60;"></i>';
                btn.title = '自动全屏已开启';
            }
        }

        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            // F11 切换全屏
            if (e.key === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            }
            
            // ESC 退出全屏
            if (e.key === 'Escape' && isFullscreen) {
                exitFullscreen();
            }
        });

        // ====== 新增：分组入口自动加载 ======
(function() {
  function getQueryParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }
  const type = getQueryParam('type') || 'real';
  const bank = getQueryParam('bank');
  const mode = getQueryParam('mode') || 'order';
  const resume = getQueryParam('resume');
  if (!bank) return;
  // 在顶部显示当前模式和返回分组页按钮
  const modeMap = { order: '顺序练习', random: '随机练习', resume: '继续上次' };
  const modeColor = { order: '#4facfe', random: '#27ae60', resume: '#888' };
  const modeText = modeMap[mode] || '顺序练习';
  const modeBar = document.createElement('div');
  modeBar.style.textAlign = 'center';
  modeBar.style.fontSize = '1.18em';
  modeBar.style.fontWeight = '600';
  modeBar.style.margin = '18px 0 0 0';
  modeBar.style.color = modeColor[mode]||'#4facfe';
  modeBar.style.display = 'flex';
  modeBar.style.justifyContent = 'center';
  modeBar.style.alignItems = 'center';
  modeBar.innerHTML = `<span style='padding:6px 18px;border-radius:16px;background:${(modeColor[mode]||'#4facfe')}22;'><i class='fas fa-play-circle'></i> 当前模式：${modeText}</span><button style='margin-left:18px;padding:6px 18px;border-radius:16px;background:#eee;color:#333;font-size:0.98em;border:none;cursor:pointer;' onclick="window.location.href='practice-fullscreen.html?type=${type}'"><i class='fas fa-arrow-left'></i> 返回分组</button>`;
  document.body.insertBefore(modeBar, document.body.firstChild);
  // 做题进度条
  const progressBar = document.createElement('div');
  progressBar.id = 'practiceProgressBar';
  progressBar.style.width = '100%';
  progressBar.style.maxWidth = '900px';
  progressBar.style.margin = '10px auto 0 auto';
  progressBar.style.height = '18px';
  progressBar.style.background = '#f0f4fa';
  progressBar.style.borderRadius = '10px';
  progressBar.style.overflow = 'hidden';
  progressBar.innerHTML = `<div id='practiceProgressInner' style='height:100%;width:0;background:linear-gradient(90deg,#4facfe,#27ae60);border-radius:10px;transition:width 0.3s;'></div><div id='practiceProgressText' style='position:absolute;width:100%;text-align:center;line-height:18px;font-size:0.98em;color:#333;'></div>`;
  modeBar.insertAdjacentElement('afterend', progressBar);
  // 更新进度条函数
  window.updatePracticeProgress = function(cur, total) {
    const percent = total ? Math.round((cur+1)/total*100) : 0;
    document.getElementById('practiceProgressInner').style.width = percent+'%';
    document.getElementById('practiceProgressText').textContent = `进度：${cur+1} / ${total}（${percent}%）`;
    
    // 同时更新全屏进度条
    if (isFullscreen) {
      updateProgress(cur, total);
    }
  };
  if (bank) return; // 已选具体题库，走原有做题逻辑
  const groupMap = { real: '真题', chapter: '章节分类', wrong: '易错题' };
  const groupColor = { real: '#4facfe', chapter: '#27ae60', wrong: '#e67e22' };
  const groupIcon = {
    real: 'https://img.icons8.com/color/96/000000/test-passed.png',
    chapter: 'https://img.icons8.com/color/96/000000/open-book--v2.png',
    wrong: 'https://img.icons8.com/color/96/000000/error--v1.png'
  };
  document.title = (groupMap[type] || '题库') + ' - 流体力学学习平台';
  fetch('/question-banks/index.json').then(r=>r.json()).then(async index => {
    let files = index[type] || [];
    if (type === 'wrong' && files.length === 0) {
      document.body.innerHTML = '<div style="text-align:center;padding:60px 0;font-size:1.3em;color:#888;">暂无易错题数据</div>';
      return;
    }
    // 预加载所有题库元信息
    let metaList = [];
    let tagSet = new Set();
    for (const item of files) {
      const file = typeof item === 'string' ? item : item.file;
      const intro = typeof item === 'string' ? '' : (item.intro || '');
      let meta = { file, intro, count: 0, tags: [], preview: [] };
      try {
        const res = await fetch('/question-banks/' + file);
        const data = await res.json();
        const arr = Array.isArray(data) ? data : (data.questions||data.data||[]);
        meta.count = arr.length;
        meta.preview = arr.slice(0,3).map(q=>q.title||q.question||q.text||'').filter(Boolean);
        let tags = new Set();
        let years = new Set();
        arr.forEach(q => { if(q.tags) q.tags.forEach(t=>{tags.add(t);tagSet.add(t);}); if(q.year) years.add(q.year); });
        meta.tags = [...tags];
        if(years.size) meta.intro += (meta.intro ? ' ' : '') + [...years].sort().join(',')+'年';
        if(tags.size) meta.intro += (meta.intro ? ' | ' : '') + [...tags].slice(0,3).join('、');
      } catch {}
      metaList.push(meta);
    }
    // 搜索框
    const searchBar = document.createElement('div');
    searchBar.style.display = 'flex';
    searchBar.style.justifyContent = 'center';
    searchBar.style.margin = '0 0 18px 0';
    searchBar.innerHTML = `<input id='groupSearchInput' type='text' placeholder='搜索题库名称/简介/标签' style='width:320px;max-width:90vw;font-size:1.08em;padding:8px 16px;border-radius:8px;border:1.5px solid #e0e6ef;box-shadow:0 2px 8px rgba(80,120,255,0.06);outline:none;'>`;
    // 渲染排序和筛选控件
    const controls = document.createElement('div');
    controls.style.display = 'flex';
    controls.style.justifyContent = 'flex-end';
    controls.style.alignItems = 'center';
    controls.style.gap = '18px';
    controls.style.margin = '0 0 18px 0';
    controls.innerHTML = `
      <label style='font-size:1em;color:#555;'>排序：
        <select id='sortSelect' style='font-size:1em;padding:4px 10px;border-radius:6px;'>
          <option value='count'>题数最多优先</option>
          <option value='name'>名称排序</option>
        </select>
      </label>
      <label style='font-size:1em;color:#555;'>标签筛选：
        <select id='tagSelect' style='font-size:1em;padding:4px 10px;border-radius:6px;'>
          <option value=''>全部</option>
          ${[...tagSet].sort().map(t=>`<option value='${t}'>${t}</option>`).join('')}
        </select>
      </label>
    `;
    // 悬停预览浮层
    let previewLayer = null;
    function showPreview(card, meta) {
      if (window.innerWidth < 700) return; // 移动端不弹出
      if (previewLayer) previewLayer.remove();
      previewLayer = document.createElement('div');
      previewLayer.style.position = 'absolute';
      previewLayer.style.top = '16px';
      previewLayer.style.right = '-340px';
      previewLayer.style.width = '320px';
      previewLayer.style.background = '#fff';
      previewLayer.style.border = '1.5px solid #e0e6ef';
      previewLayer.style.borderRadius = '14px';
      previewLayer.style.boxShadow = '0 4px 24px rgba(80,120,255,0.13)';
      previewLayer.style.padding = '18px 18px 12px 18px';
      previewLayer.style.zIndex = 99;
      previewLayer.innerHTML = `<div style='font-size:1.08em;font-weight:600;color:#4facfe;margin-bottom:8px;'>题目预览</div><ul style='padding-left:18px;margin:0;'>${meta.preview.map(t=>`<li style='margin-bottom:6px;'>${t}</li>`).join('')}</ul>`;
      card.appendChild(previewLayer);
    }
    function hidePreview(card) {
      if (previewLayer) { previewLayer.remove(); previewLayer = null; }
    }
    // 渲染分组卡片函数
    function renderCards(list) {
      cardList.innerHTML = '';
      for (const meta of list) {
        const card = document.createElement('div');
        card.className = 'bank-card';
        card.style.background = '#fff';
        card.style.borderRadius = '18px';
        card.style.boxShadow = `0 4px 24px ${groupColor[type]||'rgba(0,0,0,0.10)'}`;
        card.style.width = '270px';
        card.style.textAlign = 'center';
        card.style.padding = '24px 18px 18px 18px';
        card.style.cursor = 'pointer';
        card.style.position = 'relative';
        card.style.overflow = 'hidden';
        card.style.transition = 'box-shadow 0.2s, transform 0.15s';
        card.innerHTML = `
          <img src='${groupIcon[type]||groupIcon.real}' alt='' style='width:68px;height:68px;object-fit:cover;border-radius:50%;margin-bottom:12px;box-shadow:0 2px 12px ${groupColor[type]||'#4facfe'}22;'>
          <div style='font-size:1.18em;font-weight:600;color:#2b3a55;margin-bottom:10px;'>${meta.file.replace(/(真题_|分类_|.json)/g,'')}</div>
          <div style='font-size:1em;color:#6a7ba2;margin-bottom:10px;'>${meta.intro}</div>
          <div style='font-size:0.98em;color:#888;margin-bottom:10px;'>题数：${meta.count}</div>
          <div style='background:#f8fafd;border-radius:10px;padding:10px 8px 6px 8px;min-height:48px;font-size:0.97em;color:#4facfe;'>
            <b>题目预览：</b><ul style='text-align:left;padding-left:18px;margin:0;'>${meta.preview.map(t=>`<li>${t}</li>`).join('')}</ul>
          </div>
          <div style='margin-top:14px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap;'>
            <button class='bank-card-btn' style='background:${groupColor[type]};padding:8px 18px;' onclick="event.stopPropagation();window.location.href='practice-fullscreen.html?type=${type}&bank=${encodeURIComponent(meta.file)}&mode=order'">顺序练习</button>
            <button class='bank-card-btn' style='background:linear-gradient(90deg,#27ae60,#4facfe);padding:8px 18px;' onclick="event.stopPropagation();window.location.href='practice-fullscreen.html?type=${type}&bank=${encodeURIComponent(meta.file)}&mode=random'">随机练习</button>
            <button class='bank-card-btn' style='background:#888;padding:8px 18px;' onclick="event.stopPropagation();continueLastPractice('${meta.file}')">继续上次</button>
          </div>
        `;
        card.onmouseenter = () => showPreview(card, meta);
        card.onmouseleave = () => hidePreview(card);
        card.ontouchstart = () => {};
        card.onclick = () => {
          localStorage.setItem('fullscreen_qb_value', meta.file.replace(/.json$/,''));
          window.location.href = `practice-fullscreen.html?type=${type}&bank=${encodeURIComponent(meta.file)}&mode=order`;
        };
        cardList.appendChild(card);
      }
    }
    // 继续上次练习逻辑
    window.continueLastPractice = function(file) {
      const key = 'fullscreen_progress_' + file.replace(/.json$/,'');
      const p = JSON.parse(localStorage.getItem(key)||'{}');
      if (typeof p.current === 'number') {
        window.location.href = `practice-fullscreen.html?type=${type}&bank=${encodeURIComponent(file)}&mode=order&resume=1`;
      } else {
        window.location.href = `practice-fullscreen.html?type=${type}&bank=${encodeURIComponent(file)}&mode=order`;
      }
    }
    // 排序和筛选逻辑
    function updateCards() {
      let list = metaList.slice();
      const sortVal = document.getElementById('sortSelect').value;
      const tagVal = document.getElementById('tagSelect').value;
      const searchVal = (document.getElementById('groupSearchInput')?.value||'').trim();
      if (tagVal) list = list.filter(meta => meta.tags.includes(tagVal));
      if (searchVal) {
        const kw = searchVal.toLowerCase();
        list = list.filter(meta =>
          meta.file.toLowerCase().includes(kw) ||
          (meta.intro && meta.intro.toLowerCase().includes(kw)) ||
          (meta.tags && meta.tags.some(t=>t.toLowerCase().includes(kw)))
        );
      }
      if (sortVal === 'count') list.sort((a,b)=>b.count-a.count);
      else if (sortVal === 'name') list.sort((a,b)=>a.file.localeCompare(b.file,'zh'));
      renderCards(list);
    }
    // 搜索事件
    setTimeout(()=>{
      const input = document.getElementById('groupSearchInput');
      if(input) input.oninput = updateCards;
    }, 100);
    controls.querySelector('#sortSelect').onchange = updateCards;
    controls.querySelector('#tagSelect').onchange = updateCards;
    // 页面结构
    const container = document.createElement('div');
    container.style.maxWidth = '900px';
    container.style.margin = '0 auto';
    container.style.padding = '32px 12px 24px 12px';
    container.innerHTML = `<div style='text-align:center;font-size:2em;font-weight:700;margin-bottom:18px;'>${groupMap[type]||'题库'}分组</div>`;
    container.appendChild(searchBar);
    container.appendChild(controls);
    const cardList = document.createElement('div');
    cardList.style.display = 'flex';
    cardList.style.flexWrap = 'wrap';
    cardList.style.justifyContent = 'center';
    cardList.style.gap = '32px';
    container.appendChild(cardList);
    document.body.innerHTML = '';
    document.body.appendChild(container);
    updateCards();
  });
})();
        // ====== 题库选择与错题本功能 ======
        let questions = [];
        let current = 0;
        let selected = null;
        let answered = false;
        let wrongBook = [];
        let favBook = JSON.parse(localStorage.getItem('fullscreen_favbook')||'[]');
        // 题库元信息结构扩展
        let qbList = [];
        const GITHUB_REPO = 'lghui12138/lghui12138.github.io';
        const GITHUB_QB_DIR = 'question-banks';
        const GITHUB_TOKEN_KEY = 'github_token';
        let showAllQb = false;
        function getGithubToken() { return localStorage.getItem(GITHUB_TOKEN_KEY) || ''; }
        // 修改 fetchGithubQuestionBanks 以本地聚合分类题库
        async function fetchGithubQuestionBanks() {
          // 远程+本地分类题库
          const url = `https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_QB_DIR}`;
          const urlHidden = `https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_QB_DIR}/hidden`;
          const token = getGithubToken();
          const headers = token ? { 'Authorization': `token ${token}` } : {};
          let files = [];
          try {
            const res = await fetch(url, {headers});
            if (res.ok) files = await res.json();
          } catch {}
          if (showAllQb) {
            try {
              const res2 = await fetch(urlHidden, {headers});
              if (res2.ok) {
                const hidden = await res2.json();
                files = files.concat(hidden.map(f=>({...f, hidden:true})));
              }
            } catch {}
          }
          // 本地分类题库聚合
          try {
            const localFiles = await fetch('/question-banks/').then(r=>r.text()).then(html=>{
              // 解析目录列表
              const matches = Array.from(html.matchAll(/href="([^"]+分类_[^"]+\.json)"/g));
              return matches.map(m=>({name:decodeURIComponent(m[1]), value:m[1].replace(/\.[^.]+$/, ''), url:'/question-banks/'+m[1], hidden:false}));
            });
            files = files.concat(localFiles);
          } catch {}
          return files.filter(f => /\.(json|csv)$/i.test(f.name)).map(f => ({
            name: f.name,
            value: f.name.replace(/\.[^.]+$/, ''),
            url: f.url,
            hidden: !!f.hidden || (f.path && f.path.includes('/hidden/'))
          }));
        }
        async function renderQBSelect() {
            // 拉取题库元信息
            qbList = await fetchGithubQuestionBanksWithMeta();
            // 筛选条件
            const tag = document.getElementById('qbTagFilter').value;
            const level = document.getElementById('qbLevelFilter').value;
            const uploader = document.getElementById('qbUploaderFilter').value;
            // 过滤
            let filtered = qbList.filter(qb => {
              let ok = true;
              if (tag && !(qb.tags||[]).includes(tag)) ok = false;
              if (level && qb.level !== level) ok = false;
              if (uploader && qb.uploader !== uploader) ok = false;
              return ok;
            });
            // 渲染下拉
            const sel = document.getElementById('qbSelect');
            sel.innerHTML = filtered.map(qb =>
              `<option value="${qb.name}">${qb.name}${qb.hidden?'（下架）':''}  [${qb.level||'未知'}]  ${qb.tags?.length?qb.tags.join(','):''}  ${qb.uploader?('by '+qb.uploader):''}</option>`
            ).join('');
            // 渲染筛选选项
            const tagSet = new Set(), uploaderSet = new Set();
            qbList.forEach(qb => {
              (qb.tags||[]).forEach(t=>tagSet.add(t));
              if(qb.uploader) uploaderSet.add(qb.uploader);
            });
            document.getElementById('qbTagFilter').innerHTML = '<option value="">全部标签</option>' + Array.from(tagSet).map(t=>`<option value="${t}">${t}</option>`).join('');
            document.getElementById('qbUploaderFilter').innerHTML = '<option value="">全部上传者</option>' + Array.from(uploaderSet).map(u=>`<option value="${u}">${u}</option>`).join('');
            const preset = localStorage.getItem('fullscreen_qb_value');
            if (preset) sel.value = preset;
            // 在 renderQBSelect 末尾添加年份聚合和下拉渲染
            const yearSel = document.getElementById('yearSelect');
            yearSel.innerHTML = '<option value="">全部年份</option>';
            if (filtered.length) {
              // 拉取题库内容，聚合所有年份
              fetch(filtered[0].url).then(r=>r.json()).then(data=>{
                if (!Array.isArray(data)) data = data.questions||data.data||[];
                const yearSet = new Set();
                data.forEach(q=>{ if(q.year) yearSet.add(q.year); });
                yearSel.innerHTML = '<option value="">全部年份</option>' + Array.from(yearSet).sort().map(y=>`<option value="${y}">${y}</option>`).join('');
              });
            }
            yearSel.onchange = function() {
              loadQuestionsByValue(document.getElementById('qbSelect').value);
            };
        }
        async function loadQuestionsByValue(val) {
            const qb = qbList.find(q => q.name === val);
            if (!qb) return;
            let data = await fetch(qb.url).then(r=>r.json());
            if (!Array.isArray(data)) data = data.questions||data.data||[];
            // 新增：如果有年份过滤，仅加载该年题目
            const year = localStorage.getItem('fullscreen_qb_year');
            if (year && year !== '易错') {
                data = data.filter(q => String(q.year) === String(year));
            }
            questions = data;
            current = 0;
            renderQuestion();
        }
        function loadWrongBook() {
            const wrong = JSON.parse(localStorage.getItem('fullscreen_wrongbook')||'[]');
            if (!wrong.length) { alert('暂无错题'); return; }
            questions = wrong; current = 0; selected = null; answered = false;
            renderQuestion();
        }
        function addToWrongBook(q, sel) {
            let wrong = JSON.parse(localStorage.getItem('fullscreen_wrongbook')||'[]');
            if (!wrong.some(item => item.title === q.title)) {
                wrong.push({...q, userSelected: sel});
                localStorage.setItem('fullscreen_wrongbook', JSON.stringify(wrong));
            }
        }
        function addToFavBook(q) {
            let fav = JSON.parse(localStorage.getItem('fullscreen_favbook')||'[]');
            if (!fav.some(item => item.title === q.title)) {
                fav.push({...q});
                localStorage.setItem('fullscreen_favbook', JSON.stringify(fav));
                favBook = fav;
                renderQuestion();
            }
        }
        function removeFromFavBook(q) {
            let fav = JSON.parse(localStorage.getItem('fullscreen_favbook')||'[]');
            fav = fav.filter(item => item.title !== q.title);
            localStorage.setItem('fullscreen_favbook', JSON.stringify(fav));
            favBook = fav;
            renderQuestion();
        }
        function isFaved(q) {
            return favBook.some(item => item.title === q.title);
        }
        // ====== 做题核心逻辑 ======
        function renderQuestion() {
            if (!questions.length) return;
            const q = questions[current];
            // 题目支持图片/公式/富文本
            document.getElementById('questionTitle').innerHTML = q.title;
            const opts = q.options.map((opt, i) => {
                let cls = 'option-btn';
                if (answered) {
                    if (i === q.answer) cls += ' correct';
                    else if (selected === i) cls += ' incorrect';
                } else if (selected === i) {
                    cls += ' selected';
                }
                // 选项支持图片/富文本
                return `<button class="${cls}" onclick="selectOption(${i})">${String.fromCharCode(65+i)}. ${opt}</button>`;
            }).join('');
            
            // 现代动态Web应用 - 使用DOM操作
            document.getElementById('questionOptions').innerHTML = opts;
            document.getElementById('questionProgress').innerHTML = `第${current+1}题 / 共${questions.length}题`;
            
            // 创建和插入操作按钮（使用DOM，不是innerHTML）
            createAndInsertActionButtons();
            
            // 收藏状态
            const favButton = document.getElementById('favBtn');
            const currentQ = questions[current];
            if (isFaved(currentQ)) {
                favButton.innerHTML = '<i class="fas fa-star"></i> 已收藏';
                favButton.className = 'btn-special faved';
            } else {
                favButton.innerHTML = '<i class="far fa-star"></i> 收藏';
                favButton.className = 'btn-special';
            }
            
            // 更新进度显示
            if (isFullscreen) {
                updateProgress(current, questions.length);
            } else {
                document.getElementById('fullscreenProgress').textContent = `第 ${current+1} / ${questions.length} 题`;
            }
            
            // 收藏按钮
            const favBtn = `<button class="fav-btn${isFaved(q)?' faved':''}" onclick="toggleFav()" title="收藏"><i class="fas fa-heart"></i></button>`;
            document.getElementById('questionTitle').insertAdjacentHTML('beforeend', favBtn);
            document.getElementById('explanationSection').classList.remove('active');
            document.getElementById('explanationSection').innerHTML = '';
            document.getElementById('explainBtn').disabled = !answered;
            renderStatBar();
            if (window.MathJax) MathJax.typesetPromise();
            
            // 更新新功能
            updateStats();
            updateQuestionNav();
            
            // 在renderQuestion()内调用updatePracticeProgress(current, questions.length);
            window.updatePracticeProgress(current, questions.length);
            
            // 根据模式调整显示
            if (currentMode === 'exam' && !answered) {
                // 考试模式：隐藏解析按钮
                document.getElementById('explainBtn').style.display = 'none';
            } else {
                document.getElementById('explainBtn').style.display = 'block';
            }
        }
        function selectOption(i) {
            if (answered) return;
            
            selected = i;
            console.log('✅ 选择选项:', i, 'selected现在=', selected);
            
            // 重新渲染以更新按钮状态
            renderQuestion();
        }
        
        // 终极简化提交函数
        function submitAnswer() {
            alert('submitAnswer函数被调用了！selected=' + selected + ', answered=' + answered);
            console.log('🔥 SUBMIT FUNCTION CALLED!', 'selected:', selected, 'answered:', answered);
            
            if (answered) {
                alert('您已经提交过答案了！');
                return false;
            }
            
            if (selected === null || selected === undefined) {
                alert('请先选择一个答案选项！');
                return false;
            }
            
            alert('开始提交流程...');
            console.log('✅ 开始提交...');
            
            // 直接复制submitCurrentAnswer的逻辑，避免调用问题
            try {
                answered = true;
                const questionTime = Math.floor((Date.now() - questionStartTime) / 1000);
                questionTimes.push(questionTime);
                
                const q = questions[current];
                q.userSelected = selected;
                
                renderQuestion();
                
                if (selected !== q.answer) {
                    addToWrongBook(q, selected);
                    if (typeof showSmartHint === 'function') {
                        showSmartHint('答错了，正在为您生成详细分析...');
                    }
                } else {
                    if (typeof showSmartHint === 'function') {
                        showSmartHint('答对了！正在为您生成学习建议...');
                    }
                }
                
                // 立即显示批改结果
                setTimeout(() => {
                    if (typeof toggleExplanation === 'function') {
                        toggleExplanation(true);
                    }
                }, 200);
                
                console.log('✅ 提交完成');
                alert('提交成功！');
                
            } catch (e) {
                console.error('提交出错:', e);
                alert('提交出错: ' + e.message);
            }
            
            return false;
        }
        
        // 确保全局可访问
        window.submitAnswer = submitAnswer;
        
        // 现代动态Web应用 - DOM操作版本
        function createAndInsertActionButtons() {
            // 移除现有的操作按钮
            const existingActions = document.querySelector('.question-actions-integrated');
            if (existingActions) {
                existingActions.remove();
            }
            
            const canSubmit = !answered && (selected !== null && selected !== undefined);
            
            // 创建容器
            const container = document.createElement('div');
            container.className = 'question-actions-integrated';
            container.style.cssText = `
                margin-top: 20px; 
                padding: 20px;
                background: linear-gradient(135deg, rgba(40, 167, 69, 0.05), rgba(0, 123, 255, 0.05));
                border-radius: 12px; 
                border: ${canSubmit ? '2px solid #28a745' : '2px solid #dee2e6'};
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
                box-shadow: ${canSubmit ? '0 0 20px rgba(40, 167, 69, 0.1)' : '0 2px 10px rgba(0,0,0,0.08)'};
            `;
            
            // 创建按钮行
            const buttonRow = document.createElement('div');
            buttonRow.style.cssText = `
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
                flex-wrap: wrap; 
                gap: 15px;
                position: relative;
                z-index: 2;
            `;
            
            // 主要按钮组
            const mainButtons = document.createElement('div');
            mainButtons.style.cssText = 'display: flex; gap: 12px; flex-wrap: wrap;';
            
            // 提交按钮
            const submitBtn = document.createElement('button');
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> 提交答案';
            submitBtn.style.cssText = `
                background: ${canSubmit ? 'linear-gradient(135deg, #28a745, #20c997)' : 'linear-gradient(135deg, #6c757d, #5a6268)'};
                color: white;
                border: none;
                padding: 16px 32px;
                border-radius: 10px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: ${canSubmit ? '0 4px 15px rgba(40, 167, 69, 0.3)' : '0 2px 8px rgba(108, 117, 125, 0.2)'};
                transition: all 0.3s ease;
                min-width: 150px;
                opacity: ${canSubmit ? '1' : '0.7'};
            `;
            
            // 提交按钮事件
            submitBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('🔥 DOM按钮被点击! selected:', selected, 'answered:', answered);
                
                if (answered) {
                    alert('您已经提交过答案了！');
                    return;
                }
                
                if (selected === null || selected === undefined) {
                    alert('请先选择一个答案选项！');
                    return;
                }
                
                // 立即处理提交
                answered = true;
                const questionTime = Math.floor((Date.now() - questionStartTime) / 1000);
                questionTimes.push(questionTime);
                
                const q = questions[current];
                q.userSelected = selected;
                
                // 重新渲染以显示结果
                renderQuestion();
                
                if (selected !== q.answer) {
                    addToWrongBook(q, selected);
                    if (typeof showSmartHint === 'function') {
                        showSmartHint('答错了，正在为您生成详细分析...');
                    }
                } else {
                    if (typeof showSmartHint === 'function') {
                        showSmartHint('答对了！正在为您生成学习建议...');
                    }
                }
                
                // 立即显示批改结果
                setTimeout(() => {
                    if (typeof toggleExplanation === 'function') {
                        console.log('🚀 显示批改结果');
                        toggleExplanation(true);
                    }
                }, 200);
                
                console.log('✅ 提交完成');
            });
            
            // 保存按钮
            const saveBtn = document.createElement('button');
            saveBtn.innerHTML = '<i class="fas fa-bookmark"></i> 保存进度';
            saveBtn.style.cssText = `
                background: linear-gradient(135deg, #007bff, #0056b3);
                color: white;
                border: none;
                padding: 16px 32px;
                border-radius: 10px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
                transition: all 0.3s ease;
                min-width: 150px;
            `;
            
            saveBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
                this.disabled = true;
                
                setTimeout(() => {
                    try {
                        localStorage.setItem('fullscreen_progress', JSON.stringify({
                            current: current,
                            selected: selected,
                            answered: answered,
                            questionTimes: questionTimes,
                            timestamp: Date.now()
                        }));
                        
                        this.innerHTML = '<i class="fas fa-check"></i> 已保存';
                        setTimeout(() => {
                            this.innerHTML = originalText;
                            this.disabled = false;
                        }, 1500);
                    } catch (e) {
                        this.innerHTML = originalText;
                        this.disabled = false;
                        alert('保存失败: ' + e.message);
                    }
                }, 500);
            });
            
            // 组装按钮
            mainButtons.appendChild(submitBtn);
            mainButtons.appendChild(saveBtn);
            buttonRow.appendChild(mainButtons);
            
            // 状态指示器
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = `
                margin-top: 15px; 
                text-align: center;
                padding: 10px;
                background: rgba(255,255,255,0.7);
                border-radius: 8px;
                font-size: 14px; 
                font-weight: 500;
                color: ${answered ? '#28a745' : (canSubmit ? '#007bff' : '#6c757d')};
                border-left: 4px solid ${answered ? '#28a745' : (canSubmit ? '#007bff' : '#6c757d')};
                transition: all 0.3s ease;
            `;
            
            const statusText = answered ? '✅ 已提交答案，查看下方分析结果' : 
                             (canSubmit ? '🎯 点击提交答案，立即获得批改结果' : '👆 请先选择一个选项');
            const statusIcon = answered ? 'fa-check-circle' : (canSubmit ? 'fa-hand-pointer' : 'fa-info-circle');
            
            statusDiv.innerHTML = `<i class="fas ${statusIcon}"></i> ${statusText}`;
            
            // 组装容器
            container.appendChild(buttonRow);
            container.appendChild(statusDiv);
            
            // 插入到页面中
            const optionsContainer = document.getElementById('questionOptions');
            optionsContainer.appendChild(container);
            
            console.log('✅ DOM按钮已创建和绑定', {canSubmit, selected, answered});
        }

        // 简化保存函数
        function saveCurrentProgress() {
            console.log('💾 保存进度');
            try {
                localStorage.setItem('fullscreen_progress', JSON.stringify({
                    current: current,
                    selected: selected,
                    answered: answered,
                    questionTimes: questionTimes,
                    timestamp: Date.now()
                }));
                console.log('✅ 保存成功');
                return true;
            } catch (e) {
                console.error('❌ 保存失败:', e);
                return false;
            }
        }
        
        // 确保全局可访问
        window.saveCurrentProgress = saveCurrentProgress;
        
        // 新增：提交当前答案 - 修复逻辑确保立即显示结果
        function submitCurrentAnswer() {
            console.log('提交答案尝试: answered=', answered, 'selected=', selected);
            
            // 严格检查提交条件
            if (answered) {
                console.log('已经提交过答案');
                return;
            }
            
            if (selected === null || selected === undefined) {
                console.log('未选择答案');
                alert('请先选择一个答案选项！');
                return;
            }
            
            // 记录答题时间
            const questionTime = Math.floor((Date.now() - questionStartTime) / 1000);
            questionTimes.push(questionTime);
            
            answered = true;
            
            // 记录用户选择的答案
            const q = questions[current];
            q.userSelected = selected;
            
            // 状态已在上面更新
            
            renderQuestion();
            
            if (selected !== q.answer) {
                addToWrongBook(q, selected);
                showSmartHint('答错了，正在为您生成详细分析...');
            } else {
                showSmartHint('答对了！正在为您生成学习建议...');
            }
            
            // 立即显示批改结果 - 确保用户能看到
            console.log('准备显示批改结果...');
            setTimeout(() => {
                console.log('显示批改结果和AI分析');
                toggleExplanation(true);
            }, 200);
            
            saveProgress();
            
            // 更新统计
            updateStats();
            
            // 更新学习进度
            updateLearningProgress();
            
            // 更新前沿功能
            updateAdaptiveDifficulty();
            updateEfficiencyMonitor();
            
            // 检查是否需要智能提醒
            checkSmartReminders();
            
            // 检查是否完成所有题目
            const answeredCount = questions.filter(q => typeof q.userSelected === 'number').length;
            if (answeredCount === questions.length) {
                setTimeout(() => {
                    showCompletionSummary();
                }, 1000);
            }
        }
        
        // 新增：跳过当前题目
        function skipCurrentQuestion() {
            if (current < questions.length - 1) {
                current++;
                selected = null;
                answered = false;
                questionStartTime = Date.now();
                renderQuestion();
                saveProgress();
                showSmartHint('已跳过，进入下一题');
            } else {
                showSmartHint('已经是最后一题了');
            }
        }
        
        // 新增：报告当前题目问题
        function reportCurrentQuestion() {
            const q = questions[current];
            const feedback = prompt('请描述您发现的问题：\n\n例如：\n- 题目描述不清楚\n- 答案有误\n- 选项重复\n- 其他问题');
            
            if (feedback && feedback.trim()) {
                // 保存反馈到本地存储
                const reports = JSON.parse(localStorage.getItem('questionReports') || '[]');
                reports.push({
                    questionId: q.id || current,
                    questionTitle: q.title,
                    feedback: feedback.trim(),
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent
                });
                localStorage.setItem('questionReports', JSON.stringify(reports));
                
                showSmartHint('感谢您的反馈，问题已记录！');
            }
        }
        function prevQuestion() { 
            if (current > 0) { 
                current--; 
                selected = null; 
                answered = false; 
                questionStartTime = Date.now();
                renderQuestion(); 
                saveProgress(); 
            } else {
                showSmartHint('已经是第一题了');
            }
        }
        function nextQuestion() { 
            if (current < questions.length-1) { 
                current++; 
                selected = null; 
                answered = false; 
                questionStartTime = Date.now();
                renderQuestion(); 
                saveProgress(); 
            } else {
                showSmartHint('已经是最后一题了');
            }
        }
        function toggleExplanation(forceShow) {
            const q = questions[current];
            const section = document.getElementById('explanationSection');
            if (!answered) return;
            if (forceShow || !section.classList.contains('active')) {
                // 大幅优化答案显示样式
                const isCorrect = selected === q.answer;
                const resultIcon = isCorrect ? '✅' : '❌';
                const resultText = isCorrect ? '回答正确！' : '回答错误';
                const resultColor = isCorrect ? '#28a745' : '#dc3545';
                
                section.innerHTML = `
                    <div style="
                        background: rgba(240,248,255,0.98); 
                        border: 3px solid #007bff; 
                        border-radius: 20px; 
                        padding: 45px; 
                        margin: 30px 0; 
                        min-height: 70vh; 
                        max-height: 85vh; 
                        overflow-y: auto;
                        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
                        backdrop-filter: blur(15px);
                    ">
                        <div style="color: #007bff; margin-bottom: 35px; font-size: 2.5em; font-weight: bold; text-align: center;">
                            <i class="fas fa-lightbulb"></i> 🎯 批改结果
                        </div>
                        
                        <div style="color: ${resultColor}; font-weight: bold; font-size: 2.8em; margin-bottom: 40px; text-align: center; padding: 35px; background: ${isCorrect ? '#d4edda' : '#f8d7da'}; border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
                            ${resultIcon} ${resultText}
                        </div>
                        
                        <div style="background: #fff3cd; border: 4px solid #ffeaa7; border-radius: 20px; padding: 40px; margin-bottom: 40px; font-size: 1.8em; line-height: 2.0;">
                            <strong style="font-size: 1.6em; color: #856404;">📝 参考答案：</strong><br><br>
                            <div style="background: white; padding: 35px; border-radius: 15px; border-left: 6px solid #ffc107; font-size: 1.7em; line-height: 2.2; color: #333; font-weight: 500;">
                                ${String.fromCharCode(65+q.answer)}
                            </div>
                        </div>
                        
                        <div style="background: #e7f3ff; border: 4px solid #b3d9ff; border-radius: 20px; padding: 40px; margin-bottom: 40px;">
                            <strong style="font-size: 1.8em; color: #0056b3;">💡 详细解释：</strong><br><br>
                            <div style="font-size: 1.6em; line-height: 2.2; color: #333;">${q.explanation || '暂无解析'}</div>
                        </div>
                        
                        <div id="aiAnalysisSection" style="margin-top: 30px;"></div>
                        
                        <div style="text-align: center; margin-top: 50px;">
                            <button onclick="nextQuestion()" style="
                                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                                color: white;
                                border: none;
                                padding: 22px 45px;
                                border-radius: 30px;
                                font-size: 1.6em;
                                cursor: pointer;
                                box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
                                transition: all 0.3s ease;
                                font-weight: bold;
                            " onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 30px rgba(79, 172, 254, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(79, 172, 254, 0.4)'">
                                继续下一题 →
                            </button>
                        </div>
                    </div>
                `;
                section.classList.add('active');
                
                // 添加AI智能分析
                generateAIAnalysis(q, isCorrect);
                
                if (window.MathJax) MathJax.typesetPromise([section]);
            } else {
                section.classList.remove('active');
                section.innerHTML = '';
            }
        }
        function toggleFav() {
            const q = questions[current];
            if (isFaved(q)) removeFromFavBook(q); else addToFavBook(q);
        }
        
        // AI智能分析功能
        function generateAIAnalysis(question, isCorrect) {
            setTimeout(async () => {
                try {
                    const aiSection = document.getElementById('aiAnalysisSection');
                    if (!aiSection) return;
                    
                    // 显示加载动画
                    aiSection.innerHTML = `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; padding: 40px; margin-top: 40px; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);">
                            <strong style="font-size: 1.8em;">🤖 AI智能分析：</strong><br><br>
                            <div style="text-align: center; padding: 30px;">
                                <div style="border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                                <div style="font-size: 1.2em;">正在分析中...</div>
                            </div>
                        </div>
                    `;
                    
                    // 模拟AI分析延迟
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    const analysis = await simulateAIAnalysis(question, isCorrect);
                    
                    aiSection.innerHTML = `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; padding: 40px; margin-top: 40px; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);">
                            <strong style="font-size: 1.8em;">🤖 AI智能分析：</strong><br><br>
                            <div style="font-size: 1.6em; line-height: 2.0; background: rgba(255,255,255,0.1); padding: 30px; border-radius: 15px; backdrop-filter: blur(10px);">
                                ${analysis}
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.warn('AI分析功能暂时不可用:', error);
                }
            }, 500);
        }
        
        // 模拟AI分析（实际项目中替换为真实AI API调用）
        function simulateAIAnalysis(question, isCorrect) {
            return new Promise((resolve) => {
                if (isCorrect) {
                    resolve(`
                        ✅ <strong>答题思路分析：</strong><br>
                        您的答题思路清晰正确，很好地掌握了相关知识点！这道题考查的是流体力学的基础概念，您能正确识别并选择答案。<br><br>
                        
                        📚 <strong>知识点掌握：</strong><br>
                        对这个知识点理解准确，体现了扎实的理论基础。建议继续保持这种学习状态，可以尝试做一些拓展练习。<br><br>
                        
                        🎯 <strong>学习建议：</strong><br>
                        您在这类题目上表现优秀，可以挑战更高难度的题目，或者尝试相关的综合应用题！ 💪<br><br>
                        
                        🌟 <strong>继续加油：</strong><br>
                        保持这种认真的学习态度，您一定能在考试中取得好成绩！ 😊
                    `);
                } else {
                    resolve(`
                        📝 <strong>答题思路分析：</strong><br>
                        这道题考查的是流体力学的核心概念，需要仔细理解题意和选项含义。您可能在某个关键知识点上有所混淆。<br><br>
                        
                        💡 <strong>改进建议：</strong><br>
                        建议复习相关理论基础，特别是要注意题目中的关键信息和专业术语。可以重新阅读教材相关章节。<br><br>
                        
                        📖 <strong>知识点拓展：</strong><br>
                        这类题目经常在考试中出现，建议多做类似的练习题，加强对核心概念的理解和记忆。<br><br>
                        
                        🌟 <strong>鼓励话语：</strong><br>
                        别气馁！错题是最好的学习机会，通过分析错误可以更深入地理解知识点。继续加油，您一定会进步的！ 😊
                    `);
                }
            });
        }
        function saveProgress() {
            localStorage.setItem('fullscreen_questions', JSON.stringify(questions));
            localStorage.setItem('fullscreen_progress', JSON.stringify({current, selected, answered}));
            showSmartHint('进度已保存 ✓');
        }
        function loadProgress() {
            const p = JSON.parse(localStorage.getItem('fullscreen_progress') || '{}');
            if (typeof p.current === 'number') current = p.current;
            if (typeof p.selected === 'number') selected = p.selected;
            if (typeof p.answered === 'boolean') answered = p.answered;
        }
        function renderStatBar() {
            // 答题统计
            const total = questions.length;
            const done = questions.filter((q, i) => i < current && typeof q.userSelected === 'number').length + (answered?1:0);
            const correct = questions.filter((q, i) => typeof q.userSelected === 'number' && q.userSelected === q.answer).length;
            const wrong = questions.filter((q, i) => typeof q.userSelected === 'number' && q.userSelected !== q.answer).length;
            document.getElementById('statBar').innerHTML = `
                <span class="stat-item"><i class="fas fa-list-ol"></i> 总题数: ${total}</span>
                <span class="stat-item"><i class="fas fa-check-circle"></i> 正确: ${correct}</span>
                <span class="stat-item"><i class="fas fa-times-circle"></i> 错误: ${wrong}</span>
                <span class="stat-item"><i class="fas fa-tasks"></i> 已做: ${done}</span>
            `;
        }
        function toggleNightMode() {
            document.body.classList.toggle('night');
        }
        function exportWrongBook() {
            const wrong = JSON.parse(localStorage.getItem('fullscreen_wrongbook')||'[]');
            if (!wrong.length) { alert('暂无错题'); return; }
            const blob = new Blob([JSON.stringify(wrong, null, 2)], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `错题本_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        function exportFavBook() {
            const fav = JSON.parse(localStorage.getItem('fullscreen_favbook')||'[]');
            if (!fav.length) { alert('暂无收藏'); return; }
            const blob = new Blob([JSON.stringify(fav, null, 2)], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `收藏本_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        function showQbManagePanel() {
            // 渲染多选题库列表
            let html = qbList.map((qb,i)=>
                `<label style='display:flex;align-items:center;margin-bottom:6px;'><input type='checkbox' class='qb-multi' value='${qb.name}' data-hidden='${qb.hidden?1:0}' style='margin-right:8px;'>${qb.name}${qb.hidden?'（下架）':''}  [${qb.level||'未知'}]  ${qb.tags?.length?qb.tags.join(','):''}  ${qb.uploader?('by '+qb.uploader):''} <button class='modal-btn' style='margin-left:8px;padding:2px 10px;font-size:0.95em;' onclick='openMetaEdit("${qb.name}")'><i class="fas fa-edit"></i> 编辑</button></label>`
            ).join('');
            document.getElementById('qbManageList').innerHTML = html;
            document.getElementById('qbManagePanel').style.display = 'block';
            document.getElementById('qbManageStatus').textContent = '';
        }
        function closeQbManagePanel() {
            document.getElementById('qbManagePanel').style.display = 'none';
            document.getElementById('renameQbInput').value = '';
            document.getElementById('qbManageStatus').textContent = '';
        }
        async function renameQb() {
            const newName = document.getElementById('renameQbInput').value;
            if (!newName) { alert('请输入新题库名'); return; }
            const sel = document.getElementById('qbSelect');
            const idx = sel.selectedIndex;
            if (idx < 0) return;
            const file = sel.options[idx].textContent.replace('（下架）','');
            const isHidden = /（下架）/.test(sel.options[idx].textContent);
            const token = localStorage.getItem('github_token');
            if (!token) { alert('请先设置GitHub Token'); return; }
            const url = `https://api.github.com/repos/lghui12138/lghui12138.github.io/contents/question-banks/${isHidden?'hidden/':''}${file}`;
            // 获取sha
            const res = await fetch(url, {headers:{'Authorization':`token ${token}`}});
            if (!res.ok) { document.getElementById('qbManageStatus').textContent = '获取文件信息失败'; return; }
            const info = await res.json();
            // 新路径
            const newPath = isHidden ? `question-banks/hidden/${newName}` : `question-banks/${newName}`;
            // 移动
            const mvRes = await fetch(url, {
                method:'PUT',
                headers:{'Authorization':`token ${token}`,'Content-Type':'application/json'},
                body:JSON.stringify({message:`重命名题库:${file}`,content:info.content,sha:info.sha,branch:'main',path:newPath})
            });
            if (mvRes.ok) {
                document.getElementById('qbManageStatus').textContent = '✅ 重命名成功';
                await renderQBSelect();
                closeQbManagePanel();
            } else {
                document.getElementById('qbManageStatus').textContent = '❌ 重命名失败';
            }
        }
        async function deleteQb() {
            const sel = document.getElementById('qbSelect');
            const idx = sel.selectedIndex;
            if (idx < 0) return;
            const file = sel.options[idx].textContent.replace('（下架）','');
            const isHidden = /（下架）/.test(sel.options[idx].textContent);
            const token = localStorage.getItem('github_token');
            if (!token) { alert('请先设置GitHub Token'); return; }
            const url = `https://api.github.com/repos/lghui12138/lghui12138.github.io/contents/question-banks/${isHidden?'hidden/':''}${file}`;
            // 获取sha
            const res = await fetch(url, {headers:{'Authorization':`token ${token}`}});
            if (!res.ok) { document.getElementById('qbManageStatus').textContent = '获取文件信息失败'; return; }
            const info = await res.json();
            // 删除
            const delRes = await fetch(url, {
                method:'DELETE',
                headers:{'Authorization':`token ${token}`}
            });
            if (delRes.ok) {
                document.getElementById('qbManageStatus').textContent = '✅ 删除成功';
                await renderQBSelect();
                closeQbManagePanel();
            } else {
                document.getElementById('qbManageStatus').textContent = '❌ 删除失败';
            }
        }
        async function toggleQbHidden() {
            const sel = document.getElementById('qbSelect');
            const idx = sel.selectedIndex;
            if (idx < 0) return;
            const file = sel.options[idx].textContent.replace('（下架）','');
            const isHidden = /（下架）/.test(sel.options[idx].textContent);
            const token = localStorage.getItem('github_token');
            if (!token) { alert('请先设置GitHub Token'); return; }
            const url = `https://api.github.com/repos/lghui12138/lghui12138.github.io/contents/question-banks/${isHidden?'hidden/':''}${file}`;
            // 获取sha
            const res = await fetch(url, {headers:{'Authorization':`token ${token}`}});
            if (!res.ok) { document.getElementById('qbManageStatus').textContent = '获取文件信息失败'; return; }
            const info = await res.json();
            // 新路径
            const newPath = isHidden ? `question-banks/${file}` : `question-banks/hidden/${file}`;
            // 移动
            const mvRes = await fetch(url, {
                method:'PUT',
                headers:{'Authorization':`token ${token}`,'Content-Type':'application/json'},
                body:JSON.stringify({message:`${isHidden?'恢复上架':'下架'}题库:${file}`,content:info.content,sha:info.sha,branch:'main',path:newPath})
            });
            if (mvRes.ok) {
                document.getElementById('qbManageStatus').textContent = isHidden?'✅ 恢复上架成功':'✅ 下架成功';
                await renderQBSelect();
                closeQbManagePanel();
            } else {
                document.getElementById('qbManageStatus').textContent = '❌ 操作失败';
            }
        }
        function toggleShowAllQb() {
            showAllQb = !showAllQb;
            document.getElementById('showAllQbBtn').textContent = showAllQb ? '仅显示上架' : '显示全部';
            renderQBSelect();
        }
        async function batchQbDelete() {
            const selected = Array.from(document.querySelectorAll('.qb-multi:checked'));
            if (!selected.length) { showError('请选择题库'); return; }
            showModal('确定要批量删除选中题库？',{buttons:[{text:'取消',onclick:'hideModal()'},{text:'确定',danger:true,onclick:'hideModal();batchQbDeleteDo();'}]});
        }
        async function batchQbDeleteDo() {
            const selected = Array.from(document.querySelectorAll('.qb-multi:checked'));
            const token = localStorage.getItem('github_token');
            if (!token) { showError('请先设置GitHub Token'); return; }
            let ok = 0, fail = 0;
            showLoading('正在删除...');
            for (let cb of selected) {
                const file = cb.value;
                const isHidden = cb.dataset.hidden==='1';
                const url = `https://api.github.com/repos/lghui12138/lghui12138.github.io/contents/question-banks/${isHidden?'hidden/':''}${file}`;
                const res = await fetch(url, {headers:{'Authorization':`token ${token}`}});
                if (!res.ok) { fail++; continue; }
                const info = await res.json();
                const delRes = await fetch(url, {
                    method:'DELETE',
                    headers:{'Authorization':`token ${token}`},
                    body:JSON.stringify({message:`批量删除题库:${file}`,sha:info.sha,branch:'main'})
                });
                if (delRes.ok) ok++; else fail++;
                showLoading(`正在删除... 成功:${ok} 失败:${fail}`);
            }
            if(ok) showSuccess(`批量删除完成！成功:${ok} 失败:${fail}`); else showError(`批量删除失败！成功:${ok} 失败:${fail}`);
            await renderQBSelect();
        }
        async function batchQbHidden() {
            const selected = Array.from(document.querySelectorAll('.qb-multi:checked'));
            if (!selected.length) { showError('请选择题库'); return; }
            showModal('确定要批量下架/上架选中题库？',{buttons:[{text:'取消',onclick:'hideModal()'},{text:'确定',danger:true,onclick:'hideModal();batchQbHiddenDo();'}]});
        }
        async function batchQbHiddenDo() {
            const selected = Array.from(document.querySelectorAll('.qb-multi:checked'));
            const token = localStorage.getItem('github_token');
            if (!token) { showError('请先设置GitHub Token'); return; }
            let ok = 0, fail = 0;
            showLoading('正在操作...');
            for (let cb of selected) {
                const file = cb.value;
                const isHidden = cb.dataset.hidden==='1';
                const url = `https://api.github.com/repos/lghui12138/lghui12138.github.io/contents/question-banks/${isHidden?'hidden/':''}${file}`;
                const res = await fetch(url, {headers:{'Authorization':`token ${token}`}});
                if (!res.ok) { fail++; continue; }
                const info = await res.json();
                const newPath = isHidden ? `question-banks/${file}` : `question-banks/hidden/${file}`;
                const mvRes = await fetch(url, {
                    method:'PUT',
                    headers:{'Authorization':`token ${token}`,'Content-Type':'application/json'},
                    body:JSON.stringify({message:`批量${isHidden?'上架':'下架'}题库:${file}`,content:info.content,sha:info.sha,branch:'main',path:newPath})
                });
                if (mvRes.ok) ok++; else fail++;
                showLoading(`正在操作... 成功:${ok} 失败:${fail}`);
            }
            if(ok) showSuccess(`批量下架/上架完成！成功:${ok} 失败:${fail}`); else showError(`批量操作失败！成功:${ok} 失败:${fail}`);
            await renderQBSelect();
        }
        // 监听筛选
        ['qbTagFilter','qbLevelFilter','qbUploaderFilter'].forEach(id=>{
          document.getElementById(id).addEventListener('change',renderQBSelect);
        });
        // 拉取题库元信息
        async function fetchGithubQuestionBanksWithMeta() {
          // 兼容原有fetchGithubQuestionBanks，假设文件名格式: name_level_tag1,tag2_uploader.json
          const list = await fetchGithubQuestionBanks();
          return list.map(qb=>{
            // 解析元信息
            let m = qb.name.match(/^(.+?)(?:_([a-z]+))?(?:_([\w,]+))?(?:_by([\w\u4e00-\u9fa5]+))?\.[a-z]+$/i);
            let tags = [], level = '', uploader = '';
            if(m){
              level = m[2]||'';
              tags = m[3]?m[3].split(','):[];
              uploader = m[4]||'';
            }
            return {...qb, level, tags, uploader};
          });
        }
        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') prevQuestion();
            if (e.key === 'ArrowRight') nextQuestion();
            if (e.key === 'Enter') { if (!answered) selectOption(selected??0); else nextQuestion(); }
            if (e.key >= '1' && e.key <= '4') selectOption(Number(e.key)-1);
            if (e.key === 'e' || e.key === 'E') toggleExplanation();
            if (e.key === 'f' || e.key === 'F') toggleFav();
            if (e.key === 'Escape') window.location.href = 'index-modular.html';
        });
        // 新增：做题时间计时器
        let startTime = Date.now();
        let timerInterval = null;
        let questionStartTime = Date.now();
        let questionTimes = [];

        function startTimer() {
            startTime = Date.now();
            questionStartTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timerText').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // 新增：做题统计
        function updateStats() {
            if (!questions.length) return;
            
            const total = questions.length;
            const answered = questions.filter(q => typeof q.userSelected === 'number').length;
            const correct = questions.filter(q => q.userSelected === q.answer).length;
            const accuracy = answered > 0 ? Math.round((correct / answered) * 100) : 0;
            
            // 计算平均用时
            const avgTime = questionTimes.length > 0 ? 
                Math.round(questionTimes.reduce((a, b) => a + b, 0) / questionTimes.length) : 0;
            
            document.getElementById('totalQuestions').textContent = total;
            document.getElementById('answeredQuestions').textContent = answered;
            document.getElementById('accuracyRate').textContent = `${accuracy}%`;
            document.getElementById('avgTime').textContent = `${avgTime}s`;
        }

        // 新增：题目导航
        function updateQuestionNav() {
            if (!questions.length) return;
            
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            questions.forEach((q, index) => {
                const item = document.createElement('button');
                item.className = 'nav-item';
                item.textContent = index + 1;
                
                if (index === current) {
                    item.classList.add('current');
                } else if (typeof q.userSelected === 'number') {
                    if (q.userSelected === q.answer) {
                        item.classList.add('answered');
                    } else {
                        item.classList.add('wrong');
                    }
                } else {
                    item.classList.add('unanswered');
                }
                
                item.onclick = () => {
                    current = index;
                    selected = null;
                    answered = false;
                    questionStartTime = Date.now();
                    renderQuestion();
                    updateQuestionNav();
                };
                
                nav.appendChild(item);
            });
        }

        // 新增：语音朗读功能
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;

        function speakText(text) {
            if (speechSynthesis) {
                // 停止当前朗读
                if (currentUtterance) {
                    speechSynthesis.cancel();
                }
                
                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtterance.lang = 'zh-CN';
                currentUtterance.rate = 0.8;
                currentUtterance.pitch = 1;
                
                currentUtterance.onstart = () => {
                    document.getElementById('voicePlayBtn').style.display = 'none';
                    document.getElementById('voiceStopBtn').style.display = 'block';
                };
                
                currentUtterance.onend = () => {
                    document.getElementById('voicePlayBtn').style.display = 'block';
                    document.getElementById('voiceStopBtn').style.display = 'none';
                    currentUtterance = null;
                };
                
                speechSynthesis.speak(currentUtterance);
            }
        }

        function stopSpeaking() {
            if (speechSynthesis) {
                speechSynthesis.cancel();
                document.getElementById('voicePlayBtn').style.display = 'block';
                document.getElementById('voiceStopBtn').style.display = 'none';
                currentUtterance = null;
            }
        }

        // 新增：智能提示系统
        function showSmartHint(message, duration = 3000) {
            const hint = document.getElementById('smartHint');
            hint.textContent = message;
            hint.style.display = 'block';
            
            setTimeout(() => {
                hint.style.display = 'none';
            }, duration);
        }

        // 新增：做题模式管理
        let currentMode = 'practice';
        
        function switchMode(mode) {
            currentMode = mode;
            
            // 更新模式按钮状态
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // 根据模式调整行为
            switch(mode) {
                case 'exam':
                    // 考试模式：隐藏答案，计时，不能返回
                    showSmartHint('考试模式：答案将在提交后显示');
                    break;
                case 'review':
                    // 复习模式：显示答案，可以查看解析
                    showSmartHint('复习模式：可以查看答案和解析');
                    break;
                default:
                    // 练习模式：正常做题
                    showSmartHint('练习模式：正常做题');
            }
        }

        // 新增：AI智能推荐系统
        function showAiRecommendation() {
            const aiPanel = document.getElementById('aiRecommendation');
            const aiContent = document.getElementById('aiContent');
            
            // 分析用户做题情况
            const total = questions.length;
            const answered = questions.filter(q => typeof q.userSelected === 'number').length;
            const correct = questions.filter(q => q.userSelected === q.answer).length;
            const accuracy = answered > 0 ? Math.round((correct / answered) * 100) : 0;
            const avgTime = questionTimes.length > 0 ? 
                Math.round(questionTimes.reduce((a, b) => a + b, 0) / questionTimes.length) : 0;
            
            let recommendation = '';
            
            if (answered === 0) {
                recommendation = '您还没有开始做题，建议先熟悉一下题目类型和难度。';
            } else if (accuracy < 60) {
                recommendation = `您的正确率较低（${accuracy}%），建议：<br>1. 仔细阅读题目和选项<br>2. 复习相关知识点<br>3. 多做同类型题目`;
            } else if (accuracy < 80) {
                recommendation = `您的正确率中等（${accuracy}%），建议：<br>1. 重点关注错题<br>2. 加强薄弱环节<br>3. 提高做题速度`;
            } else {
                recommendation = `您的正确率很高（${accuracy}%），建议：<br>1. 挑战更高难度题目<br>2. 提高做题效率<br>3. 帮助其他同学`;
            }
            
            if (avgTime > 60) {
                recommendation += '<br><br>⚠️ 您的平均用时较长，建议提高做题速度。';
            }
            
            aiContent.innerHTML = recommendation;
            aiPanel.classList.add('show');
        }
        
        function hideAiRecommendation() {
            document.getElementById('aiRecommendation').classList.remove('show');
        }
        
        function applyAiRecommendation() {
            hideAiRecommendation();
            showSmartHint('AI建议已应用，继续加油！');
        }
        
        // 新增：学习数据分析
        function showAnalytics() {
            const analyticsPanel = document.getElementById('analyticsPanel');
            const analyticsChart = document.getElementById('analyticsChart');
            const analyticsDetails = document.getElementById('analyticsDetails');
            
            // 生成图表数据
            const total = questions.length;
            const answered = questions.filter(q => typeof q.userSelected === 'number').length;
            const correct = questions.filter(q => q.userSelected === q.answer).length;
            const wrong = answered - correct;
            const unanswered = total - answered;
            
            // 创建柱状图
            const chartHTML = `
                <div style="display: flex; align-items: end; justify-content: space-around; height: 100%; padding: 20px;">
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div class="analytics-bar" style="height: ${(correct/total)*100}%; background: var(--success-color);" title="正确: ${correct}"></div>
                        <div style="margin-top: 5px; font-size: 0.8em; color: #666;">正确</div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div class="analytics-bar" style="height: ${(wrong/total)*100}%; background: var(--danger-color);" title="错误: ${wrong}"></div>
                        <div style="margin-top: 5px; font-size: 0.8em; color: #666;">错误</div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div class="analytics-bar" style="height: ${(unanswered/total)*100}%; background: var(--light-gray);" title="未答: ${unanswered}"></div>
                        <div style="margin-top: 5px; font-size: 0.8em; color: #666;">未答</div>
                    </div>
                </div>
            `;
            
            analyticsChart.innerHTML = chartHTML;
            
            // 生成详细分析
            const accuracy = answered > 0 ? Math.round((correct / answered) * 100) : 0;
            const avgTime = questionTimes.length > 0 ? 
                Math.round(questionTimes.reduce((a, b) => a + b, 0) / questionTimes.length) : 0;
            
            const detailsHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--primary-color);">${total}</div>
                        <div style="color: #666; font-size: 0.9em;">总题数</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--success-color);">${correct}</div>
                        <div style="color: #666; font-size: 0.9em;">答对题数</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--warning-color);">${accuracy}%</div>
                        <div style="color: #666; font-size: 0.9em;">正确率</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--info-color);">${avgTime}s</div>
                        <div style="color: #666; font-size: 0.9em;">平均用时</div>
                    </div>
                </div>
            `;
            
            analyticsDetails.innerHTML = detailsHTML;
            analyticsPanel.classList.add('show');
        }
        
        function hideAnalytics() {
            document.getElementById('analyticsPanel').classList.remove('show');
        }
        
        // 新增：社交分享功能
        function showSharePanel() {
            document.getElementById('sharePanel').classList.add('show');
        }
        
        function hideSharePanel() {
            document.getElementById('sharePanel').classList.remove('show');
        }
        
        function shareToWechat() {
            const shareData = generateShareData();
            showSmartHint('请使用微信扫描二维码分享');
            // 这里可以集成微信分享SDK
        }
        
        function shareToQQ() {
            const shareData = generateShareData();
            const url = `https://connect.qq.com/widget/shareqq/index.html?url=${encodeURIComponent(window.location.href)}&title=${encodeURIComponent(shareData.title)}&desc=${encodeURIComponent(shareData.desc)}`;
            window.open(url, '_blank');
        }
        
        function shareToWeibo() {
            const shareData = generateShareData();
            const url = `https://service.weibo.com/share/share.php?url=${encodeURIComponent(window.location.href)}&title=${encodeURIComponent(shareData.title)}`;
            window.open(url, '_blank');
        }
        
        function copyShareLink() {
            const shareData = generateShareData();
            const shareText = `${shareData.title}\n${shareData.desc}\n${window.location.href}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText).then(() => {
                    showSmartHint('分享链接已复制到剪贴板');
                });
            } else {
                // 兼容旧浏览器
                const textArea = document.createElement('textarea');
                textArea.value = shareText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSmartHint('分享链接已复制到剪贴板');
            }
        }
        
        function generateShareData() {
            const total = questions.length;
            const answered = questions.filter(q => typeof q.userSelected === 'number').length;
            const correct = questions.filter(q => q.userSelected === q.answer).length;
            const accuracy = answered > 0 ? Math.round((correct / answered) * 100) : 0;
            
            return {
                title: '我在流体力学题库完成了做题！',
                desc: `共${total}题，答对${correct}题，正确率${accuracy}%`
            };
        }
        
        // 新增：离线模式检测
        function checkOfflineStatus() {
            if (!navigator.onLine) {
                document.getElementById('offlineIndicator').classList.add('show');
                showSmartHint('当前处于离线模式，部分功能可能受限');
            } else {
                document.getElementById('offlineIndicator').classList.remove('show');
            }
        }
        
        // 新增：学习进度追踪
        function updateProgressTracker() {
            const today = new Date().toISOString().split('T')[0];
            const todayQuestions = parseInt(localStorage.getItem(`questions_${today}`) || '0');
            const streakDays = parseInt(localStorage.getItem('streak_days') || '0');
            const totalQuestionsDone = parseInt(localStorage.getItem('total_questions_done') || '0');
            
            document.getElementById('todayQuestions').textContent = todayQuestions;
            document.getElementById('streakDays').textContent = streakDays;
            document.getElementById('totalQuestionsDone').textContent = totalQuestionsDone;
            
            // 显示进度追踪器
            document.getElementById('progressTracker').classList.add('show');
        }
        
        // 新增：主题切换功能
        function initThemeSwitcher() {
            const currentTheme = localStorage.getItem('selected_theme') || 'default';
            applyTheme(currentTheme);
            
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.onclick = () => {
                    const theme = btn.dataset.theme;
                    applyTheme(theme);
                    
                    // 更新按钮状态
                    document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                };
            });
        }
        
        function applyTheme(theme) {
            localStorage.setItem('selected_theme', theme);
            
            // 移除所有主题类
            document.body.classList.remove('theme-default', 'theme-ocean', 'theme-sunset', 'theme-forest');
            
            // 应用新主题
            if (theme !== 'default') {
                document.body.classList.add(`theme-${theme}`);
            }
            
            // 更新CSS变量
            const themes = {
                ocean: { primary: '#667eea', secondary: '#764ba2' },
                sunset: { primary: '#f093fb', secondary: '#f5576c' },
                forest: { primary: '#4facfe', secondary: '#00f2fe' }
            };
            
            if (themes[theme]) {
                document.documentElement.style.setProperty('--primary-color', themes[theme].primary);
                document.documentElement.style.setProperty('--success-color', themes[theme].secondary);
            }
        }
        
        // 新增：学习进度更新
        function updateLearningProgress() {
            const today = new Date().toISOString().split('T')[0];
            
            // 更新今日做题数
            const todayQuestions = parseInt(localStorage.getItem(`questions_${today}`) || '0');
            localStorage.setItem(`questions_${today}`, todayQuestions + 1);
            
            // 更新总做题数
            const totalQuestionsDone = parseInt(localStorage.getItem('total_questions_done') || '0');
            localStorage.setItem('total_questions_done', totalQuestionsDone + 1);
            
            // 更新连续天数
            const lastStudyDate = localStorage.getItem('last_study_date');
            const streakDays = parseInt(localStorage.getItem('streak_days') || '0');
            
            if (lastStudyDate === today) {
                // 今天已经学习过，不更新连续天数
            } else if (lastStudyDate === getYesterdayDate()) {
                // 昨天学习过，连续天数+1
                localStorage.setItem('streak_days', streakDays + 1);
            } else {
                // 中断了，重置为1
                localStorage.setItem('streak_days', 1);
            }
            
            localStorage.setItem('last_study_date', today);
            
            // 更新显示
            updateProgressTracker();
        }
        
        function getYesterdayDate() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            return yesterday.toISOString().split('T')[0];
        }
        
        // 新增：机器学习预测系统
        function showMlPrediction() {
            const mlPanel = document.getElementById('mlPrediction');
            const predictionContent = document.getElementById('predictionContent');
            const predictionChart = document.getElementById('predictionChart');
            
            // 分析学习数据
            const total = questions.length;
            const answered = questions.filter(q => typeof q.userSelected === 'number').length;
            const correct = questions.filter(q => q.userSelected === q.answer).length;
            const accuracy = answered > 0 ? Math.round((correct / answered) * 100) : 0;
            const avgTime = questionTimes.length > 0 ? 
                Math.round(questionTimes.reduce((a, b) => a + b, 0) / questionTimes.length) : 0;
            
            // 生成预测内容
            let prediction = '';
            let predictedAccuracy = 0;
            
            if (answered < 5) {
                prediction = '数据不足，无法进行准确预测。建议继续做题以获得更多数据。';
                predictedAccuracy = 50;
            } else {
                // 简单的线性回归预测
                const recentAccuracy = calculateRecentAccuracy();
                const timeTrend = calculateTimeTrend();
                
                if (recentAccuracy > 80 && timeTrend < 0) {
                    prediction = '您的学习表现优秀！预测在接下来的题目中，正确率将保持在85%以上。';
                    predictedAccuracy = 85;
                } else if (recentAccuracy > 60) {
                    prediction = '您的学习表现良好，预测正确率将稳定在70-80%之间。';
                    predictedAccuracy = 75;
                } else {
                    prediction = '建议加强基础练习，预测正确率将逐步提升到65%左右。';
                    predictedAccuracy = 65;
                }
            }
            
            predictionContent.innerHTML = prediction;
            
            // 生成预测图表
            generatePredictionChart(predictionChart, accuracy, predictedAccuracy);
            
            mlPanel.classList.add('show');
        }
        
        function hideMlPrediction() {
            document.getElementById('mlPrediction').classList.remove('show');
        }
        
        function calculateRecentAccuracy() {
            const recentQuestions = questions.slice(-5);
            const recentAnswered = recentQuestions.filter(q => typeof q.userSelected === 'number');
            const recentCorrect = recentAnswered.filter(q => q.userSelected === q.answer);
            return recentAnswered.length > 0 ? Math.round((recentCorrect.length / recentAnswered.length) * 100) : 0;
        }
        
        function calculateTimeTrend() {
            if (questionTimes.length < 3) return 0;
            const recentTimes = questionTimes.slice(-3);
            const avgRecent = recentTimes.reduce((a, b) => a + b, 0) / recentTimes.length;
            const avgOverall = questionTimes.reduce((a, b) => a + b, 0) / questionTimes.length;
            return avgRecent - avgOverall;
        }
        
        function generatePredictionChart(chart, currentAccuracy, predictedAccuracy) {
            const width = chart.offsetWidth - 40;
            const height = chart.offsetHeight - 40;
            
            // 清除现有内容
            chart.innerHTML = '<div class="prediction-line"></div>';
            
            // 添加当前准确率点
            const currentPoint = document.createElement('div');
            currentPoint.className = 'prediction-point';
            currentPoint.style.left = '20px';
            currentPoint.style.bottom = `${20 + (currentAccuracy / 100) * (height - 40)}px`;
            currentPoint.title = `当前准确率: ${currentAccuracy}%`;
            chart.appendChild(currentPoint);
            
            // 添加预测准确率点
            const predictedPoint = document.createElement('div');
            predictedPoint.className = 'prediction-point';
            predictedPoint.style.left = `${width - 20}px`;
            predictedPoint.style.bottom = `${20 + (predictedAccuracy / 100) * (height - 40)}px`;
            predictedPoint.title = `预测准确率: ${predictedAccuracy}%`;
            predictedPoint.style.background = '#9b59b6';
            chart.appendChild(predictedPoint);
            
            // 添加趋势线
            const trendLine = document.createElement('div');
            trendLine.style.position = 'absolute';
            trendLine.style.left = '20px';
            trendLine.style.right = '20px';
            trendLine.style.bottom = `${20 + (currentAccuracy / 100) * (height - 40)}px`;
            trendLine.style.height = '2px';
            trendLine.style.background = 'linear-gradient(90deg, #4facfe, #9b59b6)';
            trendLine.style.transform = `rotate(${Math.atan2(predictedAccuracy - currentAccuracy, width - 40) * 180 / Math.PI}deg)`;
            chart.appendChild(trendLine);
        }
        
        // 新增：自适应难度系统
        function updateAdaptiveDifficulty() {
            const difficultyPanel = document.getElementById('adaptiveDifficulty');
            const difficultyFill = document.getElementById('difficultyFill');
            const difficultyLabel = document.getElementById('difficultyLabel');
            
            // 计算当前难度
            const accuracy = calculateRecentAccuracy();
            let difficulty = 50; // 默认中等难度
            let label = '中等';
            
            if (accuracy > 85) {
                difficulty = 80;
                label = '困难';
            } else if (accuracy > 70) {
                difficulty = 65;
                label = '中上';
            } else if (accuracy > 50) {
                difficulty = 50;
                label = '中等';
            } else if (accuracy > 30) {
                difficulty = 35;
                label = '中下';
            } else {
                difficulty = 20;
                label = '简单';
            }
            
            difficultyFill.style.width = `${difficulty}%`;
            difficultyLabel.textContent = label;
            
            // 显示难度面板
            difficultyPanel.classList.add('show');
            
            // 3秒后自动隐藏
            setTimeout(() => {
                difficultyPanel.classList.remove('show');
            }, 3000);
        }
        
        // 新增：学习路径规划
        function showLearningPath() {
            const pathPanel = document.getElementById('learningPath');
            const pathNodes = document.getElementById('pathNodes');
            
            // 生成学习路径
            const pathData = generateLearningPath();
            
            let pathHTML = '';
            pathData.forEach((node, index) => {
                const nodeClass = node.status === 'completed' ? 'completed' : 
                                node.status === 'current' ? 'current' : 'locked';
                const iconClass = node.status === 'completed' ? 'fas fa-check' :
                                node.status === 'current' ? 'fas fa-play' : 'fas fa-lock';
                
                pathHTML += `
                    <div class="path-node ${nodeClass}" onclick="selectPathNode(${index})">
                        <div class="path-node-icon">
                            <i class="${iconClass}"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333;">${node.title}</div>
                            <div style="font-size: 0.9em; color: #666;">${node.description}</div>
                        </div>
                    </div>
                `;
            });
            
            pathNodes.innerHTML = pathHTML;
            pathPanel.classList.add('show');
        }
        
        function hideLearningPath() {
            document.getElementById('learningPath').classList.remove('show');
        }
        
        function generateLearningPath() {
            const accuracy = calculateRecentAccuracy();
            const totalAnswered = questions.filter(q => typeof q.userSelected === 'number').length;
            
            return [
                {
                    title: '基础概念掌握',
                    description: '理解基本概念和公式',
                    status: totalAnswered > 0 ? 'completed' : 'current'
                },
                {
                    title: '计算能力训练',
                    description: '提高计算速度和准确性',
                    status: totalAnswered > 5 && accuracy > 60 ? 'completed' : 
                           totalAnswered > 5 ? 'current' : 'locked'
                },
                {
                    title: '综合应用能力',
                    description: '解决复杂实际问题',
                    status: totalAnswered > 10 && accuracy > 75 ? 'completed' : 
                           totalAnswered > 10 ? 'current' : 'locked'
                },
                {
                    title: '高级技巧掌握',
                    description: '掌握解题技巧和方法',
                    status: totalAnswered > 15 && accuracy > 85 ? 'completed' : 
                           totalAnswered > 15 ? 'current' : 'locked'
                },
                {
                    title: '实战模拟训练',
                    description: '模拟真实考试环境',
                    status: totalAnswered > 20 && accuracy > 90 ? 'completed' : 
                           totalAnswered > 20 ? 'current' : 'locked'
                }
            ];
        }
        
        function selectPathNode(index) {
            const pathData = generateLearningPath();
            const node = pathData[index];
            
            if (node.status === 'locked') {
                showSmartHint('请先完成前置学习任务');
                return;
            }
            
            showSmartHint(`正在切换到: ${node.title}`);
            // 这里可以添加具体的路径切换逻辑
        }
        
        // 新增：智能错题分析
        function showSmartErrorAnalysis() {
            const analysisPanel = document.getElementById('smartErrorAnalysis');
            const errorPatterns = document.getElementById('errorPatterns');
            
            // 分析错误模式
            const errorPatternsData = analyzeErrorPatterns();
            
            let patternsHTML = '';
            errorPatternsData.forEach(pattern => {
                patternsHTML += `
                    <div class="error-pattern">
                        <div class="pattern-title">${pattern.title}</div>
                        <div class="pattern-desc">${pattern.description}</div>
                        <div class="pattern-suggestion">建议: ${pattern.suggestion}</div>
                    </div>
                `;
            });
            
            if (patternsHTML === '') {
                patternsHTML = '<div style="text-align: center; color: #666; padding: 20px;">暂无错误模式分析</div>';
            }
            
            errorPatterns.innerHTML = patternsHTML;
            analysisPanel.classList.add('show');
        }
        
        function hideSmartErrorAnalysis() {
            document.getElementById('smartErrorAnalysis').classList.remove('show');
        }
        
        function analyzeErrorPatterns() {
            const wrongQuestions = questions.filter(q => 
                typeof q.userSelected === 'number' && q.userSelected !== q.answer
            );
            
            const patterns = [];
            
            if (wrongQuestions.length === 0) {
                return patterns;
            }
            
            // 分析常见错误模式
            const timeAnalysis = wrongQuestions.filter(q => {
                const index = questions.indexOf(q);
                return questionTimes[index] && questionTimes[index] < 30;
            });
            
            if (timeAnalysis.length > wrongQuestions.length * 0.5) {
                patterns.push({
                    title: '答题速度过快',
                    description: `有${timeAnalysis.length}道题答题时间过短，可能存在理解不充分的问题。`,
                    suggestion: '建议仔细阅读题目，充分理解后再作答。'
                });
            }
            
            const consecutiveErrors = findConsecutiveErrors();
            if (consecutiveErrors > 2) {
                patterns.push({
                    title: '连续错误',
                    description: `存在${consecutiveErrors}次连续错误，可能对某个知识点掌握不牢固。`,
                    suggestion: '建议重点复习相关知识点，加强基础练习。'
                });
            }
            
            return patterns;
        }
        
        function findConsecutiveErrors() {
            let maxConsecutive = 0;
            let currentConsecutive = 0;
            
            questions.forEach(q => {
                if (typeof q.userSelected === 'number') {
                    if (q.userSelected !== q.answer) {
                        currentConsecutive++;
                        maxConsecutive = Math.max(maxConsecutive, currentConsecutive);
                    } else {
                        currentConsecutive = 0;
                    }
                }
            });
            
            return maxConsecutive;
        }
        
        // 新增：学习效率监控
        function updateEfficiencyMonitor() {
            const efficiencyValue = document.getElementById('efficiencyValue');
            const focusValue = document.getElementById('focusValue');
            const comprehensionValue = document.getElementById('comprehensionValue');
            
            // 计算学习效率
            const accuracy = calculateRecentAccuracy();
            const avgTime = questionTimes.length > 0 ? 
                Math.round(questionTimes.reduce((a, b) => a + b, 0) / questionTimes.length) : 0;
            
            const efficiency = Math.min(100, Math.round(accuracy * 0.7 + (100 - avgTime) * 0.3));
            const focus = Math.min(100, Math.round(100 - (avgTime > 60 ? avgTime - 60 : 0)));
            const comprehension = Math.round(accuracy * 0.8 + (100 - avgTime) * 0.2);
            
            efficiencyValue.textContent = `${efficiency}%`;
            focusValue.textContent = `${focus}%`;
            comprehensionValue.textContent = `${comprehension}%`;
            
            // 显示效率监控面板
            document.getElementById('efficiencyMonitor').classList.add('show');
        }
        
        // 新增：智能提醒系统
        function showSmartReminder(message, type = 'info') {
            const reminderPanel = document.getElementById('smartReminder');
            const reminderContent = document.getElementById('reminderContent');
            
            reminderContent.textContent = message;
            reminderPanel.classList.add('show');
            
            // 5秒后自动隐藏
            setTimeout(() => {
                reminderPanel.classList.remove('show');
            }, 5000);
        }
        
        function dismissReminder() {
            document.getElementById('smartReminder').classList.remove('show');
        }
        
        function snoozeReminder() {
            document.getElementById('smartReminder').classList.remove('show');
            // 5分钟后再次提醒
            setTimeout(() => {
                showSmartReminder('休息时间结束，继续学习吧！');
            }, 300000);
        }
        
        // 新增：学习成就系统
        function showAchievementSystem() {
            const achievementPanel = document.getElementById('achievementSystem');
            const achievementItems = document.getElementById('achievementItems');
            
            // 生成成就列表
            const achievements = generateAchievements();
            
            let achievementsHTML = '';
            achievements.forEach(achievement => {
                const itemClass = achievement.unlocked ? 'unlocked' : 'locked';
                const iconClass = achievement.unlocked ? achievement.icon : 'fas fa-lock';
                
                achievementsHTML += `
                    <div class="achievement-item ${itemClass}">
                        <div class="achievement-icon">
                            <i class="${iconClass}"></i>
                        </div>
                        <div class="achievement-info">
                            <div class="achievement-title">${achievement.title}</div>
                            <div class="achievement-desc">${achievement.description}</div>
                            <div class="achievement-progress">${achievement.progress}</div>
                        </div>
                    </div>
                `;
            });
            
            achievementItems.innerHTML = achievementsHTML;
            achievementPanel.classList.add('show');
        }
        
        function hideAchievementSystem() {
            document.getElementById('achievementSystem').classList.remove('show');
        }
        
        function generateAchievements() {
            const totalAnswered = questions.filter(q => typeof q.userSelected === 'number').length;
            const totalCorrect = questions.filter(q => q.userSelected === q.answer).length;
            const accuracy = totalAnswered > 0 ? Math.round((totalCorrect / totalAnswered) * 100) : 0;
            const streakDays = parseInt(localStorage.getItem('streak_days') || '0');
            
            return [
                {
                    title: '初出茅庐',
                    description: '完成第一道题目',
                    icon: 'fas fa-star',
                    unlocked: totalAnswered >= 1,
                    progress: `${totalAnswered}/1`
                },
                {
                    title: '坚持不懈',
                    description: '连续学习7天',
                    icon: 'fas fa-calendar-check',
                    unlocked: streakDays >= 7,
                    progress: `${streakDays}/7天`
                },
                {
                    title: '准确射手',
                    description: '正确率达到80%',
                    icon: 'fas fa-bullseye',
                    unlocked: accuracy >= 80,
                    progress: `${accuracy}%/80%`
                },
                {
                    title: '速度之王',
                    description: '平均答题时间少于30秒',
                    icon: 'fas fa-tachometer-alt',
                    unlocked: questionTimes.length > 0 && 
                             questionTimes.reduce((a, b) => a + b, 0) / questionTimes.length < 30,
                    progress: questionTimes.length > 0 ? 
                             `${Math.round(questionTimes.reduce((a, b) => a + b, 0) / questionTimes.length)}s/30s` : '0s/30s'
                },
                {
                    title: '学习达人',
                    description: '完成100道题目',
                    icon: 'fas fa-crown',
                    unlocked: totalAnswered >= 100,
                    progress: `${totalAnswered}/100`
                }
            ];
        }
        
        // 新增：智能提醒检查
        function checkSmartReminders() {
            const totalAnswered = questions.filter(q => typeof q.userSelected === 'number').length;
            const accuracy = calculateRecentAccuracy();
            const avgTime = questionTimes.length > 0 ? 
                Math.round(questionTimes.reduce((a, b) => a + b, 0) / questionTimes.length) : 0;
            
            // 检查连续学习时间
            const studyTime = Math.floor((Date.now() - startTime) / 1000 / 60);
            if (studyTime >= 30 && studyTime % 30 === 0) {
                showSmartReminder('您已经连续学习30分钟，建议休息一下眼睛。');
            }
            
            // 检查答题速度
            if (avgTime < 15 && totalAnswered > 5) {
                showSmartReminder('您的答题速度很快，但建议仔细审题，确保理解充分。');
            }
            
            // 检查正确率
            if (accuracy < 50 && totalAnswered > 3) {
                showSmartReminder('正确率较低，建议复习相关知识点，提高答题质量。');
            }
            
            // 检查连续错误
            const consecutiveErrors = findConsecutiveErrors();
            if (consecutiveErrors >= 3) {
                showSmartReminder('连续答错多题，建议暂停一下，重新梳理思路。');
            }
            
            // 检查学习效率
            const efficiency = Math.min(100, Math.round(accuracy * 0.7 + (100 - avgTime) * 0.3));
            if (efficiency < 60 && totalAnswered > 5) {
                showSmartReminder('学习效率较低，建议调整学习方法，提高专注度。');
            }
        }
        
        // 新增：做题完成总结
        function showCompletionSummary() {
            const total = questions.length;
            const answered = questions.filter(q => typeof q.userSelected === 'number').length;
            const correct = questions.filter(q => q.userSelected === q.answer).length;
            const accuracy = answered > 0 ? Math.round((correct / answered) * 100) : 0;
            const totalTime = Math.floor((Date.now() - startTime) / 1000);
            const avgTime = questionTimes.length > 0 ? 
                Math.round(questionTimes.reduce((a, b) => a + b, 0) / questionTimes.length) : 0;
            
            const summary = `
                <div style="text-align:center; padding:20px;">
                    <h2 style="color:var(--primary-color); margin-bottom:20px;">
                        <i class="fas fa-trophy"></i> 做题完成！
                    </h2>
                    <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:20px;">
                        <div style="background:#f8f9fa; padding:15px; border-radius:10px;">
                            <div style="font-size:2em; color:var(--primary-color); font-weight:bold;">${total}</div>
                            <div style="color:#666;">总题数</div>
                        </div>
                        <div style="background:#f8f9fa; padding:15px; border-radius:10px;">
                            <div style="font-size:2em; color:var(--success-color); font-weight:bold;">${correct}</div>
                            <div style="color:#666;">答对题数</div>
                        </div>
                        <div style="background:#f8f9fa; padding:15px; border-radius:10px;">
                            <div style="font-size:2em; color:var(--warning-color); font-weight:bold;">${accuracy}%</div>
                            <div style="color:#666;">正确率</div>
                        </div>
                        <div style="background:#f8f9fa; padding:15px; border-radius:10px;">
                            <div style="font-size:2em; color:var(--danger-color); font-weight:bold;">${Math.floor(totalTime/60)}:${(totalTime%60).toString().padStart(2,'0')}</div>
                            <div style="color:#666;">总用时</div>
                        </div>
                    </div>
                    <div style="margin-top:20px;">
                        <button onclick="exportResults()" style="background:var(--primary-color); color:white; border:none; padding:10px 20px; border-radius:8px; margin:5px;">
                            <i class="fas fa-download"></i> 导出结果
                        </button>
                        <button onclick="restartPractice()" style="background:var(--success-color); color:white; border:none; padding:10px 20px; border-radius:8px; margin:5px;">
                            <i class="fas fa-redo"></i> 重新开始
                        </button>
                        <button onclick="closeSummary()" style="background:#666; color:white; border:none; padding:10px 20px; border-radius:8px; margin:5px;">
                            <i class="fas fa-times"></i> 关闭
                        </button>
                    </div>
                </div>
            `;
            
            showModal(summary);
        }

        function exportResults() {
            const total = questions.length;
            const answered = questions.filter(q => typeof q.userSelected === 'number').length;
            const correct = questions.filter(q => q.userSelected === q.answer).length;
            const accuracy = answered > 0 ? Math.round((correct / answered) * 100) : 0;
            const totalTime = Math.floor((Date.now() - startTime) / 1000);
            
            const results = {
                timestamp: new Date().toISOString(),
                totalQuestions: total,
                answeredQuestions: answered,
                correctAnswers: correct,
                accuracy: accuracy,
                totalTime: totalTime,
                averageTime: questionTimes.length > 0 ? 
                    Math.round(questionTimes.reduce((a, b) => a + b, 0) / questionTimes.length) : 0,
                questions: questions.map((q, i) => ({
                    index: i + 1,
                    title: q.title,
                    userAnswer: q.userSelected,
                    correctAnswer: q.answer,
                    isCorrect: q.userSelected === q.answer,
                    timeSpent: questionTimes[i] || 0
                }))
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `做题结果_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showSuccess('结果已导出');
        }

        function restartPractice() {
            current = 0;
            selected = null;
            answered = false;
            questionTimes = [];
            startTime = Date.now();
            questionStartTime = Date.now();
            questions.forEach(q => delete q.userSelected);
            renderQuestion();
            updateStats();
            updateQuestionNav();
            hideModal();
            showSuccess('已重新开始');
        }

        function closeSummary() {
            hideModal();
        }

        // 新增：手势操作支持
        let touchStartX = 0;
        let touchStartY = 0;
        let lastTapTime = 0;

        function handleTouchStart(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }

        function handleTouchEnd(e) {
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            
            // 检测滑动
            if (Math.abs(deltaX) > 50 && Math.abs(deltaY) < 100) {
                if (deltaX > 0) {
                    // 向右滑动，上一题
                    prevQuestion();
                } else {
                    // 向左滑动，下一题
                    nextQuestion();
                }
            }
            
            // 检测双击
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTapTime;
            if (tapLength < 500 && tapLength > 0) {
                // 双击显示解析
                toggleExplanation(true);
            }
            lastTapTime = currentTime;
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', async function() {
            await renderQBSelect();
            loadProgress();
            await loadQuestions();
            if (isTeacher()) {
                document.getElementById('qbManageBtn').style.display = 'inline-block';
                document.getElementById('showAllQbBtn').style.display = 'inline-block';
            }
            
            // 初始化设置按钮
            initSettingsButton();
            
            // 初始化新功能
            updateStats();
            updateQuestionNav();
            updateProgressTracker();
            initThemeSwitcher();
            updateEfficiencyMonitor();
            
            // 绑定语音控制事件
            document.getElementById('voicePlayBtn').onclick = () => {
                const q = questions[current];
                if (q) {
                    speakText(q.title);
                }
            };
            
            document.getElementById('voiceStopBtn').onclick = stopSpeaking;
            
            // 绑定模式切换事件
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.onclick = () => switchMode(btn.dataset.mode);
            });
            
            // 绑定手势事件
            document.addEventListener('touchstart', handleTouchStart);
            document.addEventListener('touchend', handleTouchEnd);
            
            // 绑定网络状态检测
            window.addEventListener('online', checkOfflineStatus);
            window.addEventListener('offline', checkOfflineStatus);
            checkOfflineStatus();
            
            // 开始计时器
            startTimer();
            
            // 检查是否应该自动进入全屏模式
            const autoFullscreen = localStorage.getItem('auto_fullscreen') === 'true';
            if (autoFullscreen && questions.length > 0) {
                setTimeout(() => {
                    enterFullscreen();
                }, 1000);
            }
            
            // 显示欢迎提示
            setTimeout(() => {
                showSmartHint('欢迎使用智能做题系统！点击右上角按钮体验更多功能');
            }, 2000);
        });
        function showModal(msg, opts={}){
          const overlay = document.getElementById('modalOverlay');
          const box = document.getElementById('modalBox');
          box.innerHTML = `<div style='font-size:1.15rem;'>${msg}</div>` + (opts.buttons?opts.buttons.map(btn=>`<button class='modal-btn${btn.danger?' danger':''}' onclick='${btn.onclick}'>${btn.text}</button>`).join(''):'');
          overlay.style.display = 'flex';
          overlay.onclick = e=>{ if(e.target===overlay) overlay.style.display='none'; };
        }
        function hideModal(){ document.getElementById('modalOverlay').style.display='none'; }
        function showLoading(msg){ showModal(`<span class='loading-spinner'></span>${msg}`); }
        function showSuccess(msg){ showModal(`<span style='color:#27ae60;font-size:1.5em;'>✔</span><br>${msg}`); setTimeout(hideModal,1200); }
        function showError(msg){ showModal(`<span style='color:#e74c3c;font-size:1.5em;'>✖</span><br>${msg}`); setTimeout(hideModal,1800); }

        // 批量删除/下架/上架增加二次确认和动画
        async function batchQbDelete() {
          const selected = Array.from(document.querySelectorAll('.qb-multi:checked'));
          if (!selected.length) { showError('请选择题库'); return; }
          showModal('确定要批量删除选中题库？',{buttons:[{text:'取消',onclick:'hideModal()'},{text:'确定',danger:true,onclick:'hideModal();batchQbDeleteDo();'}]});
        }
        async function batchQbDeleteDo() {
          const selected = Array.from(document.querySelectorAll('.qb-multi:checked'));
          const token = localStorage.getItem('github_token');
          if (!token) { showError('请先设置GitHub Token'); return; }
          let ok = 0, fail = 0;
          showLoading('正在删除...');
          for (let cb of selected) {
            const file = cb.value;
            const isHidden = cb.dataset.hidden==='1';
            const url = `https://api.github.com/repos/lghui12138/lghui12138.github.io/contents/question-banks/${isHidden?'hidden/':''}${file}`;
            const res = await fetch(url, {headers:{'Authorization':`token ${token}`}});
            if (!res.ok) { fail++; continue; }
            const info = await res.json();
            const delRes = await fetch(url, {
              method:'DELETE',
              headers:{'Authorization':`token ${token}`},
              body:JSON.stringify({message:`批量删除题库:${file}`,sha:info.sha,branch:'main'})
            });
            if (delRes.ok) ok++; else fail++;
            showLoading(`正在删除... 成功:${ok} 失败:${fail}`);
          }
          if(ok) showSuccess(`批量删除完成！成功:${ok} 失败:${fail}`); else showError(`批量删除失败！成功:${ok} 失败:${fail}`);
          await renderQBSelect();
        }
        async function batchQbHidden() {
          const selected = Array.from(document.querySelectorAll('.qb-multi:checked'));
          if (!selected.length) { showError('请选择题库'); return; }
          showModal('确定要批量下架/上架选中题库？',{buttons:[{text:'取消',onclick:'hideModal()'},{text:'确定',danger:true,onclick:'hideModal();batchQbHiddenDo();'}]});
        }
        async function batchQbHiddenDo() {
          const selected = Array.from(document.querySelectorAll('.qb-multi:checked'));
          const token = localStorage.getItem('github_token');
          if (!token) { showError('请先设置GitHub Token'); return; }
          let ok = 0, fail = 0;
          showLoading('正在操作...');
          for (let cb of selected) {
            const file = cb.value;
            const isHidden = cb.dataset.hidden==='1';
            const url = `https://api.github.com/repos/lghui12138/lghui12138.github.io/contents/question-banks/${isHidden?'hidden/':''}${file}`;
            const res = await fetch(url, {headers:{'Authorization':`token ${token}`}});
            if (!res.ok) { fail++; continue; }
            const info = await res.json();
            const newPath = isHidden ? `question-banks/${file}` : `question-banks/hidden/${file}`;
            const mvRes = await fetch(url, {
              method:'PUT',
              headers:{'Authorization':`token ${token}`,'Content-Type':'application/json'},
              body:JSON.stringify({message:`批量${isHidden?'上架':'下架'}题库:${file}`,content:info.content,sha:info.sha,branch:'main',path:newPath})
            });
            if (mvRes.ok) ok++; else fail++;
            showLoading(`正在操作... 成功:${ok} 失败:${fail}`);
          }
          if(ok) showSuccess(`批量下架/上架完成！成功:${ok} 失败:${fail}`); else showError(`批量操作失败！成功:${ok} 失败:${fail}`);
          await renderQBSelect();
        }
        // 导入操作动画
        if(importQbInput){
          importQbInput.addEventListener('change',async function(e){
            const file = e.target.files[0];
            if(!file) return;
            try{
              const text = await file.text();
              const data = JSON.parse(text);
              if(isTeacher()){
                const token = localStorage.getItem('github_token');
                if(!token){showError('请先设置GitHub Token');return;}
                const now = new Date();
                const fileName = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${file.name}`;
                const path = `question-banks/${fileName}`;
                const url = `https://api.github.com/repos/lghui12138/lghui12138.github.io/contents/${path}`;
                const base64Content = btoa(unescape(encodeURIComponent(text)));
                const body = {
                  message: `导入题库: ${file.name}`,
                  content: base64Content,
                  branch: 'main',
                  committer: { name: 'TeacherUploader', email: 'teacher@example.com' }
                };
                showLoading('正在上传到GitHub...');
                const res = await fetch(url, {
                  method: 'PUT',
                  headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                  body: JSON.stringify(body)
                });
                if (!res.ok) {
                  const err = await res.text();
                  showError('上传失败: ' + err);
                  return;
                }
                showSuccess('题库导入并上传成功！');
                await renderQBSelect();
              }else{
                localStorage.setItem('fullscreen_local_qb',text);
                showSuccess('题库已导入本地（仅本地可见）');
                await renderQBSelect();
              }
            }catch(e){
              showError('题库导入失败: '+e.message);
            }
          });
        }
        if(importWrongInput){
          importWrongInput.addEventListener('change',async function(e){
            const file = e.target.files[0];
            if(!file) return;
            try{
              const text = await file.text();
              const data = JSON.parse(text);
              if(Array.isArray(data)){
                let old = JSON.parse(localStorage.getItem('fullscreen_wrongbook')||'[]');
                let merged = [...old,...data].filter((q,i,arr)=>arr.findIndex(x=>x.id===q.id)===i);
                localStorage.setItem('fullscreen_wrongbook',JSON.stringify(merged));
                showSuccess('错题本导入成功（自动合并去重）');
              }else{
                showError('格式错误');
              }
            }catch(e){
              showError('错题本导入失败: '+e.message);
            }
          });
        }
        if(importFavInput){
          importFavInput.addEventListener('change',async function(e){
            const file = e.target.files[0];
            if(!file) return;
            try{
              const text = await file.text();
              const data = JSON.parse(text);
              if(Array.isArray(data)){
                let old = JSON.parse(localStorage.getItem('fullscreen_favbook')||'[]');
                let merged = [...old,...data].filter((q,i,arr)=>arr.findIndex(x=>x.id===q.id)===i);
                localStorage.setItem('fullscreen_favbook',JSON.stringify(merged));
                showSuccess('收藏本导入成功（自动合并去重）');
              }else{
                showError('格式错误');
              }
            }catch(e){
              showError('收藏本导入失败: '+e.message);
            }
          });
        }
        let metaEditQb = null;
        function openMetaEdit(qbName) {
          metaEditQb = qbList.find(q=>q.name===qbName);
          if(!metaEditQb) return;
          document.getElementById('metaEditName').textContent = metaEditQb.name;
          document.getElementById('metaEditLevel').value = metaEditQb.level||'';
          document.getElementById('metaEditTags').value = (metaEditQb.tags||[]).join(',');
          document.getElementById('metaEditUploader').value = metaEditQb.uploader||'';
          document.getElementById('metaEditStatus').textContent = '';
          document.getElementById('metaEditOverlay').style.display = 'flex';
        }
        function closeMetaEdit(){ document.getElementById('metaEditOverlay').style.display='none'; }
        async function saveMetaEdit(){
          if(!metaEditQb) return;
          const level = document.getElementById('metaEditLevel').value;
          const tags = document.getElementById('metaEditTags').value.split(',').map(t=>t.trim()).filter(Boolean);
          const uploader = document.getElementById('metaEditUploader').value.trim();
          // 新文件名
          let base = metaEditQb.name.replace(/(_[a-z]+)?(_[\w,]+)?(_by[\w\u4e00-\u9fa5]+)?\.[a-z]+$/i,'');
          let ext = metaEditQb.name.replace(/^.+(\.[a-z]+)$/i,'$1');
          let newName = base;
          if(level) newName += '_'+level;
          if(tags.length) newName += '_'+tags.join(',');
          if(uploader) newName += '_by'+uploader;
          newName += ext;
          if(newName===metaEditQb.name){ document.getElementById('metaEditStatus').textContent='未修改'; return; }
          // GitHub移动
          const token = localStorage.getItem('github_token');
          if(!token){ document.getElementById('metaEditStatus').textContent='❌ 请先设置GitHub Token'; return; }
          const url = `https://api.github.com/repos/lghui12138/lghui12138.github.io/contents/question-banks/${metaEditQb.hidden?'hidden/':''}${metaEditQb.name}`;
          const newPath = `question-banks/${metaEditQb.hidden?'hidden/':''}${newName}`;
          document.getElementById('metaEditStatus').innerHTML = '<span class="loading-spinner"></span>正在保存...';
          // 获取sha和内容
          const res = await fetch(url, {headers:{'Authorization':`token ${token}`}});
          if(!res.ok){ document.getElementById('metaEditStatus').textContent='❌ 获取文件信息失败'; return; }
          const info = await res.json();
          // 移动
          const mvRes = await fetch(url, {
            method:'PUT',
            headers:{'Authorization':`token ${token}`,'Content-Type':'application/json'},
            body:JSON.stringify({message:`编辑元信息重命名:${metaEditQb.name}→${newName}`,content:info.content,sha:info.sha,branch:'main',path:newPath})
          });
          if(mvRes.ok){
            document.getElementById('metaEditStatus').textContent='✅ 保存成功';
            setTimeout(()=>{closeMetaEdit();renderQBSelect();},1000);
          }else{
            document.getElementById('metaEditStatus').textContent='❌ 保存失败';
          }
        }
        function closePreview(){ document.getElementById('previewOverlay').style.display='none'; }
        async function openPreview(qbName){
          const qb = qbList.find(q=>q.name===qbName);
          if(!qb) return;
          document.getElementById('previewMeta').innerHTML = `<b>${qb.name}</b>  [${qb.level||'未知'}]  ${qb.tags?.length?qb.tags.join(','):''}  ${qb.uploader?('by '+qb.uploader):''}`;
          document.getElementById('previewStats').innerHTML = '<span class="loading-spinner"></span> 正在加载...';
          document.getElementById('previewQuestions').innerHTML = '';
          document.getElementById('previewOverlay').style.display = 'flex';
          try{
            const res = await fetch(qb.url);
            let data = await res.json();
            if(!Array.isArray(data)) data = data.questions||data.data||[];
            // 统计
            const total = data.length;
            const cats = Array.from(new Set(data.map(q=>q.category||'未知')));
            const levels = Array.from(new Set(data.map(q=>q.level||'未知')));
            document.getElementById('previewStats').innerHTML = `共${total}题，分类：${cats.join('，')}，难度：${levels.join('，')}`;
            // 题目预览
            let html = data.slice(0,Math.max(5,Math.ceil(total/20))).map((q,i)=>
              `<div style='margin-bottom:10px;'><b>Q${i+1}.</b> <span>${q.title||q.question||JSON.stringify(q).slice(0,60)}</span></div>`
            ).join('');
            if(total>html.length) html += `<div style='color:#aaa;'>...（仅预览部分题目）</div>`;
            document.getElementById('previewQuestions').innerHTML = html;
          }catch(e){
            document.getElementById('previewStats').innerHTML = '❌ 加载失败';
          }
        }
let lastSearchData = [];
function parseKeywords(kw) {
  if (!kw) return [];
  return kw.split(/[\s,，]+/).map(s=>s.trim()).filter(Boolean);
}
function highlightText(text, kw) {
  if (!kw) return text;
  const kws = parseKeywords(kw);
  if (!kws.length) return text;
  try {
    const re = new RegExp('(' + kws.map(k=>k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|') + ')', 'gi');
    return text.replace(re, '<span class="highlight">$1</span>');
  } catch { return text; }
}
// 搜索支持多关键词和模糊
async function searchQuestions(){
  const kw = document.getElementById('searchInput').value.trim();
  const cat = document.getElementById('searchCat').value;
  const level = document.getElementById('searchLevel').value;
  const sel = document.getElementById('qbSelect');
  const qb = qbList.find(q=>q.name===sel.value);
  if(!qb){ document.getElementById('searchStatus').textContent='❌ 未选择题库'; return; }
  document.getElementById('searchStatus').innerHTML = '<span class="loading-spinner"></span> 正在搜索...';
  document.getElementById('searchResult').style.display = 'none';
  try{
    const res = await fetch(qb.url);
    let data = await res.json();
    if(!Array.isArray(data)) data = data.questions||data.data||[];
    // 分类选项自动聚合
    const catSet = new Set();
    data.forEach(q=>catSet.add(q.category||'未知'));
    document.getElementById('searchCat').innerHTML = '<option value="">全部分类</option>' + Array.from(catSet).map(c=>`<option value="${c}">${c}</option>`).join('');
    // 多关键词模糊搜索
    const kws = parseKeywords(kw);
    let filtered = data.filter(q=>{
      let ok = true;
      if(kws.length && !kws.some(k=>{
        const reg = new RegExp(k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
        return reg.test(q.title||q.question||'') || reg.test(q.explanation||'');
      })) ok = false;
      if(cat && (q.category||'未知')!==cat) ok = false;
      if(level && (q.level||'')!==level) ok = false;
      return ok;
    });
    lastSearchData = filtered;
    // 渲染结果（多关键词高亮）
    let html = filtered.length?filtered.slice(0,30).map((q,i)=>
      `<div style='margin-bottom:10px;'><b>Q${i+1}.</b> <span>${highlightText(q.title||q.question||JSON.stringify(q).slice(0,60), kw)}</span> <button class='modal-btn' style='margin-left:8px;padding:2px 10px;font-size:0.95em;' onclick='jumpToQuestion(${data.findIndex(x=>x.id===q.id)})'><i class="fas fa-arrow-right"></i> 跳转</button></div>`
    ).join(''):`<div style='color:#aaa;'>未找到相关题目</div>`;
    if(filtered.length>30) html += `<div style='color:#aaa;'>...仅显示前30条</div>`;
    document.getElementById('searchResult').innerHTML = html;
    document.getElementById('searchResult').style.display = 'block';
    document.getElementById('searchStatus').textContent = `共${filtered.length}题`;
  }catch(e){
    document.getElementById('searchStatus').textContent = '❌ 搜索失败';
  }
}
function jumpToQuestion(idx){
  if(typeof idx!=='number'||idx<0) return;
  current = idx; // 更新当前题目索引
  selected = null;
  answered = false;
  renderQuestion();
  window.scrollTo({top:0,behavior:'smooth'});
  document.getElementById('searchResult').style.display = 'none';
}
function highlightText(text, kw) {
  if (!kw) return text;
  try {
    const re = new RegExp('('+kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')+')', 'gi');
    return text.replace(re, '<span class="highlight">$1</span>');
  } catch { return text; }
}
// 做题界面多关键词高亮
function showFullscreenQuestion() {
  // ...原有代码...
  const kw = document.getElementById('searchInput')?.value.trim();
  lastHighlightKw = kw;
  const q = questions[current];
  let title = q.title||q.question||'';
  if(kw) title = highlightText(title, kw);
  document.getElementById('questionTitle').innerHTML = title;
  if(q.options && Array.isArray(q.options)) {
    q.options.forEach((opt, i) => {
      let optText = opt;
      if(kw) optText = highlightText(optText, kw);
      document.getElementById('questionOptions').innerHTML = opts;
    });
  }
  if(q.explanation && document.getElementById('explanationSection')) {
    let exp = q.explanation;
    if(kw) exp = highlightText(exp, kw);
    document.getElementById('explanationSection').innerHTML = exp;
  }
  // ...原有代码...
}
// 新增随机做题功能
function randomPractice() {
  const qb = qbList.find(q => q.name === document.getElementById('qbSelect').value);
  if (qb && qb.url) {
    fetch(qb.url).then(r=>r.json()).then(data => {
      if (!Array.isArray(data)) data = data.questions||data.data||[];
      const year = document.getElementById('yearSelect')?.value;
      if (year) data = data.filter(q=>q.year==year);
      // 随机顺序
      for (let i = data.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [data[i], data[j]] = [data[j], data[i]];
      }
      questions = data; current = 0; selected = null; answered = false;
      localStorage.setItem('fullscreen_questions', JSON.stringify(questions));
      renderQuestion();
    });
  }
}
        // ====== 做题核心逻辑 ======
(function() {
  // ... 保留前面代码 ...
  // 快捷键支持
  document.addEventListener('keydown', function(e) {
    if (!questions || !questions.length) return;
    // 方向键切换题目
    if (e.key === 'ArrowLeft') {
      e.preventDefault();
      if (typeof prevQuestion === 'function') prevQuestion();
    } else if (e.key === 'ArrowRight') {
      e.preventDefault();
      if (typeof nextQuestion === 'function') nextQuestion();
    }
    // 数字键/字母键选择选项（A=0, B=1...）
    const opts = questions[current]?.options || [];
    if (opts.length) {
      // 数字键1-9
      if (/^[1-9]$/.test(e.key)) {
        const idx = parseInt(e.key, 10) - 1;
        if (idx < opts.length && typeof selectOption === 'function') selectOption(idx);
      }
      // 字母键A-D...
      if (/^[a-zA-Z]$/.test(e.key)) {
        const idx = e.key.toUpperCase().charCodeAt(0) - 65;
        if (idx >= 0 && idx < opts.length && typeof selectOption === 'function') selectOption(idx);
      }
    }
    // 空格键显示解析
    if (e.key === ' ' || e.key === 'Spacebar') {
      e.preventDefault();
      if (typeof toggleExplanation === 'function') toggleExplanation(true);
    }
  });
})();

                 
    </script>
</body>
</html> 