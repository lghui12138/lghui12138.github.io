<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>全屏做题 - 流体力学学习平台</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script>
    <style>
        html, body {
            height: 100%; margin: 0; padding: 0;
            background: linear-gradient(135deg, #006994 0%, #4facfe 100%);
            color: #222; font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }
        body.night {
            background: #181c25;
            color: #e0e0e0;
        }
        .fullscreen-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; width: 100vw; padding: 0; box-sizing: border-box; }
        .fullscreen-question-card { background: #fff; border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.18); max-width: 600px; width: 96vw; margin: 0 auto; padding: 32px 20px 24px 20px; display: flex; flex-direction: column; align-items: stretch; transition: background 0.3s, color 0.3s; }
        body.night .fullscreen-question-card { background: #23273a; color: #e0e0e0; }
        .question-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 18px; color: #006994; }
        body.night .question-title { color: #4facfe; }
        .question-options { display: flex; flex-direction: column; gap: 14px; margin-bottom: 24px; }
        .option-btn { background: #f4f8fb; border: 2px solid #4facfe; border-radius: 12px; padding: 14px 18px; font-size: 1rem; color: #222; cursor: pointer; transition: background 0.2s, border 0.2s; text-align: left; }
        .option-btn.selected { background: #4facfe; color: #fff; border-color: #006994; }
        .option-btn.correct { background: #27ae60; color: #fff; border-color: #27ae60; }
        .option-btn.incorrect { background: #e74c3c; color: #fff; border-color: #e74c3c; }
        body.night .option-btn { background: #23273a; color: #e0e0e0; border-color: #4facfe; }
        .fullscreen-controls { display: flex; justify-content: center; align-items: center; gap: 24px; margin-bottom: 18px; }
        .control-btn { background: #006994; color: #fff; border: none; border-radius: 50px; padding: 12px 28px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 8px; }
        .control-btn:active { background: #4facfe; }
        .explanation-section { background: #f4f8fb; border-radius: 12px; padding: 18px 14px; margin-top: 10px; color: #006994; font-size: 1rem; display: none; }
        .explanation-section.active { display: block; }
        body.night .explanation-section { background: #23273a; color: #4facfe; }
        .fullscreen-progress { text-align: center; margin-bottom: 10px; color: #006994; font-size: 1rem; }
        body.night .fullscreen-progress { color: #4facfe; }
        .fullscreen-header { width: 100vw; display: flex; justify-content: flex-end; align-items: center; padding: 12px 18px 0 0; }
        .close-btn { background: none; border: none; color: #006994; font-size: 2rem; cursor: pointer; }
        body.night .close-btn { color: #4facfe; }
        .night-btn { background: #23273a; color: #fff; border: none; border-radius: 8px; padding: 6px 16px; font-size: 1rem; margin-right: 12px; cursor: pointer; }
        .night-btn:active { background: #4facfe; color: #fff; }
        .stat-bar { display: flex; justify-content: center; align-items: center; gap: 18px; margin-bottom: 10px; font-size: 1rem; color: #006994; }
        body.night .stat-bar { color: #4facfe; }
        .stat-item { display: flex; align-items: center; gap: 6px; }
        .fav-btn { background: none; border: none; color: #e67e22; font-size: 1.5rem; cursor: pointer; margin-left: 8px; }
        .fav-btn.faved { color: #e74c3c; }
        @media (max-width: 600px) { .fullscreen-question-card { padding: 18px 4vw 12px 4vw; max-width: 98vw; } .control-btn { padding: 10px 10vw; font-size: 1rem; } }
        .question-title img, .option-btn img, .explanation-section img { max-width: 100%; height: auto; vertical-align: middle; }
    </style>
</head>
<body>
    <div class="fullscreen-header">
        <button class="night-btn" onclick="toggleNightMode()" title="夜间模式"><i class="fas fa-moon"></i></button>
        <button class="close-btn" onclick="window.location.href='index-modular.html'" title="退出全屏"><i class="fas fa-times"></i></button>
    </div>
    <div class="stat-bar" id="statBar"></div>
    <div class="questionbank-bar">
        <select id="qbSelect" class="qb-select"></select>
        <label class="qb-upload">
            <i class="fas fa-upload"></i> 本地题库
            <input type="file" id="qbUploadInput" accept=".json,.csv" style="display:none;">
        </label>
        <button class="wrongbook-btn" onclick="loadWrongBook()"><i class="fas fa-book"></i> 错题本</button>
        <button class="wrongbook-btn" onclick="exportWrongBook()" title="导出错题本"><i class="fas fa-download"></i> 导出错题</button>
        <button class="wrongbook-btn" onclick="exportFavBook()" title="导出收藏本"><i class="fas fa-star"></i> 导出收藏</button>
        <button class="wrongbook-btn" id="qbManageBtn" style="display:none; background:#006994;" onclick="showQbManagePanel()"><i class="fas fa-cog"></i> 题库管理</button>
        <button class="wrongbook-btn" id="showAllQbBtn" style="display:none; background:#888;" onclick="toggleShowAllQb()"><i class="fas fa-eye"></i> 显示全部</button>
    </div>
    <div id="qbManagePanel" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#fff; color:#222; border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,0.18); padding:32px 24px; z-index:9999; max-width:90vw;">
        <h3 style="margin-bottom:18px;">题库管理</h3>
        <div style="margin-bottom:12px;">当前题库：<span id="manageQbName"></span></div>
        <div style="margin-bottom:18px;">
            <input id="renameQbInput" class="qb-select" style="width:70%;" placeholder="新题库名（不含扩展名）">
            <button class="wrongbook-btn" style="background:#27ae60; margin-left:8px;" onclick="renameQb()"><i class="fas fa-edit"></i> 重命名</button>
        </div>
        <button class="wrongbook-btn" style="background:#e74c3c;" onclick="deleteQb()"><i class="fas fa-trash"></i> 删除题库</button>
        <button class="wrongbook-btn" style="background:#f39c12; margin-left:12px;" onclick="toggleQbHidden()" id="hideQbBtn"><i class="fas fa-eye-slash"></i> 下架/恢复</button>
        <button class="wrongbook-btn" style="background:#888; margin-left:12px;" onclick="closeQbManagePanel()">取消</button>
        <div id="qbManageStatus" style="margin-top:16px; color:#006994;"></div>
    </div>
    <div class="fullscreen-container">
        <div class="fullscreen-progress" id="fullscreenProgress"></div>
        <div class="fullscreen-question-card">
            <div class="question-title" id="questionTitle">题目加载中...</div>
            <div class="question-options" id="questionOptions"></div>
            <div class="fullscreen-controls">
                <button class="control-btn" id="prevBtn" onclick="prevQuestion()"><i class="fas fa-chevron-left"></i> 上一题</button>
                <button class="control-btn" id="explainBtn" onclick="toggleExplanation()"><i class="fas fa-lightbulb"></i> 查看解析</button>
                <button class="control-btn" id="nextBtn" onclick="nextQuestion()">下一题 <i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="explanation-section" id="explanationSection"></div>
        </div>
    </div>
    <script>
        // ====== 题库选择与错题本功能 ======
        let questions = [];
        let current = 0;
        let selected = null;
        let answered = false;
        let wrongBook = [];
        let favBook = JSON.parse(localStorage.getItem('fullscreen_favbook')||'[]');
        let qbList = [
            {name: '默认题库', value: 'default', url: 'question-banks/default.json'},
        ];
        const GITHUB_REPO = 'lghui12138/lghui12138.github.io';
        const GITHUB_QB_DIR = 'question-banks';
        const GITHUB_TOKEN_KEY = 'github_token';
        let showAllQb = false;
        function getGithubToken() { return localStorage.getItem(GITHUB_TOKEN_KEY) || ''; }
        async function fetchGithubQuestionBanks() {
            const url = `https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_QB_DIR}`;
            const urlHidden = `https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_QB_DIR}/hidden`;
            const token = getGithubToken();
            const headers = token ? { 'Authorization': `token ${token}` } : {};
            let files = [];
            try {
                const res = await fetch(url, {headers});
                if (res.ok) files = await res.json();
            } catch {}
            if (showAllQb) {
                try {
                    const res2 = await fetch(urlHidden, {headers});
                    if (res2.ok) {
                        const hidden = await res2.json();
                        files = files.concat(hidden.map(f=>({...f, hidden:true})));
                    }
                } catch {}
            }
            qbList = files.filter(f => /\.(json|csv)$/i.test(f.name)).map(f => ({
                name: f.name,
                value: f.name.replace(/\.[^.]+$/, ''),
                url: f.download_url,
                hidden: !!f.hidden || f.path.includes('/hidden/')
            }));
            if (!showAllQb) qbList = qbList.filter(qb=>!qb.hidden);
            if (!qbList.length) qbList = [{name: '默认题库', value: 'default', url: 'question-banks/default.json'}];
        }
        async function renderQBSelect() {
            await fetchGithubQuestionBanks();
            const sel = document.getElementById('qbSelect');
            sel.innerHTML = qbList.map(qb => `<option value="${qb.value}">${qb.name}${qb.hidden?'（下架）':''}</option>`).join('');
            const preset = localStorage.getItem('fullscreen_qb_value');
            if (preset) sel.value = preset;
        }
        function loadQuestionsByValue(val) {
            const qb = qbList.find(q => q.value === val);
            if (qb && qb.url) {
                fetch(qb.url).then(r=>r.json()).then(data => {
                    questions = data; current = 0; selected = null; answered = false;
                    localStorage.setItem('fullscreen_questions', JSON.stringify(questions));
                    renderQuestion();
                });
            }
        }
        function loadWrongBook() {
            const wrong = JSON.parse(localStorage.getItem('fullscreen_wrongbook')||'[]');
            if (!wrong.length) { alert('暂无错题'); return; }
            questions = wrong; current = 0; selected = null; answered = false;
            renderQuestion();
        }
        function addToWrongBook(q, sel) {
            let wrong = JSON.parse(localStorage.getItem('fullscreen_wrongbook')||'[]');
            if (!wrong.some(item => item.title === q.title)) {
                wrong.push({...q, userSelected: sel});
                localStorage.setItem('fullscreen_wrongbook', JSON.stringify(wrong));
            }
        }
        function addToFavBook(q) {
            let fav = JSON.parse(localStorage.getItem('fullscreen_favbook')||'[]');
            if (!fav.some(item => item.title === q.title)) {
                fav.push({...q});
                localStorage.setItem('fullscreen_favbook', JSON.stringify(fav));
                favBook = fav;
                renderQuestion();
            }
        }
        function removeFromFavBook(q) {
            let fav = JSON.parse(localStorage.getItem('fullscreen_favbook')||'[]');
            fav = fav.filter(item => item.title !== q.title);
            localStorage.setItem('fullscreen_favbook', JSON.stringify(fav));
            favBook = fav;
            renderQuestion();
        }
        function isFaved(q) {
            return favBook.some(item => item.title === q.title);
        }
        // ====== 做题核心逻辑 ======
        function renderQuestion() {
            if (!questions.length) return;
            const q = questions[current];
            // 题目支持图片/公式/富文本
            document.getElementById('questionTitle').innerHTML = q.title;
            const opts = q.options.map((opt, i) => {
                let cls = 'option-btn';
                if (answered) {
                    if (i === q.answer) cls += ' correct';
                    else if (selected === i) cls += ' incorrect';
                } else if (selected === i) {
                    cls += ' selected';
                }
                // 选项支持图片/富文本
                return `<button class="${cls}" onclick="selectOption(${i})">${String.fromCharCode(65+i)}. ${opt}</button>`;
            }).join('');
            document.getElementById('questionOptions').innerHTML = opts;
            document.getElementById('fullscreenProgress').textContent = `第 ${current+1} / ${questions.length} 题`;
            // 收藏按钮
            const favBtn = `<button class="fav-btn${isFaved(q)?' faved':''}" onclick="toggleFav()" title="收藏"><i class="fas fa-heart"></i></button>`;
            document.getElementById('questionTitle').insertAdjacentHTML('beforeend', favBtn);
            document.getElementById('explanationSection').classList.remove('active');
            document.getElementById('explanationSection').innerHTML = '';
            document.getElementById('explainBtn').disabled = !answered;
            renderStatBar();
            if (window.MathJax) MathJax.typesetPromise();
        }
        function selectOption(i) {
            if (answered) return;
            selected = i;
            answered = true;
            renderQuestion();
            setTimeout(() => toggleExplanation(true), 300);
            const q = questions[current];
            if (i !== q.answer) addToWrongBook(q, i);
            saveProgress();
        }
        function prevQuestion() { if (current > 0) { current--; selected = null; answered = false; renderQuestion(); saveProgress(); } }
        function nextQuestion() { if (current < questions.length-1) { current++; selected = null; answered = false; renderQuestion(); saveProgress(); } }
        function toggleExplanation(forceShow) {
            const q = questions[current];
            const section = document.getElementById('explanationSection');
            if (!answered) return;
            if (forceShow || !section.classList.contains('active')) {
                section.innerHTML = `<b>答案：</b> ${String.fromCharCode(65+q.answer)}<br><b>解析：</b> ${q.explanation || '暂无解析'}`;
                section.classList.add('active');
                if (window.MathJax) MathJax.typesetPromise([section]);
            } else {
                section.classList.remove('active');
                section.innerHTML = '';
            }
        }
        function toggleFav() {
            const q = questions[current];
            if (isFaved(q)) removeFromFavBook(q); else addToFavBook(q);
        }
        function saveProgress() {
            localStorage.setItem('fullscreen_questions', JSON.stringify(questions));
            localStorage.setItem('fullscreen_progress', JSON.stringify({current, selected, answered}));
        }
        function loadProgress() {
            const p = JSON.parse(localStorage.getItem('fullscreen_progress') || '{}');
            if (typeof p.current === 'number') current = p.current;
            if (typeof p.selected === 'number') selected = p.selected;
            if (typeof p.answered === 'boolean') answered = p.answered;
        }
        function renderStatBar() {
            // 答题统计
            const total = questions.length;
            const done = questions.filter((q, i) => i < current && typeof q.userSelected === 'number').length + (answered?1:0);
            const correct = questions.filter((q, i) => typeof q.userSelected === 'number' && q.userSelected === q.answer).length;
            const wrong = questions.filter((q, i) => typeof q.userSelected === 'number' && q.userSelected !== q.answer).length;
            document.getElementById('statBar').innerHTML = `
                <span class="stat-item"><i class="fas fa-list-ol"></i> 总题数: ${total}</span>
                <span class="stat-item"><i class="fas fa-check-circle"></i> 正确: ${correct}</span>
                <span class="stat-item"><i class="fas fa-times-circle"></i> 错误: ${wrong}</span>
                <span class="stat-item"><i class="fas fa-tasks"></i> 已做: ${done}</span>
            `;
        }
        function toggleNightMode() {
            document.body.classList.toggle('night');
        }
        function exportWrongBook() {
            const wrong = JSON.parse(localStorage.getItem('fullscreen_wrongbook')||'[]');
            if (!wrong.length) { alert('暂无错题'); return; }
            const blob = new Blob([JSON.stringify(wrong, null, 2)], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `错题本_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        function exportFavBook() {
            const fav = JSON.parse(localStorage.getItem('fullscreen_favbook')||'[]');
            if (!fav.length) { alert('暂无收藏'); return; }
            const blob = new Blob([JSON.stringify(fav, null, 2)], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `收藏本_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        function showQbManagePanel() {
            const sel = document.getElementById('qbSelect');
            const idx = sel.selectedIndex;
            if (idx < 0) { alert('请先选择一个题库'); return; }
            const qb = qbList[idx];
            document.getElementById('manageQbName').textContent = qb.name;
            document.getElementById('renameQbInput').value = qb.name.replace(/\.[^.]+$/, '');
            document.getElementById('qbManagePanel').style.display = 'block';
        }
        function closeQbManagePanel() {
            document.getElementById('qbManagePanel').style.display = 'none';
            document.getElementById('renameQbInput').value = '';
            document.getElementById('qbManageStatus').textContent = '';
        }
        async function renameQb() {
            const newName = document.getElementById('renameQbInput').value;
            if (!newName) { alert('请输入新题库名'); return; }
            const sel = document.getElementById('qbSelect');
            const idx = sel.selectedIndex;
            if (idx < 0) return;
            const file = sel.options[idx].textContent.replace('（下架）','');
            const isHidden = /（下架）/.test(sel.options[idx].textContent);
            const token = localStorage.getItem('github_token');
            if (!token) { alert('请先设置GitHub Token'); return; }
            const url = `https://api.github.com/repos/lghui12138/lghui12138.github.io/contents/question-banks/${isHidden?'hidden/':''}${file}`;
            // 获取sha
            const res = await fetch(url, {headers:{'Authorization':`token ${token}`}});
            if (!res.ok) { document.getElementById('qbManageStatus').textContent = '获取文件信息失败'; return; }
            const info = await res.json();
            // 新路径
            const newPath = isHidden ? `question-banks/hidden/${newName}` : `question-banks/${newName}`;
            // 移动
            const mvRes = await fetch(url, {
                method:'PUT',
                headers:{'Authorization':`token ${token}`,'Content-Type':'application/json'},
                body:JSON.stringify({message:`重命名题库:${file}`,content:info.content,sha:info.sha,branch:'main',path:newPath})
            });
            if (mvRes.ok) {
                document.getElementById('qbManageStatus').textContent = '✅ 重命名成功';
                await renderQBSelect();
                closeQbManagePanel();
            } else {
                document.getElementById('qbManageStatus').textContent = '❌ 重命名失败';
            }
        }
        async function deleteQb() {
            const sel = document.getElementById('qbSelect');
            const idx = sel.selectedIndex;
            if (idx < 0) return;
            const file = sel.options[idx].textContent.replace('（下架）','');
            const isHidden = /（下架）/.test(sel.options[idx].textContent);
            const token = localStorage.getItem('github_token');
            if (!token) { alert('请先设置GitHub Token'); return; }
            const url = `https://api.github.com/repos/lghui12138/lghui12138.github.io/contents/question-banks/${isHidden?'hidden/':''}${file}`;
            // 获取sha
            const res = await fetch(url, {headers:{'Authorization':`token ${token}`}});
            if (!res.ok) { document.getElementById('qbManageStatus').textContent = '获取文件信息失败'; return; }
            const info = await res.json();
            // 删除
            const delRes = await fetch(url, {
                method:'DELETE',
                headers:{'Authorization':`token ${token}`}
            });
            if (delRes.ok) {
                document.getElementById('qbManageStatus').textContent = '✅ 删除成功';
                await renderQBSelect();
                closeQbManagePanel();
            } else {
                document.getElementById('qbManageStatus').textContent = '❌ 删除失败';
            }
        }
        async function toggleQbHidden() {
            const sel = document.getElementById('qbSelect');
            const idx = sel.selectedIndex;
            if (idx < 0) return;
            const file = sel.options[idx].textContent.replace('（下架）','');
            const isHidden = /（下架）/.test(sel.options[idx].textContent);
            const token = localStorage.getItem('github_token');
            if (!token) { alert('请先设置GitHub Token'); return; }
            const url = `https://api.github.com/repos/lghui12138/lghui12138.github.io/contents/question-banks/${isHidden?'hidden/':''}${file}`;
            // 获取sha
            const res = await fetch(url, {headers:{'Authorization':`token ${token}`}});
            if (!res.ok) { document.getElementById('qbManageStatus').textContent = '获取文件信息失败'; return; }
            const info = await res.json();
            // 新路径
            const newPath = isHidden ? `question-banks/${file}` : `question-banks/hidden/${file}`;
            // 移动
            const mvRes = await fetch(url, {
                method:'PUT',
                headers:{'Authorization':`token ${token}`,'Content-Type':'application/json'},
                body:JSON.stringify({message:`${isHidden?'恢复上架':'下架'}题库:${file}`,content:info.content,sha:info.sha,branch:'main',path:newPath})
            });
            if (mvRes.ok) {
                document.getElementById('qbManageStatus').textContent = isHidden?'✅ 恢复上架成功':'✅ 下架成功';
                await renderQBSelect();
                closeQbManagePanel();
            } else {
                document.getElementById('qbManageStatus').textContent = '❌ 操作失败';
            }
        }
        function toggleShowAllQb() {
            showAllQb = !showAllQb;
            document.getElementById('showAllQbBtn').textContent = showAllQb ? '仅显示上架' : '显示全部';
            renderQBSelect();
        }
        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') prevQuestion();
            if (e.key === 'ArrowRight') nextQuestion();
            if (e.key === 'Enter') { if (!answered) selectOption(selected??0); else nextQuestion(); }
            if (e.key >= '1' && e.key <= '4') selectOption(Number(e.key)-1);
            if (e.key === 'e' || e.key === 'E') toggleExplanation();
            if (e.key === 'f' || e.key === 'F') toggleFav();
            if (e.key === 'Escape') window.location.href = 'index-modular.html';
        });
        // 页面初始化
        document.addEventListener('DOMContentLoaded', async function() {
            await renderQBSelect();
            loadProgress();
            await loadQuestions();
            if (isTeacher()) {
                document.getElementById('qbManageBtn').style.display = 'inline-block';
                document.getElementById('showAllQbBtn').style.display = 'inline-block';
            }
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(()=>{});
            }
        });
    </script>
</body>
</html> 